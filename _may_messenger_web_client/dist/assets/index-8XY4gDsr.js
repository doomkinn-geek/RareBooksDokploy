var _e=Object.defineProperty;var Fe=(s,e,a)=>e in s?_e(s,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[e]=a;var y=(s,e,a)=>Fe(s,typeof e!="symbol"?e+"":e,a);import{r as h,a as Ge,u as Z,B as $e,b as qe,c as V,N as Q,R as ze}from"./react-vendor-BGgwey9t.js";import{c as xe}from"./state-DjusEJJN.js";import{a as He}from"./http-B9ygI19o.js";import{H as Ee,a as Ve,b as Qe,L as We}from"./signalr-D2bCTV3v.js";import{L as Ye,U as Xe,a as ae,S as Je,M as he,b as fe,P as Ke,c as Ze,R as et,A as tt,V as st,C as ke,d as De,e as at,X as H,f as Re,I as nt,g as rt,W as it,h as ot,i as se,j as ct,Q as lt,k as Le,l as dt,m as gt,n as ut,o as ne,G as ht,p as mt}from"./ui-vendor-BOfDZgWp.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function a(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(r){if(r.ep)return;r.ep=!0;const i=a(r);fetch(r.href,i)}})();var Oe={exports:{}},pe={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var xt=h,ft=Symbol.for("react.element"),pt=Symbol.for("react.fragment"),yt=Object.prototype.hasOwnProperty,wt=xt.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,bt={key:!0,ref:!0,__self:!0,__source:!0};function Be(s,e,a){var n,r={},i=null,o=null;a!==void 0&&(i=""+a),e.key!==void 0&&(i=""+e.key),e.ref!==void 0&&(o=e.ref);for(n in e)yt.call(e,n)&&!bt.hasOwnProperty(n)&&(r[n]=e[n]);if(s&&s.defaultProps)for(n in e=s.defaultProps,e)r[n]===void 0&&(r[n]=e[n]);return{$$typeof:ft,type:s,key:i,ref:o,props:r,_owner:wt.current}}pe.Fragment=pt;pe.jsx=Be;pe.jsxs=Be;Oe.exports=pe;var t=Oe.exports,Se={},Te=Ge;Se.createRoot=Te.createRoot,Se.hydrateRoot=Te.hydrateRoot;const ye="https://messenger.rare-books.ru",vt=`${ye}/api`,St=ye,jt=`${ye}/hubs/chat`,R={LOGIN:"/auth/login",REGISTER:"/auth/register",USER_PROFILE:"/users/me",USERS:"/users",CREATE_INVITE:"/users/invite-link",MY_INVITES:"/users/my-invite-links",VALIDATE_INVITE:"/users/validate-invite",CHATS:"/chats",CHAT_BY_ID:s=>`/chats/${s}`,CREATE_OR_GET_CHAT:"/chats/create-or-get",MESSAGES:"/messages",MESSAGES_BY_CHAT:s=>`/messages/${s}`,SEND_AUDIO:"/messages/audio",SEND_IMAGE:"/messages/image"};class Nt{constructor(){y(this,"client");this.client=He.create({baseURL:vt,timeout:3e4,headers:{"Content-Type":"application/json"},withCredentials:!0}),this.client.interceptors.request.use(e=>{const a=localStorage.getItem("auth_token");return a&&(e.headers.Authorization=`Bearer ${a}`),e},e=>Promise.reject(e)),this.client.interceptors.response.use(e=>e,e=>{var a;return((a=e.response)==null?void 0:a.status)===401&&(localStorage.removeItem("auth_token"),localStorage.removeItem("user_profile"),window.location.href="/web/login"),Promise.reject(e)})}getInstance(){return this.client}}const E=new Nt().getInstance(),ce={async login(s){return(await E.post(R.LOGIN,s)).data},async register(s){return(await E.post(R.REGISTER,s)).data},async getUserProfile(){return(await E.get(R.USER_PROFILE)).data},async getAllUsers(){return(await E.get(R.USERS)).data},async createInviteLink(){return(await E.post(R.CREATE_INVITE)).data},async getMyInviteLinks(){return(await E.get(R.MY_INVITES)).data},async validateInviteCode(s){return(await E.post(R.VALIDATE_INVITE,{code:s})).data}};class Ct{constructor(){y(this,"connection",null);y(this,"messageCallbacks",[]);y(this,"messageStatusCallbacks",[]);y(this,"typingCallbacks",[]);y(this,"onlineStatusCallbacks",[])}async connect(e){var a;if(((a=this.connection)==null?void 0:a.state)===Ee.Connected){console.log("[SignalR] Already connected");return}this.connection=new Ve().withUrl(jt,{accessTokenFactory:()=>e,transport:Qe.WebSockets}).withAutomaticReconnect().configureLogging(We.Information).build(),this.connection.on("ReceiveMessage",n=>{console.log("[MSG_RECV] Message received via SignalR:",n.id,"for chat",n.chatId);const r=localStorage.getItem("userId");r&&n.senderId===r?console.log("[MSG_RECV] Skipping delivery confirmation for own message:",n.id):this.markMessageAsDelivered(n.id,n.chatId).then(()=>{console.log("[MSG_RECV] Delivery confirmation sent for message:",n.id)}).catch(o=>{console.error("[MSG_RECV] Failed to send delivery confirmation:",o),setTimeout(()=>{this.markMessageAsDelivered(n.id,n.chatId).then(()=>console.log("[MSG_RECV] Delivery confirmation sent (retry):",n.id)).catch(c=>console.error("[MSG_RECV] Delivery confirmation retry failed:",c))},2e3)}),this.messageCallbacks.forEach(o=>o(n))}),this.connection.on("MessageStatusUpdated",(n,r)=>{console.log("[SignalR] MessageStatusUpdated",n,r),this.messageStatusCallbacks.forEach(i=>i(n,r))}),this.connection.on("UserTyping",(n,r,i)=>{console.log("[SignalR] UserTyping",n,r,i),this.typingCallbacks.forEach(o=>o(n,r,i))}),this.connection.on("UserOnlineStatusChanged",(n,r,i)=>{console.log("[SignalR] UserOnlineStatusChanged",n,r,i),this.onlineStatusCallbacks.forEach(o=>o(n,r,i))}),this.connection.onreconnecting(n=>{console.log("[SignalR] Reconnecting...",n)}),this.connection.onreconnected(n=>{console.log("[SignalR] Reconnected",n)}),this.connection.onclose(n=>{console.log("[SignalR] Connection closed",n)});try{await this.connection.start(),console.log("[SignalR] Connected",this.connection.connectionId)}catch(n){throw console.error("[SignalR] Connection failed",n),n}}async disconnect(){this.connection&&(await this.connection.stop(),this.connection=null,console.log("[SignalR] Disconnected"))}async joinChat(e){if(!this.connection)throw new Error("SignalR connection not established");await this.connection.invoke("JoinChat",e),console.log("[SignalR] Joined chat",e)}async leaveChat(e){if(!this.connection)throw new Error("SignalR connection not established");await this.connection.invoke("LeaveChat",e),console.log("[SignalR] Left chat",e)}async markMessageAsDelivered(e,a){if(!this.connection)throw new Error("SignalR connection not established");await this.connection.invoke("MessageDelivered",e,a),console.log("[SignalR] Message marked as delivered:",e)}async markMessageAsRead(e,a){if(!this.connection)throw new Error("SignalR connection not established");await this.connection.invoke("MessageRead",e,a)}async sendTypingIndicator(e,a){if(!this.connection)throw new Error("SignalR connection not established");await this.connection.invoke("TypingIndicator",e,a)}onMessage(e){return this.messageCallbacks.push(e),()=>{this.messageCallbacks=this.messageCallbacks.filter(a=>a!==e)}}onMessageStatus(e){return this.messageStatusCallbacks.push(e),()=>{this.messageStatusCallbacks=this.messageStatusCallbacks.filter(a=>a!==e)}}onTyping(e){return this.typingCallbacks.push(e),()=>{this.typingCallbacks=this.typingCallbacks.filter(a=>a!==e)}}onOnlineStatus(e){return this.onlineStatusCallbacks.push(e),()=>{this.onlineStatusCallbacks=this.onlineStatusCallbacks.filter(a=>a!==e)}}get isConnected(){var e;return((e=this.connection)==null?void 0:e.state)===Ee.Connected}}const P=new Ct,B=xe((s,e)=>({user:null,token:localStorage.getItem("auth_token"),isLoading:!1,error:null,login:async a=>{var n,r;s({isLoading:!0,error:null});try{const i=await ce.login(a);localStorage.setItem("auth_token",i.token),localStorage.setItem("user_profile",JSON.stringify(i.user)),await P.connect(i.token),s({user:i.user,token:i.token,isLoading:!1})}catch(i){const o=((r=(n=i.response)==null?void 0:n.data)==null?void 0:r.message)||"–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞";throw s({error:o,isLoading:!1}),i}},register:async a=>{var n,r;s({isLoading:!0,error:null});try{const i=await ce.register(a);localStorage.setItem("auth_token",i.token),localStorage.setItem("user_profile",JSON.stringify(i.user)),await P.connect(i.token),s({user:i.user,token:i.token,isLoading:!1})}catch(i){const o=((r=(n=i.response)==null?void 0:n.data)==null?void 0:r.message)||"–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏";throw s({error:o,isLoading:!1}),i}},logout:async()=>{await P.disconnect(),localStorage.removeItem("auth_token"),localStorage.removeItem("user_profile"),s({user:null,token:null,error:null})},loadUserProfile:async()=>{const a=e().token;if(a){s({isLoading:!0});try{const n=await ce.getUserProfile();s({user:n,isLoading:!1}),P.isConnected||await P.connect(a)}catch{s({isLoading:!1,error:"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è"}),e().logout()}}},clearError:()=>s({error:null})}));var K=(s=>(s[s.Private=0]="Private",s[s.Group=1]="Group",s))(K||{}),L=(s=>(s[s.Text=0]="Text",s[s.Audio=1]="Audio",s[s.Image=2]="Image",s))(L||{}),k=(s=>(s[s.Sending=0]="Sending",s[s.Sent=1]="Sent",s[s.Delivered=2]="Delivered",s[s.Read=3]="Read",s[s.Played=4]="Played",s[s.Failed=5]="Failed",s))(k||{});const le={async getChats(){return(await E.get(R.CHATS)).data},async getChatById(s){return(await E.get(R.CHAT_BY_ID(s))).data},async createChat(s){return(await E.post(R.CHATS,s)).data},async createOrGetPrivateChat(s){return(await E.post(R.CREATE_OR_GET_CHAT,{targetUserId:s})).data}},It="MayMessengerDB",Mt=1,q="messages",A="outbox",z="chats";class Et{constructor(){y(this,"db",null);y(this,"initPromise",null)}async init(){if(!this.db)return this.initPromise?this.initPromise:(this.initPromise=new Promise((e,a)=>{const n=indexedDB.open(It,Mt);n.onerror=()=>{console.error("[IndexedDB] Failed to open database:",n.error),a(n.error)},n.onsuccess=()=>{this.db=n.result,console.log("[IndexedDB] Database opened successfully"),e()},n.onupgradeneeded=r=>{const i=r.target.result;if(i.objectStoreNames.contains(q)||(i.createObjectStore(q,{keyPath:"chatId"}).createIndex("chatId","chatId",{unique:!0}),console.log("[IndexedDB] Created messages store")),!i.objectStoreNames.contains(A)){const o=i.createObjectStore(A,{keyPath:"localId"});o.createIndex("chatId","chatId",{unique:!1}),o.createIndex("syncState","syncState",{unique:!1}),console.log("[IndexedDB] Created outbox store")}i.objectStoreNames.contains(z)||(i.createObjectStore(z,{keyPath:"id"}),console.log("[IndexedDB] Created chats store"))}}),this.initPromise)}async ensureDB(){if(this.db||await this.init(),!this.db)throw new Error("Database not initialized");return this.db}async cacheMessages(e,a){const i=(await this.ensureDB()).transaction([q],"readwrite").objectStore(q);await new Promise((o,c)=>{const l=i.put({chatId:e,messages:a,timestamp:new Date().toISOString()});l.onsuccess=()=>o(),l.onerror=()=>c(l.error)})}async getCachedMessages(e){const r=(await this.ensureDB()).transaction([q],"readonly").objectStore(q);return new Promise((i,o)=>{const c=r.get(e);c.onsuccess=()=>{const l=c.result;i(l?l.messages:null)},c.onerror=()=>o(c.error)})}async clearMessagesCache(){const n=(await this.ensureDB()).transaction([q],"readwrite").objectStore(q);await new Promise((r,i)=>{const o=n.clear();o.onsuccess=()=>r(),o.onerror=()=>i(o.error)})}async addPendingMessage(e){const r=(await this.ensureDB()).transaction([A],"readwrite").objectStore(A);await new Promise((i,o)=>{const c=r.add(e);c.onsuccess=()=>i(),c.onerror=()=>o(c.error)})}async updatePendingMessage(e){const r=(await this.ensureDB()).transaction([A],"readwrite").objectStore(A);await new Promise((i,o)=>{const c=r.put(e);c.onsuccess=()=>i(),c.onerror=()=>o(c.error)})}async getPendingMessage(e){const r=(await this.ensureDB()).transaction([A],"readonly").objectStore(A);return new Promise((i,o)=>{const c=r.get(e);c.onsuccess=()=>i(c.result||null),c.onerror=()=>o(c.error)})}async getPendingMessagesForChat(e){const i=(await this.ensureDB()).transaction([A],"readonly").objectStore(A).index("chatId");return new Promise((o,c)=>{const l=i.getAll(e);l.onsuccess=()=>{const d=l.result||[];d.sort((g,m)=>new Date(g.createdAt).getTime()-new Date(m.createdAt).getTime()),o(d)},l.onerror=()=>c(l.error)})}async getAllPendingMessages(){const n=(await this.ensureDB()).transaction([A],"readonly").objectStore(A);return new Promise((r,i)=>{const o=n.getAll();o.onsuccess=()=>{const c=o.result||[];c.sort((l,d)=>new Date(l.createdAt).getTime()-new Date(d.createdAt).getTime()),r(c)},o.onerror=()=>i(o.error)})}async removePendingMessage(e){const r=(await this.ensureDB()).transaction([A],"readwrite").objectStore(A);await new Promise((i,o)=>{const c=r.delete(e);c.onsuccess=()=>i(),c.onerror=()=>o(c.error)})}async clearOutbox(){const n=(await this.ensureDB()).transaction([A],"readwrite").objectStore(A);await new Promise((r,i)=>{const o=n.clear();o.onsuccess=()=>r(),o.onerror=()=>i(o.error)})}async cacheChats(e){const r=(await this.ensureDB()).transaction([z],"readwrite").objectStore(z);await new Promise((i,o)=>{const c=r.clear();c.onsuccess=()=>i(),c.onerror=()=>o(c.error)});for(const i of e)await new Promise((o,c)=>{const l=r.add(i);l.onsuccess=()=>o(),l.onerror=()=>c(l.error)})}async getCachedChats(){const n=(await this.ensureDB()).transaction([z],"readonly").objectStore(z);return new Promise((r,i)=>{const o=n.getAll();o.onsuccess=()=>{const c=o.result;r(c.length>0?c:null)},o.onerror=()=>i(o.error)})}async clearChatsCache(){const n=(await this.ensureDB()).transaction([z],"readwrite").objectStore(z);await new Promise((r,i)=>{const o=n.clear();o.onsuccess=()=>r(),o.onerror=()=>i(o.error)})}async clearAll(){await Promise.all([this.clearMessagesCache(),this.clearOutbox(),this.clearChatsCache()])}}const U=new Et,_=xe((s,e)=>({chats:[],selectedChatId:null,isLoading:!1,error:null,loadChats:async()=>{s({isLoading:!0,error:null});try{const a=await U.getCachedChats();a&&a.length>0&&(console.log("[ChatStore] Loaded cached chats:",a.length),a.sort((r,i)=>{var l,d;const o=((l=r.lastMessage)==null?void 0:l.createdAt)||r.createdAt,c=((d=i.lastMessage)==null?void 0:d.createdAt)||i.createdAt;return new Date(c).getTime()-new Date(o).getTime()}),s({chats:a,isLoading:!1}));const n=await le.getChats();console.log("[ChatStore] Loaded chats from API:",n.length),n.sort((r,i)=>{var l,d;const o=((l=r.lastMessage)==null?void 0:l.createdAt)||r.createdAt,c=((d=i.lastMessage)==null?void 0:d.createdAt)||i.createdAt;return new Date(c).getTime()-new Date(o).getTime()}),s({chats:n,isLoading:!1});try{await U.cacheChats(n)}catch(r){console.error("[ChatStore] Failed to cache chats:",r)}}catch(a){console.error("[ChatStore] Load error:",a),s({error:"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤",isLoading:!1})}},selectChat:a=>{s({selectedChatId:a})},createChat:async(a,n)=>{var r,i;s({error:null});try{const o=await le.createChat({title:a,participantIds:n});return s(c=>({chats:[o,...c.chats]})),o}catch(o){const c=((i=(r=o.response)==null?void 0:r.data)==null?void 0:i.message)||"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞";throw s({error:c}),o}},createOrGetPrivateChat:async a=>{var n,r;s({error:null});try{const i=await le.createOrGetPrivateChat(a);return e().chats.find(c=>c.id===i.id)||s(c=>({chats:[i,...c.chats]})),i}catch(i){const o=((r=(n=i.response)==null?void 0:n.data)==null?void 0:r.message)||"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞";throw s({error:o}),i}},updateChat:a=>{s(n=>({chats:n.chats.map(r=>r.id===a.id?a:r)}))},updateParticipantOnlineStatus:(a,n,r)=>{s(i=>({chats:i.chats.map(o=>o.type===K.Private&&o.otherParticipantId===a?{...o,otherParticipantIsOnline:n,otherParticipantLastSeenAt:r}:o)}))},clearError:()=>s({error:null}),get privateChats(){return e().chats.filter(a=>a.type===K.Private)},get groupChats(){return e().chats.filter(a=>a.type===K.Group)}}));P.onOnlineStatus((s,e,a)=>{_.getState().updateParticipantOnlineStatus(s,e,a)});const kt=()=>{const[s,e]=h.useState(""),[a,n]=h.useState(""),{login:r,isLoading:i,error:o,clearError:c}=B(),l=async d=>{d.preventDefault(),c();try{await r({phoneNumber:s,password:a})}catch{}};return t.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100",children:t.jsxs("div",{className:"bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md",children:[t.jsx("div",{className:"flex items-center justify-center mb-8",children:t.jsx("div",{className:"bg-indigo-600 p-3 rounded-full",children:t.jsx(Ye,{className:"w-8 h-8 text-white"})})}),t.jsx("h1",{className:"text-3xl font-bold text-center mb-2 text-gray-800",children:"–î–µ–ø–µ—à–∞ - –æ–±–º–µ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏"}),t.jsx("p",{className:"text-center text-gray-600 mb-8",children:"–í–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç"}),t.jsxs("form",{onSubmit:l,className:"space-y-6",children:[t.jsxs("div",{children:[t.jsx("label",{htmlFor:"phone",className:"block text-sm font-medium text-gray-700 mb-2",children:"–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"}),t.jsx("input",{id:"phone",type:"tel",value:s,onChange:d=>e(d.target.value),placeholder:"+7 (999) 123-45-67",className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition",required:!0,disabled:i})]}),t.jsxs("div",{children:[t.jsx("label",{htmlFor:"password",className:"block text-sm font-medium text-gray-700 mb-2",children:"–ü–∞—Ä–æ–ª—å"}),t.jsx("input",{id:"password",type:"password",value:a,onChange:d=>n(d.target.value),placeholder:"–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å",className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition",required:!0,disabled:i})]}),o&&t.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg",children:o}),t.jsx("button",{type:"submit",disabled:i,className:"w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-300 disabled:opacity-50 disabled:cursor-not-allowed transition",children:i?"–í—Ö–æ–¥...":"–í–æ–π—Ç–∏"})]}),t.jsx("div",{className:"mt-6 text-center",children:t.jsx("a",{href:"/register",className:"text-indigo-600 hover:text-indigo-700 font-medium",children:"–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å"})})]})})},Tt=()=>t.jsx(kt,{}),Pt=()=>{const[s,e]=h.useState(""),[a,n]=h.useState(""),[r,i]=h.useState(""),[o,c]=h.useState(""),[l,d]=h.useState(""),[g,m]=h.useState(""),{register:u,isLoading:x,error:C,clearError:w}=B(),N=async v=>{if(v.preventDefault(),w(),m(""),r!==o){m("–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç");return}if(r.length<6){m("–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤");return}try{await u({phoneNumber:s,displayName:a,password:r,inviteCode:l})}catch{}},f=g||C;return t.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100",children:t.jsxs("div",{className:"bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md",children:[t.jsx("div",{className:"flex items-center justify-center mb-8",children:t.jsx("div",{className:"bg-indigo-600 p-3 rounded-full",children:t.jsx(Xe,{className:"w-8 h-8 text-white"})})}),t.jsx("h1",{className:"text-3xl font-bold text-center mb-2 text-gray-800",children:"–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è"}),t.jsx("p",{className:"text-center text-gray-600 mb-8",children:"–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç"}),t.jsxs("form",{onSubmit:N,className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{htmlFor:"phone",className:"block text-sm font-medium text-gray-700 mb-2",children:"–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"}),t.jsx("input",{id:"phone",type:"tel",value:s,onChange:v=>e(v.target.value),placeholder:"+7 (999) 123-45-67",className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition",required:!0,disabled:x})]}),t.jsxs("div",{children:[t.jsx("label",{htmlFor:"displayName",className:"block text-sm font-medium text-gray-700 mb-2",children:"–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"}),t.jsx("input",{id:"displayName",type:"text",value:a,onChange:v=>n(v.target.value),placeholder:"–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è",className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition",required:!0,disabled:x})]}),t.jsxs("div",{children:[t.jsx("label",{htmlFor:"password",className:"block text-sm font-medium text-gray-700 mb-2",children:"–ü–∞—Ä–æ–ª—å"}),t.jsx("input",{id:"password",type:"password",value:r,onChange:v=>i(v.target.value),placeholder:"–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤",className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition",required:!0,disabled:x})]}),t.jsxs("div",{children:[t.jsx("label",{htmlFor:"confirmPassword",className:"block text-sm font-medium text-gray-700 mb-2",children:"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"}),t.jsx("input",{id:"confirmPassword",type:"password",value:o,onChange:v=>c(v.target.value),placeholder:"–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å",className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition",required:!0,disabled:x})]}),t.jsxs("div",{children:[t.jsx("label",{htmlFor:"inviteCode",className:"block text-sm font-medium text-gray-700 mb-2",children:"–ö–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è"}),t.jsx("input",{id:"inviteCode",type:"text",value:l,onChange:v=>d(v.target.value),placeholder:"–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è",className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition",required:!0,disabled:x})]}),f&&t.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg",children:f}),t.jsx("button",{type:"submit",disabled:x,className:"w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-300 disabled:opacity-50 disabled:cursor-not-allowed transition",children:x?"–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...":"–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è"})]}),t.jsx("div",{className:"mt-6 text-center",children:t.jsx("a",{href:"/login",className:"text-indigo-600 hover:text-indigo-700 font-medium",children:"–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π–¥–∏—Ç–µ"})})]})})},At=()=>t.jsx(Pt,{}),Dt=()=>{const s=Z(),{user:e}=B();return t.jsxs("header",{className:"bg-indigo-600 text-white px-6 py-4 flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"w-10 h-10 bg-white/20 rounded-full flex items-center justify-center",children:e!=null&&e.avatar?t.jsx("img",{src:e.avatar,alt:e.displayName,className:"w-full h-full rounded-full object-cover"}):t.jsx(ae,{className:"w-6 h-6"})}),t.jsxs("div",{children:[t.jsx("h1",{className:"font-semibold",children:(e==null?void 0:e.displayName)||"–î–µ–ø–µ—à–∞ - –æ–±–º–µ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏"}),t.jsx("p",{className:"text-sm text-white/70",children:(e==null?void 0:e.phoneNumber)||""})]})]}),t.jsx("button",{onClick:()=>s("/settings"),className:"p-2 rounded-lg hover:bg-white/10 transition",title:"–ù–∞—Å—Ç—Ä–æ–π–∫–∏",children:t.jsx(Je,{className:"w-5 h-5"})})]})},Rt=s=>{const e=new Date(s),n=new Date().getTime()-e.getTime(),r=Math.floor(n/(1e3*60*60*24));return r===0?e.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}):r===1?"–í—á–µ—Ä–∞":r<7?e.toLocaleDateString("ru-RU",{weekday:"short"}):e.toLocaleDateString("ru-RU",{day:"2-digit",month:"2-digit",year:"2-digit"})},Pe=s=>new Date(s).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}),Ue=s=>{const e=Math.floor(s/60),a=Math.floor(s%60);return`${e}:${a.toString().padStart(2,"0")}`},Lt=({chat:s,isSelected:e,onClick:a})=>{var o,c,l,d,g;const n=((o=s.lastMessage)==null?void 0:o.content)||(((c=s.lastMessage)==null?void 0:c.type)===1?"üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ":((l=s.lastMessage)==null?void 0:l.type)===2?"üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ":"–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π"),r=s.type===K.Group,i=s.type===K.Private&&s.otherParticipantIsOnline;return t.jsx("div",{onClick:a,className:`p-4 cursor-pointer border-b border-gray-200 hover:bg-gray-50 transition ${e?"bg-indigo-50 border-l-4 border-l-indigo-600":""}`,children:t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsxs("div",{className:"w-12 h-12 bg-indigo-600 rounded-full flex items-center justify-center text-white font-semibold flex-shrink-0 relative",children:[((g=(d=s.title)==null?void 0:d[0])==null?void 0:g.toUpperCase())||"?",r&&t.jsx("div",{className:"absolute -bottom-1 -right-1 w-5 h-5 bg-green-500 rounded-full flex items-center justify-center border-2 border-white",children:t.jsx(fe,{className:"w-3 h-3 text-white"})}),i&&t.jsx("span",{className:"absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"})]}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center justify-between mb-1",children:[t.jsx("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:t.jsx("h3",{className:"font-semibold text-gray-900 truncate",children:s.title||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"})}),s.lastMessage&&t.jsx("span",{className:"text-xs text-gray-500 flex-shrink-0 ml-2",children:Rt(s.lastMessage.createdAt)})]}),t.jsx("p",{className:"text-sm text-gray-600 truncate",children:n})]})]})})},Ot=({filterType:s="all"})=>{const{chats:e,selectedChatId:a,selectChat:n,loadChats:r,isLoading:i,privateChats:o,groupChats:c}=_();h.useEffect(()=>{r()},[]);const l=s==="private"?o:s==="group"?c:e;if(i&&l.length===0)return t.jsx("div",{className:"flex items-center justify-center h-full",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600",children:"–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤..."})]})});if(l.length===0){const d=s==="private"?"–ù–µ—Ç –ª–∏—á–Ω—ã—Ö —á–∞—Ç–æ–≤":s==="group"?"–ù–µ—Ç –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–æ–≤":"–ù–µ—Ç —á–∞—Ç–æ–≤";return t.jsx("div",{className:"flex items-center justify-center h-full",children:t.jsxs("div",{className:"text-center p-8",children:[t.jsx(he,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),t.jsx("h3",{className:"text-lg font-semibold text-gray-700 mb-2",children:d}),t.jsx("p",{className:"text-gray-500",children:"–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —á–∞—Ç –∏–ª–∏ –¥–æ–∂–¥–∏—Ç–µ—Å—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è"})]})})}return t.jsx("div",{className:"h-full overflow-y-auto",children:l.map(d=>t.jsx(Lt,{chat:d,isSelected:d.id===a,onClick:()=>n(d.id)},d.id))})},we={async getMessages(s,e=0,a=50){return(await E.get(R.MESSAGES_BY_CHAT(s),{params:{skip:e,take:a}})).data},async sendMessage(s){return(await E.post(R.MESSAGES,s)).data},async sendAudioMessage(s,e){const a=new FormData;return a.append("chatId",s),a.append("audioFile",e,`audio_${Date.now()}.webm`),(await E.post(R.SEND_AUDIO,a,{headers:{"Content-Type":"multipart/form-data"}})).data},async sendImageMessage(s,e){const a=new FormData;return a.append("chatId",s),a.append("imageFile",e),(await E.post(R.SEND_IMAGE,a,{headers:{"Content-Type":"multipart/form-data"}})).data},async batchMarkAsRead(s){await E.post("/api/messages/mark-read",s)},async getStatusUpdates(s,e){const a=e?{since:e.toISOString()}:{};return(await E.get(`/api/messages/${s}/status-updates`,{params:a})).data}};function me(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)})}class Bt{async addToOutbox(e,a,n,r){const i={localId:me(),chatId:e,type:a,content:n,localAudioPath:r,syncState:"localOnly",createdAt:new Date().toISOString(),retryCount:0};return await U.addPendingMessage(i),console.log("[OUTBOX] Added message to outbox:",i.localId),i}async getPendingMessagesForChat(e){return await U.getPendingMessagesForChat(e)}async getAllPendingMessages(){return await U.getAllPendingMessages()}async getPendingMessageById(e){return await U.getPendingMessage(e)}async updatePendingMessage(e){await U.updatePendingMessage(e),console.log("[OUTBOX] Updated message:",e.localId,"state:",e.syncState)}async markAsSyncing(e){const a=await this.getPendingMessageById(e);a&&(a.syncState="syncing",await this.updatePendingMessage(a))}async markAsSynced(e,a){const n=await this.getPendingMessageById(e);n&&(n.syncState="synced",n.serverId=a,await this.updatePendingMessage(n))}async markAsFailed(e,a){const n=await this.getPendingMessageById(e);n&&(n.syncState="failed",n.errorMessage=a,n.retryCount+=1,await this.updatePendingMessage(n))}async removePendingMessage(e){await U.removePendingMessage(e),console.log("[OUTBOX] Removed message from outbox:",e)}async getFailedMessages(){return(await this.getAllPendingMessages()).filter(a=>a.syncState==="failed")}async getSyncingMessages(){return(await this.getAllPendingMessages()).filter(a=>a.syncState==="syncing")}async retryMessage(e){const a=await this.getPendingMessageById(e);a&&a.syncState==="failed"&&(a.syncState="localOnly",a.errorMessage=void 0,await this.updatePendingMessage(a),console.log("[OUTBOX] Message marked for retry:",e))}async clearSyncedMessages(){const e=await this.getAllPendingMessages();for(const a of e)a.syncState==="synced"&&await this.removePendingMessage(a.localId)}toMessage(e,a,n){return{id:e.serverId||e.localId,chatId:e.chatId,senderId:a,senderName:n,type:e.type,content:e.content,filePath:e.localAudioPath,status:this.mapSyncStateToMessageStatus(e.syncState),createdAt:e.createdAt,localId:e.localId,isLocalOnly:e.syncState!=="synced"}}mapSyncStateToMessageStatus(e){switch(e){case"localOnly":case"syncing":return k.Sending;case"synced":return k.Sent;case"failed":return k.Failed;default:return k.Sending}}}const M=new Bt,D=xe(s=>({messagesByChatId:{},isSending:!1,isLoading:!1,error:null,loadMessages:async(e,a=!1)=>{s({isLoading:!0,error:null});const r=B.getState().user;if(!r){console.warn("[MessageStore] No current user"),s({isLoading:!1});return}try{if(!a){const g=await U.getCachedMessages(e),u=(await M.getPendingMessagesForChat(e)).map(x=>M.toMessage(x,r.id,r.displayName));if(g&&g.length>0){const x=new Map;g.forEach(w=>x.set(w.id,w)),u.forEach(w=>{x.has(w.id)||x.set(w.id,w)});const C=Array.from(x.values()).sort((w,N)=>new Date(w.createdAt).getTime()-new Date(N.createdAt).getTime());console.log(`[MessageStore] Loaded ${C.length} cached messages (${g.length} cached + ${u.length} local)`),s(w=>({messagesByChatId:{...w.messagesByChatId,[e]:C},isLoading:!1}))}}const i=await we.getMessages(e);console.log("[MessageStore] Loaded synced messages from API:",i.length);const c=(await M.getPendingMessagesForChat(e)).map(g=>M.toMessage(g,r.id,r.displayName)),l=new Map;i.forEach(g=>{l.set(g.id,g)}),c.forEach(g=>{l.has(g.id)||l.set(g.id,g)});const d=Array.from(l.values()).sort((g,m)=>new Date(g.createdAt).getTime()-new Date(m.createdAt).getTime());console.log(`[MSG_SEND] Loaded ${d.length} messages (${i.length} synced + ${c.length} local)`),s(g=>({messagesByChatId:{...g.messagesByChatId,[e]:d},isLoading:!1}));try{await U.cacheMessages(e,i)}catch(g){console.error("[MessageStore] Failed to cache messages:",g)}P.isConnected&&await P.joinChat(e)}catch(i){console.error("[MessageStore] Load error:",i),s({error:"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π",isLoading:!1})}},sendTextMessage:async(e,a)=>{var n,r;console.log("[MSG_SEND] Starting local-first send for text message"),s({isSending:!0,error:null});try{const o=B.getState().user;if(!o)throw new Error("User not authenticated");const c=me(),l=new Date().toISOString(),d={id:c,chatId:e,senderId:o.id,senderName:o.displayName,type:L.Text,content:a,status:k.Sending,createdAt:l,localId:c,isLocalOnly:!0};s(g=>{const m=g.messagesByChatId[e]||[];return{messagesByChatId:{...g.messagesByChatId,[e]:[...m,d].sort((u,x)=>new Date(u.createdAt).getTime()-new Date(x.createdAt).getTime())},isSending:!1}}),console.log("[MSG_SEND] Message added to UI with local ID:",c),await M.addToOutbox(e,L.Text,a),Ae(c,e,L.Text,a)}catch(i){console.error("[MSG_SEND] Failed to create local message:",i);const o=((r=(n=i.response)==null?void 0:n.data)==null?void 0:r.message)||"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è";throw s({error:o,isSending:!1}),i}},sendAudioMessage:async(e,a)=>{var n,r;console.log("[MSG_SEND] Starting local-first send for audio message"),s({isSending:!0,error:null});try{const o=B.getState().user;if(!o)throw new Error("User not authenticated");const c=me(),l=new Date().toISOString(),d={id:c,chatId:e,senderId:o.id,senderName:o.displayName,type:L.Audio,status:k.Sending,createdAt:l,localId:c,isLocalOnly:!0};s(m=>{const u=m.messagesByChatId[e]||[];return{messagesByChatId:{...m.messagesByChatId,[e]:[...u,d].sort((x,C)=>new Date(x.createdAt).getTime()-new Date(C.createdAt).getTime())},isSending:!1}}),console.log("[MSG_SEND] Audio message added to UI with local ID:",c);const g=URL.createObjectURL(a);await M.addToOutbox(e,L.Audio,void 0,g),Ut(c,e,a)}catch(i){console.error("[MSG_SEND] Failed to create local audio message:",i);const o=((r=(n=i.response)==null?void 0:n.data)==null?void 0:r.message)||"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞—É–¥–∏–æ";throw s({error:o,isSending:!1}),i}},sendImageMessage:async(e,a)=>{var n,r;console.log("[MSG_SEND] Starting local-first send for image message"),s({isSending:!0,error:null});try{const o=B.getState().user;if(!o)throw new Error("User not authenticated");const c=me(),l=new Date().toISOString(),d=URL.createObjectURL(a),g={id:c,chatId:e,senderId:o.id,senderName:o.displayName,type:L.Image,status:k.Sending,createdAt:l,localId:c,isLocalOnly:!0,localImagePath:d};s(m=>{const u=m.messagesByChatId[e]||[];return{messagesByChatId:{...m.messagesByChatId,[e]:[...u,g].sort((x,C)=>new Date(x.createdAt).getTime()-new Date(C.createdAt).getTime())},isSending:!1}}),console.log("[MSG_SEND] Image message added to UI with local ID:",c),await M.addToOutbox(e,L.Image,void 0,d),_t(c,e,a)}catch(i){console.error("[MSG_SEND] Failed to create local image message:",i);const o=((r=(n=i.response)==null?void 0:n.data)==null?void 0:r.message)||"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è";throw s({error:o,isSending:!1}),i}},addMessage:e=>{console.log("[MSG_RECV] Received message via SignalR:",e.id),s(r=>{var g;const i=r.messagesByChatId[e.chatId]||[],c=(g=B.getState().user)==null?void 0:g.id;if(c&&e.senderId===c){const m=i.findIndex(u=>u.isLocalOnly&&u.chatId===e.chatId&&u.content===e.content&&u.type===e.type&&Math.abs(new Date(u.createdAt).getTime()-new Date(e.createdAt).getTime())<5e3);if(m!==-1){const u=[...i],x=u[m];return u[m]={...e,localId:x.localId,isLocalOnly:!1},console.log("[MSG_RECV] Replaced local message with server message:",e.id),x.localId&&M.markAsSynced(x.localId,e.id),{messagesByChatId:{...r.messagesByChatId,[e.chatId]:u}}}}return i.some(m=>m.id===e.id)?(console.log("[MSG_RECV] Message already exists, ignoring:",e.id),r):(console.log("[MSG_RECV] Added new message to state:",e.id),{messagesByChatId:{...r.messagesByChatId,[e.chatId]:[...i,e].sort((m,u)=>new Date(m.createdAt).getTime()-new Date(u.createdAt).getTime())}})});const a=_.getState(),n=a.chats.find(r=>r.id===e.chatId);n&&a.updateChat({...n,lastMessage:e})},updateMessageStatus:(e,a)=>{s(n=>{const r={...n.messagesByChatId};for(const i in r){const o=r[i],c=o.findIndex(l=>l.id===e);if(c!==-1){const l=[...o];l[c]={...l[c],status:a},r[i]=l;break}}return{messagesByChatId:r}})},retryMessage:async e=>{console.log("[MSG_SEND] Retrying message:",e);try{const a=await M.getPendingMessageById(e);if(!a){console.error("[MSG_SEND] Pending message not found:",e);return}await M.retryMessage(e),s(n=>{const r={...n.messagesByChatId},i=r[a.chatId]||[],o=i.findIndex(c=>c.localId===e);if(o!==-1){const c=[...i];c[o]={...c[o],status:k.Sending},r[a.chatId]=c}return{messagesByChatId:r}}),a.type===L.Text&&Ae(e,a.chatId,a.type,a.content)}catch(a){console.error("[MSG_SEND] Failed to retry message:",a)}},clearError:()=>s({error:null})}));async function Ae(s,e,a,n){var r,i;try{console.log("[MSG_SEND] Syncing message to backend:",s),await M.markAsSyncing(s);const o=await we.sendMessage({chatId:e,type:a,content:n});console.log("[MSG_SEND] Message synced successfully. Server ID:",o.id),await M.markAsSynced(s,o.id);const l=D.getState().messagesByChatId[e]||[],d=l.findIndex(g=>g.id===s);if(d!==-1){const g=[...l];g[d]={...o,localId:s,isLocalOnly:!1},D.setState(m=>({messagesByChatId:{...m.messagesByChatId,[e]:g}})),console.log("[MSG_SEND] Message updated in UI with server ID:",o.id)}setTimeout(()=>{M.removePendingMessage(s)},6e4)}catch(o){console.error("[MSG_SEND] Failed to sync message to backend:",o);const c=((i=(r=o.response)==null?void 0:r.data)==null?void 0:i.message)||o.message||"Sync failed";await M.markAsFailed(s,c);const d=D.getState().messagesByChatId[e]||[],g=d.findIndex(m=>m.id===s);if(g!==-1){const m=[...d];m[g]={...m[g],status:k.Failed},D.setState(u=>({messagesByChatId:{...u.messagesByChatId,[e]:m}})),console.log("[MSG_SEND] Message marked as failed in UI:",s)}}}async function Ut(s,e,a){var n,r;try{console.log("[MSG_SEND] Syncing audio message to backend:",s),await M.markAsSyncing(s);const i=await we.sendAudioMessage(e,a);console.log("[MSG_SEND] Audio message synced successfully. Server ID:",i.id),await M.markAsSynced(s,i.id);const c=D.getState().messagesByChatId[e]||[],l=c.findIndex(d=>d.id===s);if(l!==-1){const d=[...c];d[l]={...i,localId:s,isLocalOnly:!1},D.setState(g=>({messagesByChatId:{...g.messagesByChatId,[e]:d}})),console.log("[MSG_SEND] Audio message updated in UI with server ID:",i.id)}setTimeout(()=>{M.removePendingMessage(s)},6e4)}catch(i){console.error("[MSG_SEND] Failed to sync audio message to backend:",i);const o=((r=(n=i.response)==null?void 0:n.data)==null?void 0:r.message)||i.message||"Sync failed";await M.markAsFailed(s,o);const l=D.getState().messagesByChatId[e]||[],d=l.findIndex(g=>g.id===s);if(d!==-1){const g=[...l];g[d]={...g[d],status:k.Failed},D.setState(m=>({messagesByChatId:{...m.messagesByChatId,[e]:g}})),console.log("[MSG_SEND] Audio message marked as failed in UI:",s)}}}async function _t(s,e,a){var n,r;try{console.log("[MSG_SEND] Syncing image message to backend:",s),await M.markAsSyncing(s);const i=await we.sendImageMessage(e,a);console.log("[MSG_SEND] Image message synced successfully. Server ID:",i.id),await M.markAsSynced(s,i.id);const c=D.getState().messagesByChatId[e]||[],l=c.findIndex(d=>d.id===s);if(l!==-1){const d=[...c];d[l]={...i,localId:s,isLocalOnly:!1,localImagePath:d[l].localImagePath},D.setState(g=>({messagesByChatId:{...g.messagesByChatId,[e]:d}})),console.log("[MSG_SEND] Image message updated in UI with server ID:",i.id)}setTimeout(()=>{M.removePendingMessage(s)},6e4)}catch(i){console.error("[MSG_SEND] Failed to sync image message to backend:",i);const o=((r=(n=i.response)==null?void 0:n.data)==null?void 0:r.message)||i.message||"Sync failed";await M.markAsFailed(s,o);const l=D.getState().messagesByChatId[e]||[],d=l.findIndex(g=>g.id===s);if(d!==-1){const g=[...l];g[d]={...g[d],status:k.Failed},D.setState(m=>({messagesByChatId:{...m.messagesByChatId,[e]:g}})),console.log("[MSG_SEND] Image message marked as failed in UI:",s)}}}P.onMessage(s=>{D.getState().addMessage(s)});P.onMessageStatus((s,e)=>{D.getState().updateMessageStatus(s,e)});const Y=class Y{constructor(){y(this,"permission","default");y(this,"currentChatId",null);this.permission=this.getPermissionStatus()}static getInstance(){return Y.instance||(Y.instance=new Y),Y.instance}isSupported(){return"Notification"in window}getPermissionStatus(){return this.isSupported()?Notification.permission:"denied"}async requestPermission(){if(!this.isSupported())return console.warn("[Notifications] Not supported in this browser"),"denied";if(this.permission==="granted")return"granted";try{const e=await Notification.requestPermission();return this.permission=e,console.log("[Notifications] Permission:",e),this.permission}catch(e){return console.error("[Notifications] Permission request failed:",e),"denied"}}setCurrentChat(e){this.currentChatId=e,console.log("[Notifications] Current chat set to:",e)}async show(e){if(e.tag&&e.tag===this.currentChatId){console.log("[Notifications] User in current chat, not showing notification");return}if(!this.isSupported()){console.warn("[Notifications] Not supported");return}if(this.permission!=="granted"){console.warn("[Notifications] Permission not granted");return}if(document.visibilityState==="visible"&&e.tag===this.currentChatId){console.log("[Notifications] Page visible, not showing notification");return}try{const a=new Notification(e.title,{body:e.body,icon:e.icon||"/icon-192.png",badge:e.badge||"/icon-96.png",tag:e.tag,data:e.data,requireInteraction:!1,silent:!1});e.onClick&&(a.onclick=()=>{var n;(n=e.onClick)==null||n.call(e),a.close(),window.focus()}),setTimeout(()=>{a.close()},1e4)}catch(a){console.error("[Notifications] Show failed:",a)}}async showMessageNotification(e,a,n,r){await this.show({title:e,body:a,tag:n,data:{chatId:n},onClick:r})}};y(Y,"instance");let je=Y;const de=je.getInstance();class Ft{constructor(){y(this,"audio",null);y(this,"currentUrl",null)}async play(e){if(this.audio&&this.currentUrl===e){this.audio.paused&&await this.audio.play();return}this.stop(),this.audio=new Audio(e),this.currentUrl=e;try{await this.audio.play(),console.log("[AudioPlayer] Playing",e)}catch(a){throw console.error("[AudioPlayer] Failed to play",a),new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∞—É–¥–∏–æ")}}pause(){this.audio&&!this.audio.paused&&(this.audio.pause(),console.log("[AudioPlayer] Paused"))}stop(){this.audio&&(this.audio.pause(),this.audio.currentTime=0,this.audio=null,this.currentUrl=null,console.log("[AudioPlayer] Stopped"))}seek(e){this.audio&&(this.audio.currentTime=e)}setVolume(e){this.audio&&(this.audio.volume=Math.max(0,Math.min(1,e)))}getCurrentTime(){var e;return((e=this.audio)==null?void 0:e.currentTime)||0}getDuration(){var e;return((e=this.audio)==null?void 0:e.duration)||0}isPlaying(e){return e?this.audio!==null&&this.currentUrl===e&&!this.audio.paused:this.audio!==null&&!this.audio.paused}onTimeUpdate(e){var n;const a=()=>e(this.getCurrentTime());return(n=this.audio)==null||n.addEventListener("timeupdate",a),()=>{var r;(r=this.audio)==null||r.removeEventListener("timeupdate",a)}}onEnded(e){var a;return(a=this.audio)==null||a.addEventListener("ended",e),()=>{var n;(n=this.audio)==null||n.removeEventListener("ended",e)}}onLoadedMetadata(e){var n;const a=()=>e(this.getDuration());return(n=this.audio)==null||n.addEventListener("loadedmetadata",a),()=>{var r;(r=this.audio)==null||r.removeEventListener("loadedmetadata",a)}}}const ie=new Ft,Gt=({filePath:s,isOwnMessage:e})=>{const[a,n]=h.useState(!1),[r,i]=h.useState(0),[o,c]=h.useState(0),l=`${ye}${s}`,d=h.useRef([]);h.useEffect(()=>{const u=new Audio(l),x=()=>{c(u.duration)};return u.addEventListener("loadedmetadata",x),u.load(),()=>{u.removeEventListener("loadedmetadata",x),d.current.forEach(C=>C())}},[l]);const g=async()=>{try{if(ie.isPlaying(l))ie.pause(),n(!1);else{await ie.play(l),n(!0);const u=ie.onTimeUpdate(C=>{i(C)}),x=ie.onEnded(()=>{n(!1),i(0)});d.current=[u,x]}}catch(u){console.error("Failed to play audio",u)}},m=o>0?r/o*100:0;return t.jsxs("div",{className:"flex items-center gap-2 min-w-[200px]",children:[t.jsx("button",{onClick:g,className:`w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 ${e?"bg-white/20 hover:bg-white/30":"bg-indigo-100 hover:bg-indigo-200"}`,children:a?t.jsx(Ke,{className:`w-5 h-5 ${e?"text-white":"text-indigo-600"}`}):t.jsx(Ze,{className:`w-5 h-5 ${e?"text-white":"text-indigo-600"}`})}),t.jsxs("div",{className:"flex-1",children:[t.jsx("div",{className:"relative h-1 bg-gray-300 rounded-full overflow-hidden",children:t.jsx("div",{className:`absolute top-0 left-0 h-full ${e?"bg-white":"bg-indigo-600"}`,style:{width:`${m}%`}})}),t.jsx("div",{className:`text-xs mt-1 ${e?"text-white/70":"text-gray-500"}`,children:Ue(a?r:o)})]})]})},$t=({message:s})=>{const{user:e}=B(),{retryMessage:a}=D(),n=(e==null?void 0:e.id)===s.senderId,[r,i]=h.useState(null),o=async()=>{if(s.localId)try{await a(s.localId)}catch(d){console.error("[MessageBubble] Failed to retry message:",d)}},c=()=>{if(!n)return null;switch(s.status){case k.Sending:return t.jsx(at,{className:"w-4 h-4 text-white/70 animate-pulse"});case k.Sent:return t.jsx(De,{className:"w-4 h-4 text-white/70"});case k.Delivered:return t.jsx(ke,{className:"w-4 h-4 text-gray-400"});case k.Read:return t.jsx(ke,{className:"w-4 h-4 text-green-400"});case k.Played:return t.jsx(st,{className:"w-4 h-4 text-blue-400"});case k.Failed:return t.jsx(tt,{className:"w-4 h-4 text-red-400"});default:return null}},l=()=>{switch(s.type){case L.Text:return t.jsx("p",{className:"whitespace-pre-wrap break-words",style:{wordWrap:"break-word",overflowWrap:"anywhere",hyphens:"auto"},children:s.content||""});case L.Audio:return s.filePath?t.jsx(Gt,{filePath:s.filePath,isOwnMessage:n}):t.jsx("p",{className:"text-sm opacity-70",children:"–ê—É–¥–∏–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ"});case L.Image:const d=s.localImagePath||(s.filePath?`${St}${s.filePath}`:null);return t.jsx("div",{className:"w-[200px] h-[200px] rounded-lg overflow-hidden cursor-pointer",onClick:()=>d&&i(d),children:d?t.jsx("img",{src:d,alt:"–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ",className:"w-full h-full object-cover",loading:"lazy",onError:g=>{g.currentTarget.style.display="none",g.currentTarget.parentElement.innerHTML=`
                    <div class="w-full h-full bg-gray-300 flex items-center justify-center">
                      <span class="text-sm text-gray-600">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</span>
                    </div>
                  `}}):t.jsx("div",{className:"w-full h-full bg-gray-300 flex items-center justify-center",children:t.jsx("span",{className:"text-sm text-gray-600",children:"–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ"})})});default:return null}};return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:`flex ${n?"justify-end":"justify-start"} mb-4`,children:t.jsxs("div",{className:`flex flex-col ${n?"items-end":"items-start"} gap-1`,children:[t.jsxs("div",{className:`rounded-2xl px-4 py-2 transition-all duration-300 ${s.isHighlighted?"ring-2 ring-yellow-400 bg-yellow-50":""} ${n?s.status===k.Failed?"bg-red-600 text-white":"bg-indigo-600 text-white":"bg-gray-200 text-gray-900"}`,style:{maxWidth:"min(70%, 500px)",minWidth:s.type===L.Image?"200px":"80px"},children:[!n&&t.jsx("div",{className:"text-xs font-semibold mb-1 text-indigo-600",children:s.senderName||"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"}),t.jsx("div",{children:l()}),t.jsxs("div",{className:`flex items-center gap-1 justify-end mt-1 text-xs ${n?"text-white/70":"text-gray-500"}`,children:[t.jsx("span",{children:Pe(s.createdAt)}),c()]})]}),n&&s.status===k.Failed&&t.jsxs("button",{onClick:o,className:"flex items-center gap-1 px-3 py-1 text-xs text-red-600 bg-red-50 hover:bg-red-100 rounded-full transition-colors",title:"–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É",children:[t.jsx(et,{className:"w-3 h-3"}),t.jsx("span",{children:"–ü–æ–≤—Ç–æ—Ä–∏—Ç—å"})]})]})}),r&&t.jsxs("div",{className:"fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4",onClick:()=>i(null),children:[t.jsx("button",{className:"absolute top-4 right-4 text-white text-3xl hover:text-gray-300 transition-colors",onClick:()=>i(null),children:"‚úï"}),t.jsxs("div",{className:"max-w-[90vw] max-h-[90vh]",children:[t.jsx("img",{src:r,alt:"–ü–æ–ª–Ω–æ—Ä–∞–∑–º–µ—Ä–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ",className:"max-w-full max-h-full object-contain",onClick:d=>d.stopPropagation()}),(s.senderName||s.createdAt)&&t.jsxs("div",{className:"text-white text-center mt-4",children:[s.senderName&&t.jsx("p",{className:"font-semibold",children:s.senderName}),s.createdAt&&t.jsx("p",{className:"text-sm",children:Pe(s.createdAt)})]})]})]})]})};class qt{constructor(){y(this,"mediaRecorder",null);y(this,"audioChunks",[]);y(this,"stream",null)}async startRecording(){try{this.stream=await navigator.mediaDevices.getUserMedia({audio:!0});const e=this.getSupportedMimeType();this.mediaRecorder=new MediaRecorder(this.stream,{mimeType:e,audioBitsPerSecond:128e3}),this.audioChunks=[],this.mediaRecorder.ondataavailable=a=>{a.data.size>0&&this.audioChunks.push(a.data)},this.mediaRecorder.start(),console.log("[AudioRecorder] Recording started")}catch(e){throw console.error("[AudioRecorder] Failed to start recording",e),new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É")}}async stopRecording(){return new Promise((e,a)=>{if(!this.mediaRecorder){a(new Error("–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞—á–∞—Ç–∞"));return}this.mediaRecorder.onstop=()=>{const n=this.mediaRecorder.mimeType,r=new Blob(this.audioChunks,{type:n});this.stream&&(this.stream.getTracks().forEach(i=>i.stop()),this.stream=null),this.mediaRecorder=null,this.audioChunks=[],console.log("[AudioRecorder] Recording stopped",r.size,"bytes"),e(r)},this.mediaRecorder.stop()})}cancelRecording(){this.mediaRecorder&&this.mediaRecorder.state!=="inactive"&&this.mediaRecorder.stop(),this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null),this.mediaRecorder=null,this.audioChunks=[],console.log("[AudioRecorder] Recording cancelled")}isRecording(){var e;return((e=this.mediaRecorder)==null?void 0:e.state)==="recording"}getSupportedMimeType(){const e=["audio/webm;codecs=opus","audio/webm","audio/ogg;codecs=opus","audio/mp4"];for(const a of e)if(MediaRecorder.isTypeSupported(a))return a;return""}}const ve=new qt,zt=({onSend:s,onCancel:e})=>{const[a,n]=h.useState(0),r=h.useRef();h.useEffect(()=>(i(),()=>{r.current&&clearInterval(r.current)}),[]);const i=async()=>{try{await ve.startRecording(),r.current=window.setInterval(()=>{n(l=>l+1)},1e3)}catch(l){console.error("Failed to start recording",l),alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É"),e()}},o=async()=>{try{const l=await ve.stopRecording();r.current&&clearInterval(r.current),s(l)}catch(l){console.error("Failed to stop recording",l)}},c=()=>{ve.cancelRecording(),r.current&&clearInterval(r.current),e()};return t.jsxs("div",{className:"flex items-center gap-3 px-4 py-3 bg-red-50 border-t border-red-200",children:[t.jsx("button",{onClick:c,className:"p-2 rounded-full hover:bg-red-100 transition",children:t.jsx(H,{className:"w-6 h-6 text-red-600"})}),t.jsxs("div",{className:"flex-1 flex items-center gap-3",children:[t.jsx("div",{className:"w-3 h-3 bg-red-600 rounded-full animate-pulse"}),t.jsxs("div",{className:"flex-1",children:[t.jsx("div",{className:"text-sm font-medium text-gray-700",children:"–ó–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è..."}),t.jsx("div",{className:"text-xs text-gray-500",children:Ue(a)})]})]}),t.jsx("button",{onClick:o,className:"p-2 rounded-full bg-indigo-600 hover:bg-indigo-700 transition",children:t.jsx(Re,{className:"w-6 h-6 text-white"})})]})},te=class te{constructor(e){y(this,"sendTypingIndicator");y(this,"debounceTimers",new Map);y(this,"stopTimers",new Map);y(this,"currentTypingStates",new Map);this.sendTypingIndicator=e}onTyping(e){const a=this.debounceTimers.get(e);a&&clearTimeout(a);const n=window.setTimeout(()=>{this.setTyping(e,!0)},te.TYPING_DEBOUNCE_DELAY);this.debounceTimers.set(e,n),this.resetStopTimer(e)}onStoppedTyping(e){this.setTyping(e,!1);const a=this.debounceTimers.get(e);a&&(clearTimeout(a),this.debounceTimers.delete(e));const n=this.stopTimers.get(e);n&&(clearTimeout(n),this.stopTimers.delete(e))}setTyping(e,a){if(this.currentTypingStates.get(e)!==a){this.currentTypingStates.set(e,a);try{this.sendTypingIndicator(e,a),console.log(`[TypingIndicator] Sent typing=${a} for chat ${e}`)}catch(n){console.error("[TypingIndicator] Error sending typing indicator:",n)}a&&this.resetStopTimer(e)}}resetStopTimer(e){const a=this.stopTimers.get(e);a&&clearTimeout(a);const n=window.setTimeout(()=>{this.setTyping(e,!1)},te.TYPING_STOP_DELAY);this.stopTimers.set(e,n)}cleanupChat(e){const a=this.debounceTimers.get(e);a&&(clearTimeout(a),this.debounceTimers.delete(e));const n=this.stopTimers.get(e);n&&(clearTimeout(n),this.stopTimers.delete(e)),this.currentTypingStates.delete(e),console.log(`[TypingIndicator] Cleaned up chat ${e}`)}dispose(){this.debounceTimers.forEach(e=>clearTimeout(e)),this.stopTimers.forEach(e=>clearTimeout(e)),this.debounceTimers.clear(),this.stopTimers.clear(),this.currentTypingStates.clear(),console.log("[TypingIndicator] Disposed")}getStats(){const e=Array.from(this.currentTypingStates.entries()).filter(([,a])=>a).map(([a])=>a);return{activeChats:this.currentTypingStates.size,typingChats:e}}};y(te,"TYPING_DEBOUNCE_DELAY",300),y(te,"TYPING_STOP_DELAY",3e3);let Ne=te;const X=class X{constructor(){y(this,"queue",[]);y(this,"processedEventIds",new Set);y(this,"processing",!1);y(this,"handlers",new Map);y(this,"totalEventsProcessed",0);y(this,"duplicatesSkipped",0);y(this,"lastProcessedAt",null);console.log("[EventQueueService] Initialized")}enqueue(e){if(this.processedEventIds.has(e.eventId)){this.duplicatesSkipped++,console.log(`[EventQueueService] Duplicate event skipped: ${e.type} (${e.eventId})`);return}this.queue.push(e),console.log(`[EventQueueService] Event enqueued: ${e.type} (queue size: ${this.queue.length})`),this.processQueue()}registerHandler(e,a){this.handlers.has(e)||this.handlers.set(e,[]),this.handlers.get(e).push(a),console.log(`[EventQueueService] Handler registered for event type: ${e}`)}unregisterHandlers(e){this.handlers.delete(e),console.log(`[EventQueueService] Handlers unregistered for event type: ${e}`)}async processQueue(){if(!this.processing){this.processing=!0;try{for(;this.queue.length>0;){const e=this.queue.shift();if(Date.now()-e.timestamp.getTime()>X.EVENT_TIMEOUT){console.log(`[EventQueueService] Event timeout: ${e.type} (${e.eventId})`);continue}if(await this.processEvent(e),this.processedEventIds.add(e.eventId),this.totalEventsProcessed++,this.lastProcessedAt=new Date,this.processedEventIds.size>X.MAX_PROCESSED_EVENT_IDS_SIZE){const a=this.processedEventIds.size-X.MAX_PROCESSED_EVENT_IDS_SIZE,n=this.processedEventIds.values();for(let r=0;r<a;r++){const i=n.next().value;i!==void 0&&this.processedEventIds.delete(i)}}}}catch(e){console.error("[EventQueueService] Error processing queue:",e)}finally{this.processing=!1}}}async processEvent(e){try{console.log(`[EventQueueService] Processing event: ${e.type} (${e.eventId})`);const a=this.handlers.get(e.type);if(!a||a.length===0){console.log(`[EventQueueService] No handlers registered for event type: ${e.type}`);return}for(const n of a)try{await n(e)}catch(r){console.error(`[EventQueueService] Error in handler for ${e.type}:`,r)}console.log(`[EventQueueService] Event processed successfully: ${e.type}`)}catch(a){console.error(`[EventQueueService] Error processing event: ${e.type}:`,a)}}getStats(){var e;return{queueSize:this.queue.length,totalEventsProcessed:this.totalEventsProcessed,duplicatesSkipped:this.duplicatesSkipped,lastProcessedAt:((e=this.lastProcessedAt)==null?void 0:e.toISOString())||null,isProcessing:this.processing,processedEventIdsSize:this.processedEventIds.size}}clear(){this.queue=[],console.log("[EventQueueService] Queue cleared")}dispose(){this.queue=[],this.processedEventIds.clear(),this.handlers.clear(),console.log("[EventQueueService] Disposed")}};y(X,"MAX_PROCESSED_EVENT_IDS_SIZE",1e3),y(X,"EVENT_TIMEOUT",3e4);let Ce=X;const W=new Ce;class Ht{constructor(){y(this,"isConnected",navigator.onLine);y(this,"callbacks",[]);y(this,"checkIntervalId",null);y(this,"CHECK_INTERVAL",3e4);y(this,"handleOnline",()=>{const e=this.isConnected;this.isConnected=!0,e||(console.log("[Connectivity] Status changed: ONLINE"),this.notifyCallbacks(!0))});y(this,"handleOffline",()=>{const e=this.isConnected;this.isConnected=!1,e&&(console.log("[Connectivity] Status changed: OFFLINE"),this.notifyCallbacks(!1))});this.init()}init(){this.isConnected=navigator.onLine,console.log(`[Connectivity] Initial status: ${this.isConnected?"ONLINE":"OFFLINE"}`),window.addEventListener("online",this.handleOnline),window.addEventListener("offline",this.handleOffline),this.startPeriodicCheck()}startPeriodicCheck(){this.checkIntervalId=window.setInterval(async()=>{await this.checkConnectivity()},this.CHECK_INTERVAL)}async checkConnectivity(){try{const e=new AbortController,a=setTimeout(()=>e.abort(),5e3),n=await fetch("/api/health",{method:"HEAD",signal:e.signal,cache:"no-cache"});clearTimeout(a);const r=this.isConnected;return this.isConnected=n.ok,r!==this.isConnected&&(console.log(`[Connectivity] Status changed via check: ${this.isConnected?"ONLINE":"OFFLINE"}`),this.notifyCallbacks(this.isConnected)),this.isConnected}catch{const a=this.isConnected;return this.isConnected=!1,a&&(console.log("[Connectivity] Status changed via check: OFFLINE"),this.notifyCallbacks(!1)),!1}}getIsConnected(){return this.isConnected}onConnectionChange(e){return this.callbacks.push(e),()=>{this.callbacks=this.callbacks.filter(a=>a!==e)}}notifyCallbacks(e){this.callbacks.forEach(a=>{try{a(e)}catch(n){console.error("[Connectivity] Error in callback:",n)}})}dispose(){window.removeEventListener("online",this.handleOnline),window.removeEventListener("offline",this.handleOffline),this.checkIntervalId!==null&&(clearInterval(this.checkIntervalId),this.checkIntervalId=null),this.callbacks=[],console.log("[Connectivity] Disposed")}}const ge=new Ht;class Vt{constructor(){y(this,"typingIndicatorService",null);y(this,"isInitialized",!1)}async initialize(e){if(this.isInitialized){console.log("[ServicesManager] Already initialized");return}console.log("[ServicesManager] Initializing services...");try{this.typingIndicatorService=new Ne(async(a,n)=>{await P.sendTypingIndicator(a,n)}),this.setupEventQueueHandlers(),await P.connect(e),this.setupConnectivityHandlers(),this.isInitialized=!0,console.log("[ServicesManager] Services initialized successfully")}catch(a){throw console.error("[ServicesManager] Initialization failed:",a),a}}setupEventQueueHandlers(){W.registerHandler("MessageReceived",e=>{console.log("[ServicesManager] Processing MessageReceived:",e.messageData.id)}),W.registerHandler("MessageSent",e=>{console.log("[ServicesManager] Processing MessageSent:",e.messageId)}),W.registerHandler("StatusUpdate",e=>{const a=e;console.log("[ServicesManager] Processing StatusUpdate:",a.messageId,a.newStatus)}),W.registerHandler("UserStatusChanged",e=>{const a=e;console.log("[ServicesManager] Processing UserStatusChanged:",a.userId,a.isOnline)}),W.registerHandler("TypingIndicator",e=>{const a=e;console.log("[ServicesManager] Processing TypingIndicator:",a.chatId,a.isTyping)}),console.log("[ServicesManager] EventQueue handlers registered")}setupConnectivityHandlers(){ge.onConnectionChange(e=>{console.log("[ServicesManager] Connection status changed:",e?"ONLINE":"OFFLINE"),e&&!P.isConnected&&console.log("[ServicesManager] Attempting to reconnect SignalR...")}),console.log("[ServicesManager] Connectivity handlers registered")}getTypingIndicatorService(){return this.typingIndicatorService}getStats(){var e;return{eventQueue:W.getStats(),typingIndicator:((e=this.typingIndicatorService)==null?void 0:e.getStats())||null,connectivity:ge.getIsConnected(),signalR:P.isConnected}}dispose(){this.typingIndicatorService&&(this.typingIndicatorService.dispose(),this.typingIndicatorService=null),W.dispose(),ge.dispose(),P.disconnect(),this.isInitialized=!1,console.log("[ServicesManager] Services disposed")}}const Ie=new Vt,Qt=s=>{const e=Ie.getTypingIndicatorService(),a=h.useCallback(()=>{e&&e.onTyping(s)},[s,e]),n=h.useCallback(()=>{e&&e.onStoppedTyping(s)},[s,e]),r=h.useCallback(()=>{e&&e.cleanupChat(s)},[s,e]);return{onTyping:a,onStoppedTyping:n,cleanup:r}},Wt=({onSendText:s,onSendAudio:e,onSendImage:a,disabled:n})=>{const[r,i]=h.useState(""),[o,c]=h.useState(!1),[l,d]=h.useState(null),[g,m]=h.useState(null),u=h.useRef(null),{selectedChatId:x}=_(),{onTyping:C,onStoppedTyping:w,cleanup:N}=Qt(x||"");h.useEffect(()=>()=>{N()},[x,N]);const f=S=>{S.preventDefault(),r.trim()&&!n&&(s(r.trim()),i(""),w())},v=S=>{i(S.target.value),x&&C()},b=()=>{c(!0)},I=S=>{c(!1),e(S)},$=()=>{c(!1)},j=S=>{var O;const F=(O=S.target.files)==null?void 0:O[0];if(F&&F.type.startsWith("image/")){if(F.size>10*1024*1024){alert("–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ. –ú–∞–∫—Å–∏–º—É–º 10MB");return}d(F);const G=new FileReader;G.onloadend=()=>{m(G.result)},G.readAsDataURL(F)}u.current&&(u.current.value="")},T=()=>{l&&a&&(a(l),d(null),m(null))},p=()=>{d(null),m(null)};return o?t.jsx(zt,{onSend:I,onCancel:$}):l&&g?t.jsx("div",{className:"px-4 py-3 border-t border-gray-200 bg-white",children:t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsxs("div",{className:"relative w-full max-w-xs",children:[t.jsx("img",{src:g,alt:"–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä",className:"w-full h-auto rounded-lg border border-gray-300"}),t.jsx("button",{onClick:p,className:"absolute top-2 right-2 p-1 bg-red-500 text-white rounded-full hover:bg-red-600 transition",children:t.jsx(H,{className:"w-4 h-4"})})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{onClick:T,disabled:n,className:"flex-1 py-2 px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full disabled:opacity-50 disabled:cursor-not-allowed transition",children:"–û—Ç–ø—Ä–∞–≤–∏—Ç—å"}),t.jsx("button",{onClick:p,className:"py-2 px-4 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-full transition",children:"–û—Ç–º–µ–Ω–∞"})]})]})}):t.jsxs("form",{onSubmit:f,className:"flex items-center gap-2 px-4 py-3 border-t border-gray-200 bg-white",children:[t.jsx("input",{ref:u,type:"file",accept:"image/*",className:"hidden",onChange:j}),t.jsx("button",{type:"button",onClick:()=>{var S;return(S=u.current)==null?void 0:S.click()},disabled:n,className:"p-2 text-gray-600 hover:text-indigo-600 disabled:opacity-50 disabled:cursor-not-allowed transition",title:"–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ",children:t.jsx(nt,{className:"w-6 h-6"})}),t.jsx("input",{type:"text",value:r,onChange:v,placeholder:"–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...",disabled:n,className:"flex-1 px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:opacity-50"}),r.trim()?t.jsx("button",{type:"submit",disabled:n,className:"p-2 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white disabled:opacity-50 disabled:cursor-not-allowed transition",children:t.jsx(Re,{className:"w-6 h-6"})}):t.jsx("button",{type:"button",onClick:b,disabled:n,className:"p-2 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white disabled:opacity-50 disabled:cursor-not-allowed transition",children:t.jsx(rt,{className:"w-6 h-6"})})]})},Yt=()=>{var $,j,T;const{selectedChatId:s,chats:e}=_(),{messagesByChatId:a,loadMessages:n,sendTextMessage:r,sendAudioMessage:i,sendImageMessage:o,isSending:c}=D(),l=h.useRef(null),[d,g]=h.useState(new Map),m=h.useRef(new Map),u=e.find(p=>p.id===s),x=s?a[s]||[]:[];if(h.useEffect(()=>(s&&(n(s),de.setCurrentChat(s)),()=>{de.setCurrentChat(null)}),[s]),h.useEffect(()=>{const p=P.onTyping((S,F,O)=>{if(O){g(ee=>{const re=new Map(ee);return re.set(S,F),re});const G=m.current.get(S);G&&clearTimeout(G);const be=setTimeout(()=>{g(ee=>{const re=new Map(ee);return re.delete(S),re}),m.current.delete(S)},3e3);m.current.set(S,be)}else{g(be=>{const ee=new Map(be);return ee.delete(S),ee});const G=m.current.get(S);G&&(clearTimeout(G),m.current.delete(S))}});return()=>{p(),m.current.forEach(S=>clearTimeout(S)),m.current.clear()}},[]),h.useEffect(()=>{var p;(p=l.current)==null||p.scrollIntoView({behavior:"smooth"})},[x,d]),!s)return t.jsx("div",{className:"h-full flex items-center justify-center bg-gray-50",children:t.jsxs("div",{className:"text-center",children:[t.jsx(he,{className:"w-20 h-20 text-gray-400 mx-auto mb-4"}),t.jsx("h3",{className:"text-xl font-semibold text-gray-700 mb-2",children:"–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç"}),t.jsx("p",{className:"text-gray-500",children:"–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ"})]})});const C=async p=>{try{await r(s,p),await P.sendTypingIndicator(s,!1)}catch(S){console.error("Failed to send message",S)}},w=async p=>{try{await i(s,p)}catch(S){console.error("Failed to send audio",S)}},N=async p=>{try{await o(s,p)}catch(S){console.error("Failed to send image",S)}},v=(p=>{if(!p||p.type!==K.Private||!p.otherParticipantId)return null;if(p.otherParticipantIsOnline)return"–æ–Ω–ª–∞–π–Ω";if(p.otherParticipantLastSeenAt){const S=new Date,F=new Date(p.otherParticipantLastSeenAt),O=Math.floor((S.getTime()-F.getTime())/1e3);return O<60?"—Ç–æ–ª—å–∫–æ —á—Ç–æ":O<3600?`–±—ã–ª(–∞) ${Math.floor(O/60)} –º–∏–Ω –Ω–∞–∑–∞–¥`:O<86400?`–±—ã–ª(–∞) ${Math.floor(O/3600)} —á –Ω–∞–∑–∞–¥`:O<604800?`–±—ã–ª(–∞) ${Math.floor(O/86400)} –¥–Ω –Ω–∞–∑–∞–¥`:"–±—ã–ª(–∞) –¥–∞–≤–Ω–æ"}return null})(u),b=Array.from(d.values()),I=b.length>0?b.length===1?`${b[0]} –ø–µ—á–∞—Ç–∞–µ—Ç...`:`${b.join(", ")} –ø–µ—á–∞—Ç–∞—é—Ç...`:null;return t.jsxs("div",{className:"h-full flex flex-col",children:[t.jsx("div",{className:"px-6 py-4 border-b border-gray-200 bg-white",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center text-white font-semibold",children:((j=($=u==null?void 0:u.title)==null?void 0:$[0])==null?void 0:j.toUpperCase())||"?"}),t.jsxs("div",{children:[t.jsx("h2",{className:"font-semibold text-gray-900",children:(u==null?void 0:u.title)||"–ó–∞–≥—Ä—É–∑–∫–∞..."}),I?t.jsx("p",{className:"text-sm text-indigo-600 animate-pulse",children:I}):v?t.jsxs("p",{className:`text-sm flex items-center gap-1 ${v==="–æ–Ω–ª–∞–π–Ω"?"text-green-500":"text-gray-500"}`,children:[v==="–æ–Ω–ª–∞–π–Ω"&&t.jsx("span",{className:"inline-block w-2 h-2 bg-green-500 rounded-full animate-pulse"}),v]}):t.jsxs("p",{className:"text-sm text-gray-500",children:[((T=u==null?void 0:u.participants)==null?void 0:T.length)||0," —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"]})]})]})}),t.jsx("div",{className:"flex-1 overflow-y-auto p-4 bg-gray-50",children:x.length===0?t.jsx("div",{className:"flex items-center justify-center h-full",children:t.jsx("p",{className:"text-gray-500",children:"–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π"})}):t.jsxs(t.Fragment,{children:[x.map(p=>t.jsx($t,{message:p},p.id)),I&&t.jsx("div",{className:"flex justify-start mb-4",children:t.jsx("div",{className:"bg-gray-200 rounded-2xl px-4 py-3",children:t.jsxs("div",{className:"flex gap-1",children:[t.jsx("span",{className:"w-2 h-2 bg-gray-500 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),t.jsx("span",{className:"w-2 h-2 bg-gray-500 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),t.jsx("span",{className:"w-2 h-2 bg-gray-500 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]})})}),t.jsx("div",{ref:l})]})}),t.jsx(Wt,{onSendText:C,onSendAudio:w,onSendImage:N,disabled:c})]})},Xt=({onClose:s,onChatCreated:e})=>{const a=Z(),n=()=>{s(),a("/new-chat")},r=()=>{s(),a("/create-group")};return t.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:t.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-md w-full",children:[t.jsxs("div",{className:"p-4 border-b flex items-center justify-between",children:[t.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"–°–æ–∑–¥–∞—Ç—å —á–∞—Ç"}),t.jsx("button",{onClick:s,className:"p-2 rounded-lg hover:bg-gray-100 transition",children:t.jsx(H,{className:"w-6 h-6"})})]}),t.jsxs("div",{className:"p-4 space-y-3",children:[t.jsxs("button",{onClick:n,className:"w-full flex items-center gap-4 p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition text-left",children:[t.jsx("div",{className:"w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0",children:t.jsx(he,{className:"w-6 h-6 text-indigo-600"})}),t.jsxs("div",{className:"flex-1",children:[t.jsx("h3",{className:"font-semibold text-gray-900",children:"–õ–∏—á–Ω—ã–π —á–∞—Ç"}),t.jsx("p",{className:"text-sm text-gray-500",children:"–ù–∞—á–∞—Ç—å –±–µ—Å–µ–¥—É —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"})]})]}),t.jsxs("button",{onClick:r,className:"w-full flex items-center gap-4 p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition text-left",children:[t.jsx("div",{className:"w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0",children:t.jsx(fe,{className:"w-6 h-6 text-indigo-600"})}),t.jsxs("div",{className:"flex-1",children:[t.jsx("h3",{className:"font-semibold text-gray-900",children:"–ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç"}),t.jsx("p",{className:"text-sm text-gray-500",children:"–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏"})]})]})]}),t.jsx("div",{className:"p-4 border-t",children:t.jsx("button",{onClick:s,className:"w-full px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition font-medium",children:"–û—Ç–º–µ–Ω–∞"})})]})})},Jt=()=>{const[s,e]=h.useState(ge.getIsConnected()),[a,n]=h.useState(!s);return h.useEffect(()=>{const r=ge.onConnectionChange(i=>{e(i),n(!i),i&&setTimeout(()=>{n(!1)},3e3)});return()=>{r()}},[]),a?t.jsx("div",{className:`flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium ${s?"bg-green-500 text-white":"bg-yellow-500 text-gray-900"}`,children:s?t.jsxs(t.Fragment,{children:[t.jsx(it,{className:"w-4 h-4"}),t.jsx("span",{children:"–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"})]}):t.jsxs(t.Fragment,{children:[t.jsx(ot,{className:"w-4 h-4"}),t.jsx("span",{children:"–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É"})]})}):null},Kt=({children:s})=>{const[e,a]=h.useState("all"),[n,r]=h.useState(!1),{selectChat:i}=_(),o=Z(),c=l=>{i(l)};return t.jsxs("div",{className:"h-screen flex flex-col",children:[t.jsx(Dt,{}),t.jsx(Jt,{}),t.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[t.jsxs("div",{className:"w-80 border-r border-gray-200 bg-white flex flex-col",children:[t.jsxs("div",{className:"p-4 border-b border-gray-200 flex items-center justify-between",children:[t.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"–ß–∞—Ç—ã"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:()=>o("/search"),className:"p-2 rounded-lg hover:bg-gray-100 transition",title:"–ü–æ–∏—Å–∫",children:t.jsx(se,{className:"w-5 h-5 text-gray-600"})}),t.jsx("button",{onClick:()=>r(!0),className:"p-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition",title:"–ù–æ–≤—ã–π —á–∞—Ç",children:t.jsx(ct,{className:"w-5 h-5"})})]})]}),t.jsxs("div",{className:"flex border-b border-gray-200",children:[t.jsx("button",{onClick:()=>a("all"),className:`flex-1 py-3 px-2 text-sm font-medium transition ${e==="all"?"text-indigo-600 border-b-2 border-indigo-600":"text-gray-600 hover:text-gray-900"}`,children:"–í—Å–µ"}),t.jsxs("button",{onClick:()=>a("private"),className:`flex-1 py-3 px-2 text-sm font-medium transition flex items-center justify-center gap-1 ${e==="private"?"text-indigo-600 border-b-2 border-indigo-600":"text-gray-600 hover:text-gray-900"}`,children:[t.jsx(he,{className:"w-4 h-4"}),"–õ–∏—á–Ω—ã–µ"]}),t.jsxs("button",{onClick:()=>a("group"),className:`flex-1 py-3 px-2 text-sm font-medium transition flex items-center justify-center gap-1 ${e==="group"?"text-indigo-600 border-b-2 border-indigo-600":"text-gray-600 hover:text-gray-900"}`,children:[t.jsx(fe,{className:"w-4 h-4"}),"–ì—Ä—É–ø–ø—ã"]})]}),t.jsx("div",{className:"flex-1 overflow-hidden",children:t.jsx(Ot,{filterType:e})})]}),t.jsx("div",{className:"flex-1",children:s||t.jsx(Yt,{})})]}),n&&t.jsx(Xt,{onClose:()=>r(!1),onChatCreated:c})]})},Zt=()=>t.jsx(Kt,{}),es=xe((s,e)=>({inviteLinks:[],isLoading:!1,isCreating:!1,error:null,loadInviteLinks:async()=>{s({isLoading:!0,error:null});try{const a=await ce.getMyInviteLinks();s({inviteLinks:a,isLoading:!1})}catch(a){console.error("[SettingsStore] Load invite links error:",a),s({error:"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–¥–æ–≤ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è",isLoading:!1})}},createInviteLink:async()=>{var a,n;s({isCreating:!0,error:null});try{const r=await ce.createInviteLink();return await e().loadInviteLinks(),s({isCreating:!1}),r}catch(r){console.error("[SettingsStore] Create invite link error:",r);const i=((n=(a=r.response)==null?void 0:a.data)==null?void 0:n.message)||"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–¥–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è";return s({error:i,isCreating:!1}),null}},refreshInvites:async()=>{await e().loadInviteLinks()},clearError:()=>s({error:null}),get validInviteLinks(){const a=new Date;return e().inviteLinks.filter(n=>!(n.isUsed||n.expiresAt&&new Date(n.expiresAt)<a))}})),ts=({user:s})=>t.jsx("div",{className:"bg-white rounded-lg shadow-sm p-6",children:t.jsxs("div",{className:"flex flex-col items-center",children:[t.jsx("div",{className:"w-24 h-24 bg-indigo-600 rounded-full flex items-center justify-center text-white text-3xl font-semibold mb-4",children:s.avatar?t.jsx("img",{src:s.avatar,alt:s.displayName,className:"w-full h-full rounded-full object-cover"}):t.jsx(ae,{className:"w-12 h-12"})}),t.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:s.displayName}),t.jsx("p",{className:"text-gray-600 mb-3",children:s.phoneNumber}),s.isAdmin&&t.jsx("span",{className:"inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800",children:"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"})]})}),ss=({inviteCode:s,inviteLink:e,onClose:a})=>{const[n,r]=h.useState(!1),i=()=>{navigator.clipboard.writeText(s),r(!0),setTimeout(()=>r(!1),2e3)},o=()=>{const c=`–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ –î–µ–ø–µ—à–µ!

–ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è: ${s}
–ò–ª–∏ –ø–µ—Ä–µ–π–¥–∏ –ø–æ —Å—Å—ã–ª–∫–µ: ${e}

–ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 7 –¥–Ω–µ–π.`;navigator.share?navigator.share({title:"–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ May Messenger",text:c}).catch(l=>console.log("Share failed:",l)):(navigator.clipboard.writeText(c),alert("–¢–µ–∫—Å—Ç –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!"))};return t.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:t.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-md w-full p-6 relative",children:[t.jsx("button",{onClick:a,className:"absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition",children:t.jsx(H,{className:"w-6 h-6"})}),t.jsxs("div",{className:"mb-6",children:[t.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞"}),t.jsx("p",{className:"text-gray-600",children:"–ü–æ–ø—Ä–æ—Å–∏—Ç–µ –¥—Ä—É–≥–∞ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç QR –∫–æ–¥ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –≤—Ä—É—á–Ω—É—é"})]}),t.jsx("div",{className:"bg-white p-6 rounded-lg shadow-md mb-6 flex justify-center",children:t.jsx(lt,{value:e,size:200,level:"M",includeMargin:!0})}),t.jsxs("div",{className:"bg-gray-100 rounded-lg p-4 mb-6",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-xl font-mono font-bold text-gray-900",children:s}),t.jsx("button",{onClick:i,className:"ml-3 p-2 rounded-lg hover:bg-gray-200 transition",title:"–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥",children:t.jsx(Le,{className:"w-5 h-5 text-gray-600"})})]}),n&&t.jsx("p",{className:"text-sm text-green-600 mt-2",children:"–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!"})]}),t.jsxs("div",{className:"flex gap-3",children:[t.jsxs("button",{onClick:o,className:"flex-1 flex items-center justify-center gap-2 px-4 py-3 border border-indigo-600 text-indigo-600 rounded-lg hover:bg-indigo-50 transition font-medium",children:[t.jsx(dt,{className:"w-5 h-5"}),"–ü–æ–¥–µ–ª–∏—Ç—å—Å—è"]}),t.jsx("button",{onClick:a,className:"flex-1 px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium",children:"–ó–∞–∫—Ä—ã—Ç—å"})]}),t.jsx("p",{className:"text-sm text-gray-500 text-center mt-4",children:"–ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 7 –¥–Ω–µ–π –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω 1 —Ä–∞–∑"})]})})},as=()=>{const s=Z(),{user:e,logout:a}=B(),{inviteLinks:n,isLoading:r,isCreating:i,loadInviteLinks:o,createInviteLink:c,validInviteLinks:l}=es(),[d,g]=h.useState(!1),[m,u]=h.useState(null);h.useEffect(()=>{o()},[]);const x=async()=>{const b=await c();b&&(u({code:b.code,link:b.inviteLink}),g(!0))},C=(b,I)=>{u({code:b,link:I}),g(!0)},w=b=>{navigator.clipboard.writeText(b)},N=async()=>{confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?")&&(await a(),s("/login"))},f=b=>{if(b.isUsed)return`–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω ${new Date(b.usedAt).toLocaleDateString()}`;if(b.expiresAt){const I=new Date(b.expiresAt);return I<new Date?"–ò—Å—Ç—ë–∫":`–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ ${I.toLocaleDateString()}`}return"–ê–∫—Ç–∏–≤–µ–Ω"},v=b=>!(b.isUsed||b.expiresAt&&new Date(b.expiresAt)<new Date);return e?t.jsxs("div",{className:"min-h-screen bg-gray-50",children:[t.jsx("header",{className:"bg-white shadow-sm",children:t.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-4 flex items-center gap-3",children:[t.jsx("button",{onClick:()=>s("/"),className:"p-2 rounded-lg hover:bg-gray-100 transition",children:t.jsx(gt,{className:"w-6 h-6"})}),t.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"–ù–∞—Å—Ç—Ä–æ–π–∫–∏"})]})}),t.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-6 space-y-6",children:[t.jsx(ts,{user:e}),t.jsx("div",{className:"bg-white rounded-lg shadow-sm p-6",children:t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(ut,{className:"w-6 h-6 text-indigo-600"}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞"}),t.jsx("p",{className:"text-sm text-gray-600",children:"–°–æ–∑–¥–∞–π—Ç–µ QR –∫–æ–¥ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è"})]})]}),t.jsx("button",{onClick:x,disabled:i,className:"px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2",children:i?t.jsxs(t.Fragment,{children:[t.jsx(ne,{className:"w-4 h-4 animate-spin"}),"–°–æ–∑–¥–∞–Ω–∏–µ..."]}):"–°–æ–∑–¥–∞—Ç—å –∫–æ–¥"})]})}),t.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-6",children:[t.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[t.jsx(ht,{className:"w-6 h-6 text-indigo-600"}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"–ú–æ–∏ –∫–æ–¥—ã –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è"}),t.jsxs("p",{className:"text-sm text-gray-600",children:["–ê–∫—Ç–∏–≤–Ω—ã—Ö: ",l.length]})]})]}),r?t.jsx("div",{className:"flex justify-center py-8",children:t.jsx(ne,{className:"w-8 h-8 animate-spin text-indigo-600"})}):n.length===0?t.jsx("p",{className:"text-gray-500 text-center py-8",children:"–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤"}):t.jsx("div",{className:"space-y-3",children:n.map(b=>{const I=v(b);return t.jsxs("div",{className:`flex items-center justify-between p-4 rounded-lg border ${I?"border-green-200 bg-green-50":"border-gray-200 bg-gray-50"}`,children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:`w-3 h-3 rounded-full ${I?"bg-green-500":"bg-gray-400"}`}),t.jsxs("div",{children:[t.jsx("p",{className:"font-mono font-bold text-gray-900",children:b.code}),t.jsx("p",{className:"text-sm text-gray-600",children:f(b)})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:()=>w(b.code),className:"p-2 rounded-lg hover:bg-gray-200 transition",title:"–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥",children:t.jsx(Le,{className:"w-5 h-5 text-gray-600"})}),I&&b.inviteLink&&t.jsx("button",{onClick:()=>C(b.code,b.inviteLink),className:"px-3 py-1 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition",children:"QR –∫–æ–¥"})]})]},b.id)})})]}),t.jsx("div",{className:"bg-white rounded-lg shadow-sm p-6",children:t.jsxs("button",{onClick:N,className:"w-full flex items-center justify-center gap-2 px-4 py-3 text-red-600 hover:bg-red-50 rounded-lg transition font-medium",children:[t.jsx(mt,{className:"w-5 h-5"}),"–í—ã–π—Ç–∏"]})})]}),d&&m&&t.jsx(ss,{inviteCode:m.code,inviteLink:m.link,onClose:()=>g(!1)})]}):null};class ns{async searchUsers(e,a=!1){try{const n=await E.get("/api/users/search",{params:{query:e,contactsOnly:a}});return Array.isArray(n.data)?n.data:[]}catch(n){throw console.error("[SearchService] Error searching users:",n),n}}async searchMessages(e){try{const a=await E.get("/api/messages/search",{params:{query:e}});return Array.isArray(a.data)?a.data:[]}catch(a){throw console.error("[SearchService] Error searching messages:",a),a}}async searchAll(e){try{const[a,n]=await Promise.all([this.searchUsers(e),this.searchMessages(e)]);return{users:a,messages:n}}catch(a){throw console.error("[SearchService] Error in combined search:",a),a}}}const ue=new ns,rs=()=>{const[s,e]=h.useState(""),[a,n]=h.useState(!1),[r,i]=h.useState(null),[o,c]=h.useState([]),[l,d]=h.useState([]),{selectChat:g}=_(),m=Z();h.useEffect(()=>{if(!s.trim()){c([]),d([]),i(null);return}const f=setTimeout(async()=>{await u(s)},300);return()=>clearTimeout(f)},[s]);const u=async f=>{var v,b;n(!0),i(null);try{const I=await ue.searchAll(f);c(I.users),d(I.messages)}catch(I){console.error("[SearchPage] Search error:",I),i(((b=(v=I.response)==null?void 0:v.data)==null?void 0:b.message)||"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞")}finally{n(!1)}},x=async f=>{var v,b;try{const I=await le.createOrGetPrivateChat(f.id);g(I.id),m("/")}catch(I){console.error("[SearchPage] Error creating/getting chat:",I),i(((b=(v=I.response)==null?void 0:v.data)==null?void 0:b.message)||"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞")}},C=f=>{g(f.chatId),m("/")},w=()=>{e("")},N=o.length>0||l.length>0;return t.jsxs("div",{className:"h-screen flex flex-col bg-gray-50",children:[t.jsx("div",{className:"bg-white border-b border-gray-200 p-4",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("button",{onClick:()=>m("/"),className:"p-2 hover:bg-gray-100 rounded-lg transition","aria-label":"–ù–∞–∑–∞–¥",children:t.jsx(H,{className:"w-5 h-5 text-gray-600"})}),t.jsxs("div",{className:"flex-1 relative",children:[t.jsx(se,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),t.jsx("input",{type:"text",value:s,onChange:f=>e(f.target.value),placeholder:"–ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π...",className:"w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent",autoFocus:!0}),s&&t.jsx("button",{onClick:w,className:"absolute right-3 top-1/2 -translate-y-1/2 p-1 hover:bg-gray-100 rounded-full transition","aria-label":"–û—á–∏—Å—Ç–∏—Ç—å",children:t.jsx(H,{className:"w-4 h-4 text-gray-400"})})]})]})}),t.jsxs("div",{className:"flex-1 overflow-y-auto",children:[!s.trim()&&t.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-500",children:[t.jsx(se,{className:"w-16 h-16 mb-4 text-gray-400"}),t.jsx("p",{className:"text-lg font-medium",children:"–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –¥–ª—è –ø–æ–∏—Å–∫–∞"}),t.jsx("p",{className:"text-sm mt-2",children:"–ö–æ–Ω—Ç–∞–∫—Ç—ã ‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏—è"})]}),a&&t.jsx("div",{className:"flex items-center justify-center h-32",children:t.jsx(ne,{className:"w-8 h-8 text-indigo-600 animate-spin"})}),r&&t.jsx("div",{className:"flex flex-col items-center justify-center h-32 px-4",children:t.jsxs("div",{className:"text-red-500 text-center",children:[t.jsx("p",{className:"font-medium mb-2",children:"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞"}),t.jsx("p",{className:"text-sm",children:r})]})}),!a&&!r&&s.trim()&&!N&&t.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-500",children:[t.jsx(se,{className:"w-16 h-16 mb-4 text-gray-300"}),t.jsx("p",{className:"text-lg font-medium",children:"–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"}),t.jsx("p",{className:"text-sm mt-2",children:"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å"})]}),!a&&!r&&N&&t.jsxs("div",{className:"py-4",children:[o.length>0&&t.jsxs("div",{className:"mb-6",children:[t.jsx("div",{className:"px-4 mb-3",children:t.jsxs("h3",{className:"text-sm font-semibold text-indigo-600",children:["–ö–æ–Ω—Ç–∞–∫—Ç—ã (",o.length,")"]})}),t.jsx("div",{className:"bg-white divide-y divide-gray-100",children:o.map(f=>t.jsxs("button",{onClick:()=>x(f),className:"w-full px-4 py-3 hover:bg-gray-50 transition text-left flex items-center gap-3",children:[t.jsx("div",{className:"w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0",children:t.jsx(ae,{className:"w-5 h-5 text-indigo-600"})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("p",{className:"font-medium text-gray-900 truncate",children:f.displayName}),t.jsx("p",{className:"text-sm text-gray-500 truncate",children:f.phoneNumber})]}),f.isOnline&&t.jsx("div",{className:"w-2 h-2 rounded-full bg-green-500 flex-shrink-0"})]},f.id))})]}),l.length>0&&t.jsxs("div",{children:[t.jsx("div",{className:"px-4 mb-3",children:t.jsxs("h3",{className:"text-sm font-semibold text-indigo-600",children:["–°–æ–æ–±—â–µ–Ω–∏—è (",l.length,")"]})}),t.jsx("div",{className:"bg-white divide-y divide-gray-100",children:l.map(f=>t.jsx("button",{onClick:()=>C(f),className:"w-full px-4 py-3 hover:bg-gray-50 transition text-left",children:t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center flex-shrink-0 mt-1",children:t.jsx(he,{className:"w-5 h-5 text-gray-600"})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("p",{className:"font-medium text-gray-900 mb-1",children:f.chatTitle}),t.jsx("p",{className:"text-sm text-gray-700 line-clamp-2 mb-1",children:f.messageContent}),t.jsx("p",{className:"text-xs text-gray-500",children:f.senderName})]})]})},f.messageId))})]})]})]})]})},is=()=>{const[s,e]=h.useState(""),[a,n]=h.useState(!1),[r,i]=h.useState(!1),[o,c]=h.useState(null),[l,d]=h.useState([]),{selectChat:g}=_(),m=Z();h.useEffect(()=>{u()},[]),h.useEffect(()=>{if(!s.trim()){u();return}const w=setTimeout(async()=>{await x(s)},300);return()=>clearTimeout(w)},[s]);const u=async()=>{var w,N;n(!0),c(null);try{const f=await ue.searchUsers("",!0);d(f)}catch(f){console.error("[NewChatPage] Error loading contacts:",f),c(((N=(w=f.response)==null?void 0:w.data)==null?void 0:N.message)||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤")}finally{n(!1)}},x=async w=>{var N,f;n(!0),c(null);try{const v=await ue.searchUsers(w,!1);d(v)}catch(v){console.error("[NewChatPage] Search error:",v),c(((f=(N=v.response)==null?void 0:N.data)==null?void 0:f.message)||"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞")}finally{n(!1)}},C=async w=>{var N,f;i(!0),c(null);try{const v=await le.createOrGetPrivateChat(w.id);g(v.id),m("/")}catch(v){console.error("[NewChatPage] Error creating/getting chat:",v),c(((f=(N=v.response)==null?void 0:N.data)==null?void 0:f.message)||"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞")}finally{i(!1)}};return t.jsxs("div",{className:"h-screen flex flex-col bg-gray-50",children:[t.jsxs("div",{className:"bg-white border-b border-gray-200 p-4",children:[t.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[t.jsx("button",{onClick:()=>m("/"),className:"p-2 hover:bg-gray-100 rounded-lg transition","aria-label":"–ù–∞–∑–∞–¥",children:t.jsx(H,{className:"w-5 h-5 text-gray-600"})}),t.jsx("h1",{className:"text-xl font-semibold text-gray-900",children:"–ù–æ–≤—ã–π —á–∞—Ç"})]}),t.jsxs("div",{className:"relative",children:[t.jsx(se,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),t.jsx("input",{type:"text",value:s,onChange:w=>e(w.target.value),placeholder:"–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ –Ω–æ–º–µ—Ä—É...",className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"})]})]}),o&&t.jsx("div",{className:"mx-4 mt-4 p-3 bg-red-50 border border-red-200 rounded-lg",children:t.jsx("p",{className:"text-sm text-red-700",children:o})}),t.jsxs("div",{className:"flex-1 overflow-y-auto",children:[a&&t.jsx("div",{className:"flex items-center justify-center h-32",children:t.jsx(ne,{className:"w-8 h-8 text-indigo-600 animate-spin"})}),!a&&l.length===0&&t.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-500",children:[t.jsx(ae,{className:"w-16 h-16 mb-4 text-gray-300"}),t.jsx("p",{className:"text-lg font-medium",children:"–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"}),t.jsx("p",{className:"text-sm mt-2",children:"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å"})]}),!a&&l.length>0&&t.jsx("div",{className:"bg-white divide-y divide-gray-100 mt-4",children:l.map(w=>t.jsxs("button",{onClick:()=>C(w),disabled:r,className:"w-full px-4 py-3 hover:bg-gray-50 transition text-left flex items-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed",children:[t.jsx("div",{className:"w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0",children:t.jsx(ae,{className:"w-5 h-5 text-indigo-600"})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("p",{className:"font-medium text-gray-900 truncate",children:w.displayName}),t.jsx("p",{className:"text-sm text-gray-500 truncate",children:w.phoneNumber})]}),w.isOnline&&t.jsx("div",{className:"w-2 h-2 rounded-full bg-green-500 flex-shrink-0"})]},w.id))})]})]})},os=()=>{const[s,e]=h.useState(""),[a,n]=h.useState(""),[r,i]=h.useState(!1),[o,c]=h.useState(!1),[l,d]=h.useState(null),[g,m]=h.useState([]),[u,x]=h.useState(new Set),{createChat:C,selectChat:w}=_(),N=Z();h.useEffect(()=>{f()},[]),h.useEffect(()=>{if(!a.trim()){f();return}const j=setTimeout(async()=>{await v(a)},300);return()=>clearTimeout(j)},[a]);const f=async()=>{var j,T;i(!0),d(null);try{const p=await ue.searchUsers("",!0);m(p)}catch(p){console.error("[CreateGroupPage] Error loading contacts:",p),d(((T=(j=p.response)==null?void 0:j.data)==null?void 0:T.message)||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤")}finally{i(!1)}},v=async j=>{var T,p;i(!0),d(null);try{const S=await ue.searchUsers(j,!1);m(S)}catch(S){console.error("[CreateGroupPage] Search error:",S),d(((p=(T=S.response)==null?void 0:T.data)==null?void 0:p.message)||"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞")}finally{i(!1)}},b=j=>{x(T=>{const p=new Set(T);return p.has(j)?p.delete(j):p.add(j),p})},I=async()=>{var j,T;if(!s.trim()){d("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã");return}if(u.size===0){d("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞");return}c(!0),d(null);try{const p=await C(s,Array.from(u));w(p.id),N("/")}catch(p){console.error("[CreateGroupPage] Error creating group:",p),d(((T=(j=p.response)==null?void 0:j.data)==null?void 0:T.message)||"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã")}finally{c(!1)}},$=s.trim()&&u.size>0&&!o;return t.jsxs("div",{className:"h-screen flex flex-col bg-gray-50",children:[t.jsxs("div",{className:"bg-white border-b border-gray-200 p-4",children:[t.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[t.jsx("button",{onClick:()=>N("/"),className:"p-2 hover:bg-gray-100 rounded-lg transition","aria-label":"–ù–∞–∑–∞–¥",children:t.jsx(H,{className:"w-5 h-5 text-gray-600"})}),t.jsx("h1",{className:"text-xl font-semibold text-gray-900",children:"–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞"})]}),t.jsx("div",{className:"mb-4",children:t.jsx("input",{type:"text",value:s,onChange:j=>e(j.target.value),placeholder:"–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"})}),t.jsxs("div",{className:"relative",children:[t.jsx(se,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),t.jsx("input",{type:"text",value:a,onChange:j=>n(j.target.value),placeholder:"–ü–æ–∏—Å–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤...",className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"})]}),u.size>0&&t.jsxs("div",{className:"mt-3 text-sm text-gray-600",children:["–í—ã–±—Ä–∞–Ω–æ: ",u.size]})]}),l&&t.jsx("div",{className:"mx-4 mt-4 p-3 bg-red-50 border border-red-200 rounded-lg",children:t.jsx("p",{className:"text-sm text-red-700",children:l})}),t.jsxs("div",{className:"flex-1 overflow-y-auto",children:[r&&t.jsx("div",{className:"flex items-center justify-center h-32",children:t.jsx(ne,{className:"w-8 h-8 text-indigo-600 animate-spin"})}),!r&&g.length===0&&t.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-500",children:[t.jsx(fe,{className:"w-16 h-16 mb-4 text-gray-300"}),t.jsx("p",{className:"text-lg font-medium",children:"–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"}),t.jsx("p",{className:"text-sm mt-2",children:"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å"})]}),!r&&g.length>0&&t.jsx("div",{className:"bg-white divide-y divide-gray-100 mt-4",children:g.map(j=>{const T=u.has(j.id);return t.jsxs("button",{onClick:()=>b(j.id),className:`w-full px-4 py-3 transition text-left flex items-center gap-3 ${T?"bg-indigo-50":"hover:bg-gray-50"}`,children:[t.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 ${T?"bg-indigo-600":"bg-indigo-100"}`,children:T?t.jsx(De,{className:"w-5 h-5 text-white"}):t.jsx(ae,{className:"w-5 h-5 text-indigo-600"})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("p",{className:"font-medium text-gray-900 truncate",children:j.displayName}),t.jsx("p",{className:"text-sm text-gray-500 truncate",children:j.phoneNumber})]}),j.isOnline&&t.jsx("div",{className:"w-2 h-2 rounded-full bg-green-500 flex-shrink-0"})]},j.id)})})]}),t.jsx("div",{className:"bg-white border-t border-gray-200 p-4",children:t.jsx("button",{onClick:I,disabled:!$,className:`w-full py-3 rounded-lg font-medium transition ${$?"bg-indigo-600 text-white hover:bg-indigo-700":"bg-gray-200 text-gray-400 cursor-not-allowed"}`,children:o?t.jsxs("span",{className:"flex items-center justify-center gap-2",children:[t.jsx(ne,{className:"w-5 h-5 animate-spin"}),"–°–æ–∑–¥–∞–Ω–∏–µ..."]}):"–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É"})})]})},J=class J{constructor(){y(this,"fcmToken",null);y(this,"isInitialized",!1)}static getInstance(){return J.instance||(J.instance=new J),J.instance}isSupported(){return"serviceWorker"in navigator&&"PushManager"in window}async initialize(){if(this.isInitialized){console.log("[FCM] Already initialized");return}if(!this.isSupported()){console.warn("[FCM] Not supported in this browser");return}console.warn("[FCM] Firebase not installed. Install with: npm install firebase"),console.warn("[FCM] Then uncomment Firebase imports in fcmService.ts")}async requestPermissionAndGetToken(){return console.warn("[FCM] Firebase not installed. Install with: npm install firebase"),null}async registerToken(){if(!this.fcmToken){console.warn("[FCM] No token to register");return}try{const e=this.getDeviceInfo();await E.post("/api/notifications/register-token",{token:this.fcmToken,deviceInfo:e}),console.log("[FCM] Token registered with backend")}catch(e){throw console.error("[FCM] Failed to register token:",e),e}}getDeviceInfo(){const e=this.getBrowserName(),a=this.getOSName();return`${e} on ${a}`}getBrowserName(){const e=navigator.userAgent;return e.includes("Firefox")?"Firefox":e.includes("Edg")?"Edge":e.includes("Chrome")?"Chrome":e.includes("Safari")?"Safari":"Unknown Browser"}getOSName(){const e=navigator.userAgent;return e.includes("Win")?"Windows":e.includes("Mac")?"macOS":e.includes("Linux")?"Linux":e.includes("Android")?"Android":e.includes("iOS")?"iOS":"Unknown OS"}setOnMessageCallback(e){console.warn("[FCM] Firebase not installed. setOnMessageCallback disabled.")}getToken(){return this.fcmToken}async deactivateToken(){if(this.fcmToken)try{await E.post("/api/notifications/deactivate-token",{token:this.fcmToken}),console.log("[FCM] Token deactivated"),this.fcmToken=null}catch(e){console.error("[FCM] Failed to deactivate token:",e)}}};y(J,"instance");let Me=J;const oe=Me.getInstance();function cs(){const{token:s,loadUserProfile:e}=B(),{loadChats:a,selectChat:n}=_();h.useEffect(()=>{s&&e()},[]),h.useEffect(()=>{s?(r(),i()):Ie.dispose(),"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("message",l=>{if(l.data&&l.data.type==="OPEN_CHAT"){const d=l.data.chatId;d&&(console.log("[App] Opening chat from notification:",d),n(d),window.location.href=`/web/?chat=${d}`)}});const c=new URLSearchParams(window.location.search).get("chat");c&&s&&a().then(()=>{n(c)})},[s]);const r=async()=>{if(s)try{await Ie.initialize(s),console.log("[App] Services initialized")}catch(o){console.error("[App] Services initialization failed:",o)}},i=async()=>{try{if(await de.requestPermission()==="granted"){if(console.log("[App] Notification permission granted"),oe.isSupported())try{await oe.initialize(),await oe.requestPermissionAndGetToken()&&(await oe.registerToken(),console.log("[App] FCM initialized and token registered")),oe.setOnMessageCallback(d=>{var x,C,w,N,f;console.log("[App] FCM foreground message:",d);const g=((x=d.data)==null?void 0:x.title)||((C=d.notification)==null?void 0:C.title)||"New Message",m=((w=d.data)==null?void 0:w.body)||((N=d.notification)==null?void 0:N.body)||"",u=((f=d.data)==null?void 0:f.chatId)||"";de.showMessageNotification(g,m,u,()=>{u&&n(u)})})}catch(l){console.error("[App] FCM initialization failed:",l)}const c=P.onMessage(l=>{const d=localStorage.getItem("userId");l.senderId!==d&&de.showMessageNotification(`Message from ${l.senderName}`,l.type===L.Text?l.content||"":"üé§ Voice message",l.chatId,()=>{n(l.chatId)})});return()=>{c()}}}catch(o){console.error("[App] Notification initialization failed:",o)}};return t.jsx($e,{basename:"/web",children:t.jsxs(qe,{children:[t.jsx(V,{path:"/login",element:s?t.jsx(Q,{to:"/",replace:!0}):t.jsx(Tt,{})}),t.jsx(V,{path:"/register",element:s?t.jsx(Q,{to:"/",replace:!0}):t.jsx(At,{})}),t.jsx(V,{path:"/",element:s?t.jsx(Zt,{}):t.jsx(Q,{to:"/login",replace:!0})}),t.jsx(V,{path:"/settings",element:s?t.jsx(as,{}):t.jsx(Q,{to:"/login",replace:!0})}),t.jsx(V,{path:"/search",element:s?t.jsx(rs,{}):t.jsx(Q,{to:"/login",replace:!0})}),t.jsx(V,{path:"/new-chat",element:s?t.jsx(is,{}):t.jsx(Q,{to:"/login",replace:!0})}),t.jsx(V,{path:"/create-group",element:s?t.jsx(os,{}):t.jsx(Q,{to:"/login",replace:!0})})]})})}"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js",{scope:"/"}).then(s=>{console.log("[SW] Service Worker registered:",s.scope),setInterval(()=>{s.update()},6e4)}).catch(s=>{console.error("[SW] Service Worker registration failed:",s)})});Se.createRoot(document.getElementById("root")).render(t.jsx(ze.StrictMode,{children:t.jsx(cs,{})}));
