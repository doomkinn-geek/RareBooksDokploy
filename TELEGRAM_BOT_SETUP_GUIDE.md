# Руководство по настройке Telegram бота для RareBooksService

## Обзор изменений

Была реализована полная интеграция телеграм-бота с системой уведомлений о редких книгах. Теперь пользователи могут:

1. Автоматически привязывать свои аккаунты через безопасные токены
2. Управлять настройками уведомлений через бота
3. Получать уведомления о новых интересных книгах в Telegram

## Добавленные компоненты

### Backend (RareBooksService.WebApi)

1. **TelegramLinkService** - сервис для управления токенами привязки
2. **TelegramLinkToken** - модель для одноразовых токенов
3. Обновленный **TelegramBotService** с поддержкой команды `/link`
4. Новый эндпоинт `/api/notification/telegram/generate-link-token`
5. Миграция базы данных для таблицы токенов

### Frontend (rarebooksservice.frontend.v3)

1. Обновленный **NotificationSettings.jsx** с новым интерфейсом привязки
2. Пошаговый процесс привязки через токены
3. Улучшенный UX для подключения Telegram

### Консольное приложение (TelegramBotManager)

1. Демонстрационный бот для тестирования
2. Обработка основных команд
3. Простая настройка через appsettings.json

## Настройка

### 1. Конфигурация Backend

Добавьте в `appsettings.json` секцию для телеграм-бота:

```json
{
  "TelegramBot": {
    "Token": "YOUR_BOT_TOKEN_HERE"
  }
}
```

### 2. Настройка Webhook (для production)

Для работы бота в production необходимо настроить webhook:

```bash
# Через админский API
POST /api/admin/telegram/webhook/setup
{
  "baseUrl": "https://your-domain.com"
}
```

### 3. База данных

Выполните миграцию для добавления таблицы токенов:

```bash
dotnet ef database update
```

## Процесс привязки пользователей

### Старый способ (ручной)
1. Пользователь получает свой Telegram ID
2. Вводит его в форме на сайте
3. Администратор вручную проверяет и подтверждает

### Новый способ (автоматический)
1. Пользователь заходит в раздел "Уведомления" на сайте
2. Нажимает "Привязать Telegram"
3. Система генерирует одноразовый токен (действует 24 часа)
4. Пользователь копирует токен
5. В Telegram отправляет боту команду `/link ТОКЕН`
6. Бот автоматически привязывает аккаунт
7. Пользователь обновляет страницу и видит новый статус

## Команды бота

- `/start` - Приветствие и получение Telegram ID
- `/help` - Справка по командам
- `/link` - Инструкции по привязке
- `/link ТОКЕН` - Привязка аккаунта с токеном
- `/settings` - Управление настройками уведомлений
- `/list` - Просмотр текущих настроек
- `/cancel` - Отмена текущей операции

## Тестирование

### 1. Тестирование консольного приложения

```bash
cd TelegramBotManager
# Отредактируйте appsettings.json с вашим токеном
dotnet run
```

### 2. Тестирование интеграции

1. Запустите RareBooksService.WebApi
2. Зайдите в раздел "Уведомления" на frontend
3. Попробуйте привязать Telegram через новый интерфейс
4. Проверьте работу команд бота

### 3. Проверка webhook

```bash
# Проверка статуса бота
GET /api/telegram/status

# Отправка тестового сообщения
POST /api/telegram/test-message
{
  "chatId": "YOUR_CHAT_ID",
  "message": "Тестовое сообщение"
}
```

## Безопасность

1. **Токены привязки**:
   - Одноразовые (нельзя использовать повторно)
   - Ограниченное время жизни (24 часа)
   - Автоматическая очистка устаревших токенов

2. **Проверки**:
   - Один Telegram аккаунт = один пользователь сайта
   - Валидация токенов на стороне сервера
   - Логирование всех операций привязки

## Мониторинг

1. **Логи** - все операции логируются через NLog
2. **База данных** - история токенов хранится для аудита
3. **API эндпоинты** - для мониторинга статуса бота

## Возможные проблемы

### Бот не отвечает
- Проверьте токен в конфигурации
- Убедитесь, что webhook настроен правильно
- Проверьте логи приложения

### Токен не работает
- Проверьте, не истек ли срок действия (24 часа)
- Убедитесь, что токен не был использован ранее
- Проверьте правильность ввода команды `/link ТОКЕН`

### Ошибки привязки
- Проверьте, что Telegram ID не привязан к другому аккаунту
- Убедитесь, что пользователь авторизован на сайте
- Проверьте подключение к базе данных

## Развитие

### Планируемые улучшения
1. Поддержка inline кнопок для управления настройками
2. Более детальная настройка критериев через бота
3. Статистика по уведомлениям
4. Групповые настройки уведомлений

### Расширение функционала
1. Добавление новых команд бота
2. Интеграция с другими мессенджерами
3. Push-уведомления для мобильных приложений

## Поддержка

При возникновении проблем:
1. Проверьте логи приложения
2. Убедитесь в правильности конфигурации
3. Проверьте состояние webhook
4. Обратитесь к разработчикам с подробным описанием проблемы
