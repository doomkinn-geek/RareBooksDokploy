# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ iOS Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Backend

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

**–°–∏–º–ø—Ç–æ–º—ã:**
- ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏–∑ Firebase Console –ø—Ä–∏—Ö–æ–¥—è—Ç –Ω–∞ iOS
- ‚ùå –†–µ–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å backend –ù–ï –ø—Ä–∏—Ö–æ–¥—è—Ç –Ω–∞ iOS
- ‚úÖ –ù–∞ Android –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ü—Ä–∏—á–∏–Ω–∞:**

Backend –æ—Ç–ø—Ä–∞–≤–ª—è–ª **—Ç–æ–ª—å–∫–æ Data Message** –±–µ–∑ Notification payload –∏ **–±–µ–∑ APNs –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**:

```csharp
var message = new Message
{
    Token = fcmToken,
    Data = messageData,           // –¢–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ
    Android = new AndroidConfig   // –¢–æ–ª—å–∫–æ Android!
    {
        Priority = Priority.High,
    }
    // ‚ùå –ù–ï–¢ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è iOS!
};
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ iOS:**
- iOS —Ç—Ä–µ–±—É–µ—Ç –ª–∏–±–æ `Notification` payload, –ª–∏–±–æ APNs –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –ø–æ–∫–∞–∑–∞ –±–∞–Ω–Ω–µ—Ä–æ–≤
- Data-only messages –Ω–∞ iOS –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∫–∞–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- –ë–µ–∑ APNs –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ iOS –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

–î–æ–±–∞–≤–ª–µ–Ω–∞ APNs –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ `FirebaseService.cs`:

```csharp
var message = new Message
{
    Token = fcmToken,
    
    // ‚úÖ Notification payload –¥–ª—è –ø–æ–∫–∞–∑–∞ –±–∞–Ω–Ω–µ—Ä–∞ –Ω–∞ iOS
    Notification = new FirebaseAdmin.Messaging.Notification
    {
        Title = title,
        Body = body
    },
    
    // Data payload –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
    Data = messageData,
    
    // Android –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    Android = new AndroidConfig
    {
        Priority = Priority.High,
    },
    
    // ‚úÖ APNs –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è iOS
    Apns = new ApnsConfig
    {
        Headers = new Dictionary<string, string>
        {
            { "apns-priority", "10" } // –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
        },
        Aps = new Aps
        {
            Alert = new ApsAlert
            {
                Title = title,
                Body = body
            },
            Sound = "default",         // –ó–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            Badge = 1,                 // –ë–µ–π–¥–∂ –Ω–∞ –∏–∫–æ–Ω–∫–µ
            ContentAvailable = true,   // –§–æ–Ω–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
            MutableContent = true      // Notification Service Extension
        }
    }
};
```

---

## üìù –ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ

### –§–∞–π–ª: `MayMessenger.Application/Services/FirebaseService.cs`

#### 1. –ú–µ—Ç–æ–¥ `SendNotificationAsync` (—Å—Ç—Ä–æ–∫–∏ 83-120)

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ `Notification` payload —Å title –∏ body
- ‚úÖ `Apns` –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å –ø–æ–ª–Ω—ã–º `Aps` –æ–±—ä–µ–∫—Ç–æ–º
- ‚úÖ `ContentAvailable = true` –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- ‚úÖ `MutableContent = true` –¥–ª—è Notification Service Extension
- ‚úÖ `Sound = "default"` –¥–ª—è –∑–≤—É–∫–∞
- ‚úÖ `Badge = 1` –¥–ª—è –±–µ–π–¥–∂–∞ –Ω–∞ –∏–∫–æ–Ω–∫–µ
- ‚úÖ `apns-priority = "10"` –¥–ª—è –≤—ã—Å–æ–∫–æ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞

#### 2. –ú–µ—Ç–æ–¥ `SendToMultipleAsync` (—Å—Ç—Ä–æ–∫–∏ 176-217)

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ –¢–µ –∂–µ —Å–∞–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è multicast —Å–æ–æ–±—â–µ–Ω–∏–π

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

–¢–µ–ø–µ—Ä—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç **–æ–¥–∏–Ω–∞–∫–æ–≤–æ** –Ω–∞ iOS –∏ Android:

| –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ | –ë–∞–Ω–Ω–µ—Ä | –ó–≤—É–∫ | –ë–µ–π–¥–∂ | –§–æ–Ω–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ | Data payload |
|-----------|--------|------|-------|-------------------|--------------|
| Android   | ‚úÖ –î–∞  | ‚úÖ –î–∞ | ‚úÖ –î–∞ | ‚úÖ –î–∞             | ‚úÖ –î–∞        |
| iOS       | ‚úÖ **–î–∞** | ‚úÖ **–î–∞** | ‚úÖ **–î–∞** | ‚úÖ **–î–∞** | ‚úÖ –î–∞ |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ backend

```bash
cd /Users/janaplett/RareBooksDokploy/_may_messenger_backend

# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞
dotnet build

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ (–µ—Å–ª–∏ —á–µ—Ä–µ–∑ Docker)
docker-compose restart
```

### 2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å Android –Ω–∞ iPhone

1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ Android
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å iPhone
3. **iPhone –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ!** üì±

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ —Ä–∞–∑–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö

- ‚úÖ iPhone –æ—Ç–∫—Ä—ã—Ç - –±–∞–Ω–Ω–µ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è
- ‚úÖ iPhone —Å–≤—ë—Ä–Ω—É—Ç - –±–∞–Ω–Ω–µ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è
- ‚úÖ iPhone –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–∫—Ä—ã—Ç (force quit) - –±–∞–Ω–Ω–µ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è
- ‚úÖ iPhone –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω - –±–∞–Ω–Ω–µ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è

---

## üìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ FCM —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è iOS

```json
{
  "message": {
    "token": "FCM_TOKEN",
    
    "notification": {
      "title": "–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",
      "body": "–¢–µ–∫—Å—Ç"
    },
    
    "data": {
      "chatId": "123",
      "messageId": "456",
      "type": "text"
    },
    
    "apns": {
      "headers": {
        "apns-priority": "10"
      },
      "payload": {
        "aps": {
          "alert": {
            "title": "–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",
            "body": "–¢–µ–∫—Å—Ç"
          },
          "sound": "default",
          "badge": 1,
          "content-available": 1,
          "mutable-content": 1
        }
      }
    }
  }
}
```

### –ö–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è iOS

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|----------|------------|
| `notification` | –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–∞–Ω–Ω–µ—Ä –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ |
| `apns.payload.aps.alert` | –¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è |
| `apns.payload.aps.sound` | –ó–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è |
| `apns.payload.aps.badge` | –°—á—ë—Ç—á–∏–∫ –Ω–∞ –∏–∫–æ–Ω–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è |
| `apns.payload.aps.content-available` | –†–∞–∑—Ä–µ—à–∞–µ—Ç —Ñ–æ–Ω–æ–≤—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É |
| `apns.payload.aps.mutable-content` | –†–∞–∑—Ä–µ—à–∞–µ—Ç Notification Service Extension |
| `apns.headers.apns-priority` | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–æ—Å—Ç–∞–≤–∫–∏ (10 = –≤—ã—Å–æ–∫–∏–π) |
| `data` | –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è |

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

### –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É Android –∏ iOS

**Android:**
- –ú–æ–∂–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ —Å `data` payload
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç data-only messages –¥–∞–∂–µ –∫–æ–≥–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**iOS:**
- –¢—Ä–µ–±—É–µ—Ç `notification` payload –∏–ª–∏ APNs –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –ø–æ–∫–∞–∑–∞ –±–∞–Ω–Ω–µ—Ä–æ–≤
- Data-only messages –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∫–∞–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- –¢—Ä–µ–±—É–µ—Ç APNs –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã
- `content-available` –Ω—É–∂–µ–Ω –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

---

## üîç –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ backend

–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ backend:

```bash
# –ï—Å–ª–∏ —á–µ—Ä–µ–∑ Docker
docker-compose logs -f --tail=100

# –ò–ª–∏ –ø—Ä—è–º–æ –≤ –∫–æ–Ω—Å–æ–ª–∏
dotnet run
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```
Successfully sent FCM message: projects/maymessenger-3fdf0/messages/...
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ iOS

–í Xcode –∫–æ–Ω—Å–æ–ª–∏ (–µ—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ):
```
üì• Remote notification received (background/silent)
   State: 0 (–∏–ª–∏ –¥—Ä—É–≥–æ–µ —á–∏—Å–ª–æ)
   UserInfo: {...}
‚úÖ Background notification processed: 0
```

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **Firebase Cloud Messaging - iOS:** https://firebase.google.com/docs/cloud-messaging/ios/client
- **APNs Payload:** https://developer.apple.com/documentation/usernotifications/setting_up_a_remote_notification_server/generating_a_remote_notification
- **FirebaseAdmin .NET SDK:** https://firebase.google.com/docs/admin/setup

---

## ‚úÖ –ò—Ç–æ–≥

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚ùå iOS –Ω–µ –ø–æ–ª—É—á–∞–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç backend
- ‚úÖ Android —Ä–∞–±–æ—Ç–∞–ª –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- ‚ùå Data-only messages –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏—Å—å –Ω–∞ iOS

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚úÖ iOS –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç backend
- ‚úÖ Android –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –Ω–∞ –≤—Å–µ—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö
- ‚úÖ –§–æ–Ω–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –æ–±–µ–∏—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 14 —è–Ω–≤–∞—Ä—è 2026  
**–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:** `MayMessenger.Application/Services/FirebaseService.cs`  
**–ú–µ—Ç–æ–¥—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:** `SendNotificationAsync`, `SendToMultipleAsync`
