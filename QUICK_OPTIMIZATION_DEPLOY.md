# ‚ö° –ë—ã—Å—Ç—Ä–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–±–æ—Ä–∫–∏

## üéØ –î–ª—è Ubuntu —Å–µ—Ä–≤–µ—Ä–∞ (Production)

### –®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä

```bash
# –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ
scp build-optimized.sh setup-docker-optimization.sh .env.docker root@YOUR_SERVER:/–ø—É—Ç—å/–∫/–ø—Ä–æ–µ–∫—Ç—É/
scp RareBooksService.WebApi/Dockerfile root@YOUR_SERVER:/–ø—É—Ç—å/–∫/–ø—Ä–æ–µ–∫—Ç—É/RareBooksService.WebApi/
scp RareBooksService.WebApi/.dockerignore root@YOUR_SERVER:/–ø—É—Ç—å/–∫/–ø—Ä–æ–µ–∫—Ç—É/RareBooksService.WebApi/
scp rarebooksservice.frontend.v3/Dockerfile root@YOUR_SERVER:/–ø—É—Ç—å/–∫/–ø—Ä–æ–µ–∫—Ç—É/rarebooksservice.frontend.v3/
scp rarebooksservice.frontend.v3/.dockerignore root@YOUR_SERVER:/–ø—É—Ç—å/–∫/–ø—Ä–æ–µ–∫—Ç—É/rarebooksservice.frontend.v3/
scp docker-compose.yml root@YOUR_SERVER:/–ø—É—Ç—å/–∫/–ø—Ä–æ–µ–∫—Ç—É/
```

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Docker –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–æ–¥–∏–Ω —Ä–∞–∑)

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
cd /–ø—É—Ç—å/–∫/–ø—Ä–æ–µ–∫—Ç—É
chmod +x setup-docker-optimization.sh
sudo ./setup-docker-optimization.sh

# –ü–µ—Ä–µ–ª–æ–≥–∏–Ω—å—Ç–µ—Å—å –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
source ~/.bashrc
```

### –®–∞–≥ 3: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–±–æ—Ä–∫—É

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker compose down

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–±–æ—Ä–∫—É
chmod +x build-optimized.sh
./build-optimized.sh

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker compose up -d
```

---

## üñ•Ô∏è –î–ª—è Windows (—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞/—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)

### –®–∞–≥ 1: –í–∫–ª—é—á–∏—Ç–µ BuildKit

–°–æ–∑–¥–∞–π—Ç–µ/–æ–±–Ω–æ–≤–∏—Ç–µ `%USERPROFILE%\.docker\daemon.json`:

```json
{
  "features": {
    "buildkit": true
  }
}
```

–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Docker Desktop.

### –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–í PowerShell (–∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ –ø—Ä–æ—Ñ–∏–ª—å PowerShell):

```powershell
$env:DOCKER_BUILDKIT=1
$env:COMPOSE_DOCKER_CLI_BUILD=1
```

### –®–∞–≥ 3: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–±–æ—Ä–∫—É

```powershell
# PowerShell
docker compose build --parallel
docker compose up -d
```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ä–µ–º—è —Å–±–æ—Ä–∫–∏:

```bash
# –ü–æ–ª–Ω–∞—è —Å–±–æ—Ä–∫–∞ –±–µ–∑ –∫–µ—à–∞
time docker compose build --no-cache --progress=plain

# –°–±–æ—Ä–∫–∞ —Å –∫–µ—à–µ–º (–ø–æ–≤—Ç–æ—Ä–Ω–∞—è)
time docker compose build --progress=plain
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä –æ–±—Ä–∞–∑–æ–≤:

```bash
docker images | grep rarebooks
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞:

```bash
docker system df
```

### –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ —Å–±–æ—Ä–∫–∏:

```bash
docker compose build --progress=plain 2>&1 | tee build.log
```

---

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ï—Å–ª–∏ —Å–±–æ—Ä–∫–∞ –≤—Å–µ –µ—â–µ –º–µ–¥–ª–µ–Ω–Ω–∞—è:

#### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ BuildKit:
```bash
docker buildx version
# –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–µ—Ä—Å–∏—è >= 0.8.0
```

#### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:
```bash
# –í –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
du -sh . | head -1

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å < 200MB
# –ï—Å–ª–∏ –±–æ–ª—å—à–µ - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ .dockerignore
```

#### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–µ—à–∞:
```bash
docker compose build --progress=plain 2>&1 | grep CACHED | wc -l
# –ß–µ–º –±–æ–ª—å—à–µ CACHED —Å—Ç—Ä–æ–∫, —Ç–µ–º –ª—É—á—à–µ
```

#### 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ç–µ–≤—É—é —Å–∫–æ—Ä–æ—Å—Ç—å (–¥–ª—è pull):
```bash
docker pull mcr.microsoft.com/dotnet/sdk:8.0
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –±—ã—Å—Ç—Ä–æ
```

#### 5. –û—á–∏—Å—Ç–∏—Ç–µ —Å—Ç–∞—Ä—ã–π –∫–µ—à:
```bash
docker builder prune -af
docker system prune -af --volumes
```

---

## üéì –ü–æ–Ω–∏–º–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π

### Backend (–≤—Ä–µ–º—è —Å–±–æ—Ä–∫–∏: ~2-3 –º–∏–Ω –≤–º–µ—Å—Ç–æ 5-10 –º–∏–Ω)

**–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:**
1. ‚úÖ –ö–æ–ø–∏—Ä—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–∞–ø–∫–∏ (–Ω–µ –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç)
2. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `--no-restore` –ø—Ä–∏ publish
3. ‚úÖ –í–∫–ª—é—á–µ–Ω `PublishReadyToRun` –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
4. ‚úÖ –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π `.dockerignore` –∏—Å–∫–ª—é—á–∞–µ—Ç frontend –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

**–ü–æ—á–µ–º—É —ç—Ç–æ –±—ã—Å—Ç—Ä–µ–µ:**
- –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–±–æ—Ä–∫–∏ —É–º–µ–Ω—å—à–µ–Ω —Å ~500MB –¥–æ ~50MB
- Docker –∫–µ—à–∏—Ä—É–µ—Ç —Å–ª–æ–π restore (–µ—Å–ª–∏ .csproj –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å)
- ReadyToRun —Å–æ–∑–¥–∞–µ—Ç –ø—Ä–µ–¥–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥

### Frontend (–≤—Ä–µ–º—è —Å–±–æ—Ä–∫–∏: ~1-2 –º–∏–Ω –≤–º–µ—Å—Ç–æ 3-5 –º–∏–Ω)

**–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:**
1. ‚úÖ `npm ci` –≤–º–µ—Å—Ç–æ `npm install` (–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞)
2. ‚úÖ `--prefer-offline` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–µ—à npm
3. ‚úÖ –£–¥–∞–ª–µ–Ω–∞ –¥—É–±–ª–∏—Ä—É—é—â–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–∞
4. ‚úÖ `.dockerignore` –∏—Å–∫–ª—é—á–∞–µ—Ç node_modules –∏ dist

**–ü–æ—á–µ–º—É —ç—Ç–æ –±—ã—Å—Ç—Ä–µ–µ:**
- `npm ci` –±—ã—Å—Ç—Ä–µ–µ –Ω–∞ 30-50%
- Docker –∫–µ—à–∏—Ä—É–µ—Ç —Å–ª–æ–π —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏
- –ú–µ–Ω—å—à–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–±–æ—Ä–∫–∏

### Docker Compose

**–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:**
1. ‚úÖ BuildKit –≤–∫–ª—é—á–µ–Ω
2. ‚úÖ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ–µ–≤ –º–µ–∂–¥—É —Å–±–æ—Ä–∫–∞–º–∏
3. ‚úÖ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤
4. ‚úÖ Inline cache –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

**–ü–æ—á–µ–º—É —ç—Ç–æ –±—ã—Å—Ç—Ä–µ–µ:**
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ backend + frontend
- –ö–µ—à –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–µ–∂–¥—É —Å–±–æ—Ä–∫–∞–º–∏
- –¢–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Å–ª–æ–∏ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞—é—Ç—Å—è

---

## üìà –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

| –°—Ü–µ–Ω–∞—Ä–∏–π | –ë—ã–ª–æ | –°—Ç–∞–ª–æ | –£–ª—É—á—à–µ–Ω–∏–µ |
|----------|------|-------|-----------|
| **–ü–µ—Ä–≤–∞—è —Å–±–æ—Ä–∫–∞** | 8-15 –º–∏–Ω | 3-5 –º–∏–Ω | 60-70% |
| **–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ** | 5-8 –º–∏–Ω | 1-2 –º–∏–Ω | 75-80% |
| **–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π** | 3-5 –º–∏–Ω | 30-60 —Å–µ–∫ | 90%+ |
| **–†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞** | ~500 MB | ~100 MB | 80% |

---

## üéâ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π –≤—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:

1. ‚úÖ –ú–Ω–æ–≥–æ —Å—Ç—Ä–æ–∫ —Å `CACHED` –≤ –ª–æ–≥–∞—Ö —Å–±–æ—Ä–∫–∏
2. ‚úÖ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ backend –∏ frontend
3. ‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –∑–∞ 3-5 –º–∏–Ω—É—Ç (–ø–µ—Ä–≤—ã–π —Ä–∞–∑)
4. ‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è —Å–±–æ—Ä–∫–∞ –∑–∞ < 1 –º–∏–Ω—É—Ç—É

–ï—Å–ª–∏ —ç—Ç–æ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç - —Å–º. —Ä–∞–∑–¥–µ–ª "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º".

---

## üí° –°–æ–≤–µ—Ç—ã

1. **–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `build-optimized.sh`** –¥–ª—è —Å–±–æ—Ä–∫–∏
2. **–†–µ–≥—É–ª—è—Ä–Ω–æ –æ—á–∏—â–∞–π—Ç–µ Docker**: `docker system prune -af`
3. **–ù–µ –∏–∑–º–µ–Ω—è–π—Ç–µ .csproj –∏ package.json –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏** (—Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∫–µ—à)
4. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `.dockerignore` –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ**
5. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—Ä –æ–±—Ä–∞–∑–æ–≤**: `docker images`

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `DOCKER_OPTIMIZATION_GUIDE.md`
2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ –≤—ã—à–µ
3. –°–æ–±–µ—Ä–∏—Ç–µ –ª–æ–≥–∏: `docker compose build --progress=plain > build.log 2>&1`

