# ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–ê–Ø –ú–ò–ì–†–ê–¶–ò–Ø - –†–ï–®–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´ –ù–ê UBUNTU –°–ï–†–í–ï–†–ï

–î–∞—Ç–∞: 30 –Ω–æ—è–±—Ä—è 2025

## üêõ –ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Ubuntu —Å–µ—Ä–≤–µ—Ä–µ –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞:
```
RunMigrations(UsersDb) error: 42701: column "IsSold" of relation "UserCollectionBooks" already exists
```

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ —É–∂–µ –±—ã–ª–∞ —á–∞—Å—Ç–∏—á–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ —Å—Ç–∞—Ä–∞—è –º–∏–≥—Ä–∞—Ü–∏—è —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è `decimal` –ø–æ–ª–µ–π.

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. Idempotent –º–∏–≥—Ä–∞—Ü–∏—è

–û–±–Ω–æ–≤–ª–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è `20251130153129_AddSoldInfoToCollectionBooks.cs` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è **–±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ SQL** —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏:

```sql
DO $$ 
BEGIN
    IF NOT EXISTS (
        SELECT 1 
        FROM information_schema.columns 
        WHERE table_name = 'UserCollectionBooks' 
        AND column_name = 'IsSold'
    ) THEN
        ALTER TABLE "UserCollectionBooks" 
        ADD COLUMN "IsSold" boolean NOT NULL DEFAULT false;
    END IF;
END $$;
```

–ú–∏–≥—Ä–∞—Ü–∏—è —Ç–µ–ø–µ—Ä—å:
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö (numeric ‚Üí numeric(18,2))
- ‚úÖ –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ –±–µ–∑ –æ—à–∏–±–æ–∫

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

–û–±–Ω–æ–≤–ª–µ–Ω `Program.cs` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ:

```csharp
if (!setupService.IsInitialSetupNeeded)
{
    var migrationLogger = scope.ServiceProvider.GetRequiredService<ILogger<Program>>();
    
    try
    {
        migrationLogger.LogInformation("–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π BooksDb...");
        var booksDb = scope.ServiceProvider.GetRequiredService<BooksDbContext>();
        booksDb.Database.Migrate();
        migrationLogger.LogInformation("–ú–∏–≥—Ä–∞—Ü–∏–∏ BooksDb –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ");
    }
    catch (Exception ex)
    {
        migrationLogger.LogError(ex, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π BooksDb");
        // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –∑–∞–ø—É—Å–∫, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
    }

    try
    {
        migrationLogger.LogInformation("–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π UsersDb...");
        var usersDb = scope.ServiceProvider.GetRequiredService<UsersDbContext>();
        usersDb.Database.Migrate();
        migrationLogger.LogInformation("–ú–∏–≥—Ä–∞—Ü–∏–∏ UsersDb –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ");
    }
    catch (Exception ex)
    {
        migrationLogger.LogError(ex, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π UsersDb");
        // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –∑–∞–ø—É—Å–∫, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
    }
}
```

### 3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–¢–µ–ø–µ—Ä—å –≤ –ª–æ–≥–∞—Ö –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ:
```
INFO: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π BooksDb...
INFO: –ú–∏–≥—Ä–∞—Ü–∏–∏ BooksDb –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ
INFO: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π UsersDb...
INFO: –ú–∏–≥—Ä–∞—Ü–∏–∏ UsersDb –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ
```

---

## üîß –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

### –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç:

1. **PurchasePrice**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö
   - –û–±–Ω–æ–≤–ª—è–µ—Ç –¥–æ `numeric(18,2)` –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

2. **IsSold**
   - –î–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–ª–æ–Ω–∫—É –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `false`

3. **SoldDate**
   - –î–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–ª–æ–Ω–∫—É –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
   - –¢–∏–ø: `timestamp with time zone NULL`

4. **SoldPrice**
   - –î–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–ª–æ–Ω–∫—É –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
   - –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–∏–ø –¥–æ `numeric(18,2)` –µ—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∞ —É–∂–µ –µ—Å—Ç—å

---

## üöÄ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

### Docker Compose

1. **–°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞:**
```bash
docker-compose build backend
```

2. **–ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:**
```bash
docker-compose up -d
```

3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π:**
   - –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –º–∏–≥—Ä–∞—Ü–∏–∏
   - –ü—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
   - –õ–æ–≥–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ nlog
   - –û—à–∏–±–∫–∏ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

```bash
docker logs rarebooks-backend -f
```

–ò—â–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏:
```
INFO: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π UsersDb...
INFO: –ú–∏–≥—Ä–∞—Ü–∏–∏ UsersDb –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ
```

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –ë–î

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ —Ç–∞–±–ª–∏—Ü–∞ `UserCollectionBooks` –±—É–¥–µ—Ç –∏–º–µ—Ç—å:

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | Nullable | Default |
|---------|-----|----------|---------|
| PurchasePrice | numeric(18,2) | YES | NULL |
| PurchaseDate | timestamp with time zone | YES | NULL |
| **IsSold** | boolean | NO | false |
| **SoldPrice** | numeric(18,2) | YES | NULL |
| **SoldDate** | timestamp with time zone | YES | NULL |

---

## ‚öôÔ∏è –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –¥–ª—è Ubuntu/PostgreSQL

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏:
```sql
SELECT column_name, data_type, numeric_precision, numeric_scale
FROM information_schema.columns
WHERE table_name = 'UserCollectionBooks';
```

### –†—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ):
```sql
ALTER TABLE "UserCollectionBooks" 
ALTER COLUMN "PurchasePrice" TYPE numeric(18,2);

ALTER TABLE "UserCollectionBooks" 
ALTER COLUMN "SoldPrice" TYPE numeric(18,2);
```

---

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è

‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–µ —É–ø–∞–¥–µ—Ç –µ—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç  
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è:** –ù–µ –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã  
‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –í–∏–¥–Ω–æ —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ  
‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** –û—à–∏–±–∫–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç –∑–∞–ø—É—Å–∫  
‚úÖ **–ü–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç—å:** –†–∞–±–æ—Ç–∞–µ—Ç –∏ –Ω–∞ Windows, –∏ –Ω–∞ Linux

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏:

```bash
docker exec -it rarebooks-backend bash
cd /app
dotnet ef migrations list --context UsersDbContext
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã:

```bash
docker exec -it rarebooks-users-db psql -U postgres -d usersdb

\d "UserCollectionBooks"
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ:

```sql
SELECT "IsSold", "SoldPrice", "SoldDate" 
FROM "UserCollectionBooks" 
LIMIT 5;
```

---

## üìù –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —Å–∏—Å—Ç–µ–º–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞** (`!setupService.IsInitialSetupNeeded`)
2. **–û—à–∏–±–∫–∏ –º–∏–≥—Ä–∞—Ü–∏–π –ª–æ–≥–∏—Ä—É—é—Ç—Å—è** –Ω–æ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ** - –º–∏–≥—Ä–∞—Ü–∏—è idempotent
4. **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ—Ç–∫–∞—Ç** —á–µ—Ä–µ–∑ `dotnet ef database update <–ø—Ä–µ–¥—ã–¥—É—â–∞—è_–º–∏–≥—Ä–∞—Ü–∏—è>`

---

## ‚ú® –ì–æ—Ç–æ–≤–æ!

–¢–µ–ø–µ—Ä—å –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞ Ubuntu:
1. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –º–∏–≥—Ä–∞—Ü–∏–∏
2. ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –Ω–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
3. ‚úÖ –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å
4. ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–æ–µ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ

**–ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞! üéâ**

