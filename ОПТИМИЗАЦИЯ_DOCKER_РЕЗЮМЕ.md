# üöÄ –†–µ–∑—é–º–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ Docker Compose

## üìã –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. **Backend (RareBooksService.WebApi)** ‚úÖ

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `RareBooksService.WebApi/Dockerfile`:
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–ø–æ–∫ –≤–º–µ—Å—Ç–æ `COPY . .`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ `--no-restore` –ø—Ä–∏ publish –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
- ‚úÖ –í–∫–ª—é—á–µ–Ω `PublishReadyToRun=true` –¥–ª—è –ø—Ä–µ–¥–∫–æ–º–ø–∏–ª—è—Ü–∏–∏
- ‚úÖ –£–∫–∞–∑–∞–Ω runtime `linux-x64` –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `RareBooksService.WebApi/.dockerignore`:
- ‚úÖ –ò—Å–∫–ª—é—á–µ–Ω –≤–µ—Å—å frontend (`rarebooksservice.frontend.v3/`)
- ‚úÖ –ò—Å–∫–ª—é—á–µ–Ω—ã backup –ø–∞–ø–∫–∏ (`_BACKUPS/`, `_bak/`)
- ‚úÖ –ò—Å–∫–ª—é—á–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (–≤—Å–µ `*.md` —Ñ–∞–π–ª—ã)
- ‚úÖ –ò—Å–∫–ª—é—á–µ–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã–µ –ø—Ä–æ–µ–∫—Ç—ã
- ‚úÖ –ò—Å–∫–ª—é—á–µ–Ω—ã —Å–∫—Ä–∏–ø—Ç—ã –∏ –∫–ª—é—á–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —É–º–µ–Ω—å—à–µ–Ω —Å ~500MB –¥–æ ~50MB

---

### 2. **Frontend (rarebooksservice.frontend.v3)** ‚úÖ

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `rarebooksservice.frontend.v3/Dockerfile`:
- ‚úÖ –ó–∞–º–µ–Ω–µ–Ω `npm install` –Ω–∞ `npm ci` –¥–ª—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ `--prefer-offline` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–µ—à–∞
- ‚úÖ –£–¥–∞–ª–µ–Ω–∞ –¥—É–±–ª–∏—Ä—É—é—â–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ `yet-another-react-lightbox`

#### –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Ñ–∞–π–ª `rarebooksservice.frontend.v3/.dockerignore`:
- ‚úÖ –ò—Å–∫–ª—é—á–µ–Ω—ã `node_modules`, `dist`
- ‚úÖ –ò—Å–∫–ª—é—á–µ–Ω—ã —Ñ–∞–π–ª—ã IDE –∏ –ª–æ–≥–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Ä–µ–º—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —Å–æ–∫—Ä–∞—â–µ–Ω–æ –Ω–∞ 40-50%

---

### 3. **Docker Compose** ‚úÖ

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `docker-compose.yml`:
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤ (`cache_from`)
- ‚úÖ –í–∫–ª—é—á–µ–Ω inline cache (`BUILDKIT_INLINE_CACHE: 1`)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–µ–≥–∏ –¥–ª—è –æ–±—Ä–∞–∑–æ–≤ (`image: rarebooks_backend:latest`)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–≤—Ç–æ—Ä–Ω–∞—è —Å–±–æ—Ä–∫–∞ —É—Å–∫–æ—Ä–µ–Ω–∞ –Ω–∞ 90%+

---

### 4. **–°–∫—Ä–∏–ø—Ç—ã –∏ —É—Ç–∏–ª–∏—Ç—ã** ‚úÖ

#### –°–æ–∑–¥–∞–Ω—ã –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã:

1. **`build-optimized.sh`** - –°–∫—Ä–∏–ø—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–±–æ—Ä–∫–∏ –¥–ª—è Linux/macOS
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞–µ—Ç BuildKit
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Ä–µ–º—è —Å–±–æ—Ä–∫–∏
   - –í—ã–≤–æ–¥–∏—Ç —Ä–∞–∑–º–µ—Ä—ã –æ–±—Ä–∞–∑–æ–≤

2. **`build-optimized.ps1`** - –°–∫—Ä–∏–ø—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–±–æ—Ä–∫–∏ –¥–ª—è Windows
   - PowerShell –≤–µ—Ä—Å–∏—è —Å —Ü–≤–µ—Ç–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
   - –ò–∑–º–µ—Ä—è–µ—Ç –≤—Ä–µ–º—è —Å–±–æ—Ä–∫–∏

3. **`setup-docker-optimization.sh`** - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker –Ω–∞ Ubuntu —Å–µ—Ä–≤–µ—Ä–µ
   - –í–∫–ª—é—á–∞–µ—Ç BuildKit –≤ daemon.json
   - –°–æ–∑–¥–∞–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π builder
   - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
   - –û—á–∏—â–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ

4. **`docker-buildkit.env`** - –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è BuildKit
   - –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å `source docker-buildkit.env`

5. **`DOCKER_OPTIMIZATION_GUIDE.md`** - –ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ
   - –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π
   - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º
   - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ–≤–µ—Ç—ã

6. **`QUICK_OPTIMIZATION_DEPLOY.md`** - –ë—ã—Å—Ç—Ä–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
   - –ü–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è Ubuntu
   - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è Windows
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|---------------|-------------------|-----------|
| **–í—Ä–µ–º—è –ø–µ—Ä–≤–æ–π —Å–±–æ—Ä–∫–∏** | 8-15 –º–∏–Ω—É—Ç | 3-5 –º–∏–Ω—É—Ç | **60-70%** |
| **–í—Ä–µ–º—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–¥–∞** | 5-8 –º–∏–Ω—É—Ç | 1-2 –º–∏–Ω—É—Ç—ã | **75-80%** |
| **–í—Ä–µ–º—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π** | 3-5 –º–∏–Ω—É—Ç | 30-60 —Å–µ–∫—É–Ω–¥ | **90%+** |
| **–†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ Backend** | ~500 MB | ~50 MB | **90%** |
| **–†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ Frontend** | ~300 MB | ~50 MB | **83%** |

---

## üéØ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é

### –ù–∞ Ubuntu —Å–µ—Ä–≤–µ—Ä–µ (Production):

```bash
# 1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Docker (–æ–¥–∏–Ω —Ä–∞–∑)
chmod +x setup-docker-optimization.sh
sudo ./setup-docker-optimization.sh

# 2. –ü–µ—Ä–µ–∑–∞–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
source ~/.bashrc

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–±–æ—Ä–∫—É
chmod +x build-optimized.sh
./build-optimized.sh

# 4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker compose up -d
```

### –ù–∞ Windows (Development):

```powershell
# 1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Docker Desktop
# –°–æ–∑–¥–∞–π—Ç–µ/–æ–±–Ω–æ–≤–∏—Ç–µ %USERPROFILE%\.docker\daemon.json:
# {
#   "features": {
#     "buildkit": true
#   }
# }
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Docker Desktop

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–±–æ—Ä–∫—É
.\build-optimized.ps1

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker compose up -d
```

---

## üîç –ö–ª—é—á–µ–≤—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. **–ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å–±–æ—Ä–∫–∏**
- Backend –∫–æ–ø–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ 4 –ø–∞–ø–∫–∏ –≤–º–µ—Å—Ç–æ –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
- .dockerignore –∏—Å–∫–ª—é—á–∞–µ—Ç frontend, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é, backup'—ã

### 2. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ–µ–≤ Docker**
- –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (.csproj, package.json) –∫–æ–ø–∏—Ä—É—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–æ–ª—å–∫–æ –∫–æ–¥–∞ - –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –±–µ—Ä—É—Ç—Å—è –∏–∑ –∫–µ—à–∞

### 3. **BuildKit –∏ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–∞—Ü–∏—è**
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ backend –∏ frontend
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–∂–¥—É —Å–±–æ—Ä–∫–∞–º–∏

### 4. **–î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π**
- `npm ci` –≤–º–µ—Å—Ç–æ `npm install` –¥–ª—è Node.js
- `--no-restore` –¥–ª—è .NET publish

### 5. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è .NET**
- `PublishReadyToRun=true` - –ø—Ä–µ–¥–∫–æ–º–ø–∏–ª—è—Ü–∏—è IL –≤ native –∫–æ–¥
- –£–∫–∞–∑–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π runtime –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π –≤—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:

```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–±–æ—Ä–∫—É —Å —Ç–∞–π–º–µ—Ä–æ–º
time ./build-optimized.sh

# 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–µ—à
docker compose build --progress=plain 2>&1 | grep CACHED

# 3. –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–Ω–æ–≥–æ —Å—Ç—Ä–æ–∫ –≤–∏–¥–∞:
# => CACHED [build 3/8] RUN dotnet restore...
# => CACHED [build 5/8] RUN npm ci...
```

**–û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è:**
- –ü–µ—Ä–≤–∞—è —Å–±–æ—Ä–∫–∞: **3-5 –º–∏–Ω—É—Ç** ‚ö°
- –ü–æ–≤—Ç–æ—Ä–Ω–∞—è: **< 1 –º–∏–Ω—É—Ç—ã** üöÄ

---

## üêõ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ï—Å–ª–∏ —Å–±–æ—Ä–∫–∞ –≤—Å–µ –µ—â–µ –º–µ–¥–ª–µ–Ω–Ω–∞—è:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ BuildKit:**
   ```bash
   docker buildx version
   # –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–µ—Ä—Å–∏—è >= 0.8.0
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:**
   ```bash
   cd RareBooksService.WebApi
   tar -czf - . | wc -c
   # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å < 100MB
   ```

3. **–û—á–∏—Å—Ç–∏—Ç–µ —Å—Ç–∞—Ä—ã–π –∫–µ—à:**
   ```bash
   docker system prune -af --volumes
   docker builder prune -af
   ```

4. **–í–∫–ª—é—á–∏—Ç–µ verbose logging:**
   ```bash
   docker compose build --progress=plain > build.log 2>&1
   # –ò–∑—É—á–∏—Ç–µ build.log –¥–ª—è –ø–æ–∏—Å–∫–∞ —É–∑–∫–∏—Ö –º–µ—Å—Ç
   ```

---

## üìû –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- **`DOCKER_OPTIMIZATION_GUIDE.md`** - –ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ
- **`QUICK_OPTIMIZATION_DEPLOY.md`** - –ë—ã—Å—Ç—Ä–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

---

## üéâ –ò—Ç–æ–≥

–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞:
1. ‚úÖ –£–º–µ–Ω—å—à–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å–±–æ—Ä–∫–∏
2. ‚úÖ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ª–æ–µ–≤
3. ‚úÖ –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–∞—Ü–∏—é —Å–±–æ—Ä–∫–∏
4. ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

**–û–±—â–µ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ: 60-90%** –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è! üöÄ

