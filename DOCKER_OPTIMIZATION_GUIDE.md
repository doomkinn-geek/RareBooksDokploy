# üöÄ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ Docker —Å–±–æ—Ä–∫–∏

## –ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:

### 1. **Backend (RareBooksService.WebApi)**
- ‚ùå **–ë—ã–ª–æ**: `COPY . .` –∫–æ–ø–∏—Ä–æ–≤–∞–ª –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç, –≤–∫–ª—é—á–∞—è frontend –∏ –ª–∏—à–Ω–∏–µ —Ñ–∞–π–ª—ã (~500MB+)
- ‚úÖ **–°—Ç–∞–ª–æ**: –ö–æ–ø–∏—Ä—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–∞–ø–∫–∏ backend (~50MB)
- ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–æ**: `--no-restore` –∏ `PublishReadyToRun` –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
- ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–æ**: –ë–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π `.dockerignore`

### 2. **Frontend (rarebooksservice.frontend.v3)**
- ‚ùå **–ë—ã–ª–æ**: `npm install` + –ø–æ–≤—Ç–æ—Ä–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–∞
- ‚úÖ **–°—Ç–∞–ª–æ**: `npm ci --prefer-offline` –¥–ª—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏ –±—ã—Å—Ç—Ä–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏
- ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–æ**: `.dockerignore` –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è node_modules –∏ dist

### 3. **Docker Compose**
- ‚ùå **–ë—ã–ª–æ**: –ù–µ—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π —Å–±–æ—Ä–∫–∏
- ‚úÖ **–°—Ç–∞–ª–æ**: –í–∫–ª—é—á–µ–Ω BuildKit, –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ–µ–≤, –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞

### 4. **.dockerignore**
- ‚úÖ **–£–ª—É—á—à–µ–Ω–æ**: –ò—Å–∫–ª—é—á–∞—é—Ç—Å—è frontend, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è, backup, —Ç–µ—Å—Ç—ã, —Å–∫—Ä–∏–ø—Ç—ã

---

## üìä –û–∂–∏–¥–∞–µ–º–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

| –≠—Ç–∞–ø | –ë—ã–ª–æ | –°—Ç–∞–ª–æ | –£–ª—É—á—à–µ–Ω–∏–µ |
|------|------|-------|-----------|
| Backend build | ~5-10 –º–∏–Ω | ~2-3 –º–∏–Ω | **60-70%** |
| Frontend build | ~3-5 –º–∏–Ω | ~1-2 –º–∏–Ω | **50-60%** |
| –ü–æ–≤—Ç–æ—Ä–Ω–∞—è —Å–±–æ—Ä–∫–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) | ~8-15 –º–∏–Ω | ~30-60 —Å–µ–∫ | **90%+** |
| –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ | ~500MB | ~50-100MB | **80%** |

---

## üéØ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç
```bash
chmod +x build-optimized.sh
./build-optimized.sh
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –í—Ä—É—á–Ω—É—é —Å BuildKit
```bash
export DOCKER_BUILDKIT=1
export COMPOSE_DOCKER_CLI_BUILD=1
docker compose build --parallel
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫
```bash
export DOCKER_BUILDKIT=1
export COMPOSE_DOCKER_CLI_BUILD=1
docker compose up -d --build --parallel
```

---

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

### 1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ multi-stage builds (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)
–û–±–∞ Dockerfile –∏—Å–ø–æ–ª—å–∑—É—é—Ç multi-stage builds –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–±—Ä–∞–∑–∞.

### 2. –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ NuGet –ø–∞–∫–µ—Ç–æ–≤ (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
```bash
# –°–æ–∑–¥–∞—Ç—å volume –¥–ª—è –∫–µ—à–∞ NuGet
docker volume create nuget-cache

# –î–æ–±–∞–≤–∏—Ç—å –≤ docker-compose.yml (–¥–ª—è development)
volumes:
  - nuget-cache:/root/.nuget/packages
```

### 3. –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ npm –ø–∞–∫–µ—Ç–æ–≤ (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
```bash
# –°–æ–∑–¥–∞—Ç—å volume –¥–ª—è –∫–µ—à–∞ npm
docker volume create npm-cache

# –î–æ–±–∞–≤–∏—Ç—å –≤ docker-compose.yml (–¥–ª—è development)
volumes:
  - npm-cache:/root/.npm
```

### 4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Docker registry –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
```bash
# Push –æ–±—Ä–∞–∑–æ–≤ –≤ registry –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ–∂–¥—É —Å–µ—Ä–≤–µ—Ä–∞–º–∏
docker compose build
docker compose push

# –ù–∞ –¥—Ä—É–≥–æ–º —Å–µ—Ä–≤–µ—Ä–µ
docker compose pull
docker compose up -d
```

---

## üêõ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –º–µ–¥–ª–µ–Ω–Ω–æ–π —Å–±–æ—Ä–∫–∏:

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ Docker:
```bash
# Backend
cd d:\_SOURCES\source\RareBooksServicePublic
tar -czf - . | wc -c

# Frontend
cd rarebooksservice.frontend.v3
tar -czf - . | wc -c
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ BuildKit –≤–∫–ª—é—á–µ–Ω:
```bash
docker buildx version
# –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–µ—Ä—Å–∏—è 0.8+
```

### –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ —Å–±–æ—Ä–∫–∏ —Å –≤—Ä–µ–º–µ–Ω–µ–º:
```bash
time docker compose build --progress=plain --no-cache
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–µ—à–∞:
```bash
docker compose build --progress=plain 2>&1 | grep "CACHED"
```

---

## ‚ö° –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–æ–º–µ–Ω—Ç—ã:

1. **–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ BuildKit** –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ Ubuntu:
   ```bash
   # –î–æ–±–∞–≤–∏—Ç—å –≤ /etc/docker/daemon.json
   {
     "features": {
       "buildkit": true
     }
   }
   
   # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Docker
   sudo systemctl restart docker
   ```

2. **–ù–µ –∫–æ–ø–∏—Ä—É–π—Ç–µ –ª–∏—à–Ω–∏–µ —Ñ–∞–π–ª—ã** –≤ Docker context

3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ .dockerignore** –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ

4. **–ö–µ—à–∏—Ä—É–π—Ç–µ —Å–ª–æ–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π** (package.json, .csproj) –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç –∫–æ–¥–∞

5. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞** —Å `--parallel` —Ñ–ª–∞–≥–æ–º

---

## üìù Checklist –¥–ª—è production:

- [x] BuildKit –≤–∫–ª—é—á–µ–Ω
- [x] .dockerignore –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [x] Multi-stage builds –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è
- [x] –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∫–µ—à–∏—Ä—É—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
- [x] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è npm ci –≤–º–µ—Å—Ç–æ npm install
- [x] –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞
- [x] –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- [x] ReadyToRun –¥–ª—è .NET

---

## üìû –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:

- [Docker BuildKit Documentation](https://docs.docker.com/build/buildkit/)
- [Docker Compose Build](https://docs.docker.com/compose/reference/build/)
- [.NET Docker Optimization](https://docs.microsoft.com/en-us/dotnet/core/docker/build-container)

