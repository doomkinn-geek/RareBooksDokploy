<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç Telegram API Endpoints</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; margin: 10px 0; max-height: 400px; overflow-y: auto; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
        input[type="text"] { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; width: 200px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß –¢–µ—Å—Ç Telegram API Endpoints</h1>
        
        <h2>–ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
        <p><strong>API Base URL:</strong> <span id="api-url">–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</span></p>
        <p><strong>–í—Ä–µ–º—è:</strong> <span id="current-time"></span></p>
        
        <h2>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ endpoints</h2>
        
        <div>
            <h3>1. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –±–æ—Ç–∞</h3>
            <button onclick="testDiagnostics()">–¢–µ—Å—Ç /api/telegramdiagnostics/full-check</button>
            <div id="diagnostics-result" class="result"></div>
        </div>
        
        <div>
            <h3>2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook</h3>
            <input type="text" id="webhook-url" placeholder="https://rare-books.ru" value="https://rare-books.ru">
            <button onclick="testSetupWebhook()">–¢–µ—Å—Ç /api/telegramdiagnostics/setup-webhook</button>
            <div id="webhook-result" class="result"></div>
        </div>
        
        <div>
            <h3>3. –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è</h3>
            <input type="text" id="chat-id" placeholder="Chat ID">
            <input type="text" id="test-message" placeholder="–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" value="üîß –¢–µ—Å—Ç">
            <button onclick="testSendMessage()">–¢–µ—Å—Ç /api/telegramdiagnostics/test-send</button>
            <div id="message-result" class="result"></div>
        </div>
        
        <div>
            <h3>4. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (—Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)</h3>
            <button onclick="testStatistics()">–¢–µ—Å—Ç /api/admin/telegram/statistics</button>
            <div id="statistics-result" class="result"></div>
        </div>
        
        <div>
            <h3>5. –ü—Ä–æ–≤–µ—Ä–∫–∞ CORS</h3>
            <button onclick="testCORS()">–¢–µ—Å—Ç CORS OPTIONS –∑–∞–ø—Ä–æ—Å–∞</button>
            <div id="cors-result" class="result"></div>
        </div>
    </div>

    <script>
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—ã–π URL API
        const getApiUrl = () => {
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            const port = window.location.port;
            
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                // –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
                return `${protocol}//${hostname}:${port || '80'}/api`;
            } else {
                // –ü—Ä–æ–¥–∞–∫—à–Ω
                return `${protocol}//${hostname}${port ? ':' + port : ''}/api`;
            }
        };
        
        const API_URL = getApiUrl();
        document.getElementById('api-url').textContent = API_URL;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
        setInterval(() => {
            document.getElementById('current-time').textContent = new Date().toLocaleString('ru-RU');
        }, 1000);
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function showResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.className = `result ${isError ? 'error' : 'success'}`;
            element.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
        
        // 1. –¢–µ—Å—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        async function testDiagnostics() {
            const resultElement = document.getElementById('diagnostics-result');
            resultElement.innerHTML = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';
            resultElement.className = 'result';
            
            try {
                console.log('–¢–µ—Å—Ç–∏—Ä—É–µ–º:', `${API_URL}/telegramdiagnostics/full-check`);
                const response = await fetch(`${API_URL}/telegramdiagnostics/full-check`);
                console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response);
                
                const responseData = {
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries()),
                    url: response.url
                };
                
                if (response.ok) {
                    const data = await response.json();
                    showResult('diagnostics-result', { response: responseData, data }, false);
                } else {
                    const text = await response.text();
                    showResult('diagnostics-result', { response: responseData, error: text }, true);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', error);
                showResult('diagnostics-result', { 
                    error: error.message,
                    stack: error.stack,
                    type: error.constructor.name 
                }, true);
            }
        }
        
        // 2. –¢–µ—Å—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ webhook
        async function testSetupWebhook() {
            const resultElement = document.getElementById('webhook-result');
            resultElement.innerHTML = '‚è≥ –ù–∞—Å—Ç—Ä–æ–π–∫–∞...';
            resultElement.className = 'result';
            
            const baseUrl = document.getElementById('webhook-url').value;
            
            try {
                const response = await fetch(`${API_URL}/telegramdiagnostics/setup-webhook`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ baseUrl })
                });
                
                const responseData = {
                    status: response.status,
                    statusText: response.statusText,
                    url: response.url
                };
                
                if (response.ok) {
                    const data = await response.json();
                    showResult('webhook-result', { response: responseData, data }, false);
                } else {
                    const text = await response.text();
                    showResult('webhook-result', { response: responseData, error: text }, true);
                }
            } catch (error) {
                showResult('webhook-result', { error: error.message }, true);
            }
        }
        
        // 3. –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function testSendMessage() {
            const resultElement = document.getElementById('message-result');
            resultElement.innerHTML = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';
            resultElement.className = 'result';
            
            const chatId = document.getElementById('chat-id').value;
            const message = document.getElementById('test-message').value;
            
            if (!chatId) {
                showResult('message-result', { error: '–í–≤–µ–¥–∏—Ç–µ Chat ID' }, true);
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/telegramdiagnostics/test-send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ chatId, message })
                });
                
                const responseData = {
                    status: response.status,
                    statusText: response.statusText
                };
                
                if (response.ok) {
                    const data = await response.json();
                    showResult('message-result', { response: responseData, data }, false);
                } else {
                    const text = await response.text();
                    showResult('message-result', { response: responseData, error: text }, true);
                }
            } catch (error) {
                showResult('message-result', { error: error.message }, true);
            }
        }
        
        // 4. –¢–µ—Å—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function testStatistics() {
            const resultElement = document.getElementById('statistics-result');
            resultElement.innerHTML = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...';
            resultElement.className = 'result';
            
            try {
                const response = await fetch(`${API_URL}/admin/telegram/statistics`);
                
                const responseData = {
                    status: response.status,
                    statusText: response.statusText
                };
                
                if (response.ok) {
                    const data = await response.json();
                    showResult('statistics-result', { response: responseData, data }, false);
                } else {
                    const text = await response.text();
                    showResult('statistics-result', { response: responseData, error: text }, true);
                }
            } catch (error) {
                showResult('statistics-result', { error: error.message }, true);
            }
        }
        
        // 5. –¢–µ—Å—Ç CORS
        async function testCORS() {
            const resultElement = document.getElementById('cors-result');
            resultElement.innerHTML = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ CORS...';
            resultElement.className = 'result';
            
            try {
                const response = await fetch(`${API_URL}/telegramdiagnostics/full-check`, {
                    method: 'OPTIONS'
                });
                
                const responseData = {
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries())
                };
                
                showResult('cors-result', responseData, response.status >= 400);
            } catch (error) {
                showResult('cors-result', { error: error.message }, true);
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            testDiagnostics();
        });
    </script>
</body>
</html>
