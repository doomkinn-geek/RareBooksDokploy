---
name: Исправление мессенджера
overview: Исправление ошибки загрузки чатов, переход на offline-first архитектуру с приоритетом HIVE кэша, добавление экрана статуса сообщений для групп (как в WhatsApp), исправление счётчика непрочитанных для групп и устранение ложных retry-статусов.
todos:
  - id: offline-first
    content: Реализовать offline-first архитектуру для загрузки чатов с приоритетом HIVE кэша
    status: completed
  - id: fix-retry-status
    content: Исправить ложный retry статус - обновлять статус сразу после успешного ответа API
    status: completed
    dependencies:
      - offline-first
  - id: fix-group-unread
    content: Исправить счётчик непрочитанных сообщений для групповых чатов
    status: completed
    dependencies:
      - offline-first
  - id: api-receipts
    content: Добавить API endpoint для получения delivery receipts сообщения
    status: completed
  - id: message-info-screen
    content: Создать экран информации о статусе сообщения для групп (как в WhatsApp)
    status: completed
    dependencies:
      - api-receipts
---

# План исправления May Messenger

## Анализ проблем

Из логов adb обнаружена ключевая ошибка:

```javascript
[SignalR] Manual reconnect failed: 401: Unauthorized
```

Это указывает на проблему с токеном авторизации, которая каскадирует на загрузку чатов.---

## 1. Исправление ошибки "Не удалось загрузить чаты"

**Причина:** При ошибке API (401/сетевая ошибка) система не показывает кэшированные данные из HIVE.**Решение:** Изменить [`chats_provider.dart`](c:\rarebooks\_may_messenger_mobile_app\lib\presentation\providers\chats_provider.dart) и [`chat_repository.dart`](c:\rarebooks\_may_messenger_mobile_app\lib\data\repositories\chat_repository.dart):

- В `loadChats()` сначала загружать данные из кэша HIVE и показывать их
- Запрос к API делать параллельно/в фоне
- При ошибке API не заменять кэшированные данные ошибкой, а показывать баннер "работа в offline режиме"

---

## 2. Переход на Offline-First архитектуру

**Изменения в [`chat_repository.dart`](c:\rarebooks\_may_messenger_mobile_app\lib\data\repositories\chat_repository.dart):**

```dart
Future<List<Chat>> getChats({bool forceRefresh = false}) async {
  // 1. Всегда сначала показывать кэш
  final cachedChats = await _localDataSource.getCachedChats();
  if (cachedChats != null && cachedChats.isNotEmpty && !forceRefresh) {
    // Запуск фоновой синхронизации
    _syncChatsInBackground();
    return cachedChats;
  }
  
  // 2. Попытка загрузки с сервера
  try {
    final serverChats = await _apiDataSource.getChats();
    await _localDataSource.cacheChats(serverChats);
    return serverChats;
  } catch (e) {
    // 3. При ошибке - вернуть кэш если есть
    if (cachedChats != null && cachedChats.isNotEmpty) {
      return cachedChats;
    }
    rethrow;
  }
}
```

---

## 3. Экран статуса сообщения для групп (как в WhatsApp)

**Создать новый экран:** `message_info_screen.dart`Показывать для каждого участника группы:

- Имя пользователя
- Статус доставки (delivered с временем)
- Статус прочтения (read с временем)
- Для аудио - статус прослушивания (played)

**Добавить API endpoint:** В [`MessagesController.cs`](c:\rarebooks\_may_messenger_backend\src\MayMessenger.API\Controllers\MessagesController.cs) добавить:

```csharp
[HttpGet("{messageId}/receipts")]
public async Task<ActionResult<List<DeliveryReceiptDto>>> GetMessageReceipts(Guid messageId)
```

**Добавить в mobile app:**

- Endpoint в [`api_datasource.dart`](c:\rarebooks\_may_messenger_mobile_app\lib\data\datasources\api_datasource.dart)
- Новый экран с виджетами для отображения информации

---

## 4. Исправление счётчика непрочитанных для групп

**Проблема:** Логика `clearUnreadCount` и `updateUnreadCountOnStatusUpdate` не учитывает специфику групповых чатов.**Решение в [`chats_provider.dart`](c:\rarebooks\_may_messenger_mobile_app\lib\presentation\providers\chats_provider.dart):**

```dart
void clearUnreadCount(String chatId) {
  _locallyReadChats.add(chatId);
  
  final index = state.chats.indexWhere((c) => c.id == chatId);
  if (index != -1) {
    final chat = state.chats[index];
    // Обнулить счётчик для любого типа чата
    final updatedChat = chat.copyWith(unreadCount: 0);
    // ... обновить состояние
    
    // Отправить серверу информацию о прочтении
    _syncUnreadCountToServer(chatId);
  }
}
```

Также добавить в [`messages_provider.dart`](c:\rarebooks\_may_messenger_mobile_app\lib\presentation\providers\messages_provider.dart) корректный вызов `markMessagesAsRead()` при открытии группового чата с отправкой batch-запроса на сервер.---

## 5. Исправление ложного статуса "retry"

**Причина:** Сообщение успешно отправлено на сервер, но локальный статус не обновляется из-за:

- Несовпадения `localId` и серверного `id`
- SignalR уведомление не доходит из-за 401 ошибки
- Логика `_handleStuckLocalMessage` помечает успешные сообщения как failed

**Решение в [`messages_provider.dart`](c:\rarebooks\_may_messenger_mobile_app\lib\presentation\providers\messages_provider.dart):**

1. При получении успешного ответа от API немедленно обновлять статус:
```dart
// После успешной отправки в _syncMessageToBackend:
final serverMessage = await _messageRepository.sendMessage(...);

// Немедленно обновить локальное сообщение
_registerIdMapping(localId, serverMessage.id);
final idx = _findMessageIndex(localId);
if (idx != -1) {
  final updated = state.messages[idx].copyWith(
    id: serverMessage.id,
    status: MessageStatus.sent,
    isLocalOnly: false,
  );
  // обновить state
}
```




2. Увеличить threshold для `_handleStuckLocalMessage` и проверять наличие сообщения на сервере перед пометкой как failed.
3. После получения 401 ошибки SignalR - принудительно выполнить refresh токена или перелогин.

---

## Порядок реализации

| # | Задача | Файлы |

|---|--------|-------|

| 1 | Offline-first для чатов | `chat_repository.dart`, `chats_provider.dart` |

| 2 | Исправить retry статус | `messages_provider.dart` |

| 3 | Исправить счётчик группы | `chats_provider.dart`, `messages_provider.dart` |

| 4 | API для receipts | `MessagesController.cs` |