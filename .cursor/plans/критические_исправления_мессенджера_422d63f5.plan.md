---
name: Критические исправления мессенджера
overview: "Первая итерация исправлений мессенджера: устранение критических проблем с подключением, ACK сообщений, PUSH-уведомлениями и кэшированием медиа. Остальные улучшения (proximity sensor, размер шрифта и т.д.) будут реализованы во второй итерации."
todos:
  - id: signalr-reconnect
    content: SignalR бесконечный reconnect с экспоненциальной задержкой
    status: completed
  - id: hive-recovery
    content: HIVE recovery при corruption с пересозданием box
    status: completed
  - id: ack-timeout
    content: Таймаут для сообщений в статусе sending (30-60 сек)
    status: completed
    dependencies:
      - hive-recovery
  - id: push-delivery
    content: Отметка сообщения как delivered при получении PUSH
    status: completed
    dependencies:
      - signalr-reconnect
  - id: push-cancel
    content: Отмена уведомлений при прочтении сообщений
    status: completed
    dependencies:
      - push-delivery
  - id: push-navigation
    content: Исправление навигации по нажатию на PUSH
    status: completed
  - id: notification-icon
    content: Создание и настройка иконки уведомления
    status: completed
  - id: cache-sent-media
    content: Кэширование отправленных аудио и изображений локально
    status: completed
  - id: contacts-mapping
    content: Загрузка имён из телефонной книги при запуске
    status: completed
  - id: offline-isMe
    content: Кэширование userId для определения isMe в offline
    status: completed
---

# Критические исправления May Messenger - Итерация 1

## Анализ проблем

На основе анализа кода выявлены следующие критические проблемы:

### 1. Зависший индикатор отправки (ACK)

**Проблема:** Сообщение зависает с вечным индикатором загрузки.**Причина:** В [`messages_provider.dart`](_may_messenger_mobile_app/lib/presentation/providers/messages_provider.dart) есть timeout 120 секунд для local-only сообщений, но для synced сообщений таймаут не реализован. Также polling интервал 5 секунд может быть слишком агрессивным.**Решение:**

- Добавить fallback-таймаут для сообщений в статусе `sending` после 30 секунд
- Улучшить обработку статуса `sent` vs `sending` после успешного API ответа
- Добавить retry механизм с экспоненциальной задержкой

### 2. SignalR отключение без переподключения

**Проблема:** Индикатор подключения красный и не переподключается.**Причина:** В [`signalr_service.dart`](_may_messenger_mobile_app/lib/data/datasources/signalr_service.dart) ограничено 5 попыток переподключения, после чего сервис сдаётся.**Решение:**

- Убрать жёсткий лимит на количество попыток
- Добавить бесконечный retry с увеличивающимися интервалами
- Реализовать reconnect по событию connectivity (когда интернет восстановился)
- Добавить кнопку ручного переподключения в UI

### 3. HIVE перестаёт работать

**Проблема:** Сообщения не попадают в локальную версию чата.**Причина:** В [`local_datasource.dart`](_may_messenger_mobile_app/lib/data/datasources/local_datasource.dart) нет обработки ошибок corruption Hive boxes.**Решение:**

- Добавить try-catch с recovery при открытии Hive boxes
- При ошибке Hive - очистить повреждённый box и пересоздать
- Добавить периодический flush для критических данных

### 4. Доставка сообщений и PUSH

**Проблема:** Сообщение не отмечается как "доставлено" при получении PUSH.**Причина:** Backend отправляет PUSH, но delivery receipt отправляется только через SignalR при получении сообщения.**Решение в backend:** В [`ChatHub.cs`](_may_messenger_backend/src/MayMessenger.API/Hubs/ChatHub.cs):

- При отправке PUSH сразу отмечать сообщение как `Delivered`
- Добавить API endpoint для подтверждения доставки PUSH

**Решение в mobile:**

- При получении PUSH в background - отправлять HTTP подтверждение доставки

### 5. PUSH открывает не тот чат

**Проблема:** По нажатию на PUSH открывается неправильный чат.**Причина:** В [`fcm_service.dart`](_may_messenger_mobile_app/lib/core/services/fcm_service.dart) chatId передаётся через notification payload, но при групповых уведомлениях (InboxStyle) payload может перезаписываться.**Решение:**

- Использовать уникальный notification ID для каждого чата (уже используется `chatId.hashCode`)
- При нажатии на grouped notification - переходить к последнему чату
- Добавить проверку что чат существует перед навигацией

### 6. Убирать PUSH при прочтении

**Проблема:** Уведомление не исчезает при прочтении сообщения.**Решение:** В [`messages_provider.dart`](_may_messenger_mobile_app/lib/presentation/providers/messages_provider.dart) при `markMessagesAsRead()` вызывать `notificationService.cancelNotificationsForChat(chatId)`.

### 7. Иконка PUSH - белый кружок

**Проблема:** Иконка уведомления отображается как белый круг.**Причина:** Android требует monochrome иконку с прозрачным фоном.**Решение:**

- Создать специальную notification icon (белый силуэт на прозрачном фоне)
- Разместить в `android/app/src/main/res/drawable/ic_notification.png`
- Обновить `AndroidInitializationSettings('@drawable/ic_notification')`

### 8. Кэширование отправленных аудио и изображений

**Проблема:** Отправленные аудио не кэшируются локально.**Причина:** В [`audio_storage_service.dart`](_may_messenger_mobile_app/lib/data/services/audio_storage_service.dart) сохраняются только полученные файлы.**Решение:**

- При отправке аудио/изображения - сохранять локально перед отправкой
- Связывать local path с messageId после успешной отправки
- Добавить фоновую загрузку для incoming сообщений

### 9. Имена из телефонной книги

**Проблема:** Отображается имя из регистрации, а не из контактов.**Причина:** В [`contacts_names_provider.dart`](_may_messenger_mobile_app/lib/presentation/providers/contacts_names_provider.dart) mapping работает, но не вызывается при получении сообщений.**Решение:**

- Вызывать `loadContactsMapping()` при запуске приложения
- Обновлять mapping при синхронизации контактов
- Использовать cached mapping в message_bubble.dart (уже реализовано)

### 10. Offline режим - структура сообщений

**Проблема:** При отключении интернета сообщения не структурируются правильно.**Причина:** `isMe` проверка зависит от `profileProvider`, который может быть недоступен offline.**Решение:**

- Кэшировать userId локально при логине
- Использовать кэшированный userId для определения `isMe` в offline режиме

---

## Ключевые файлы для изменений

### Flutter Mobile App:

- [`signalr_service.dart`](_may_messenger_mobile_app/lib/data/datasources/signalr_service.dart) - бесконечный reconnect
- [`messages_provider.dart`](_may_messenger_mobile_app/lib/presentation/providers/messages_provider.dart) - таймауты, отмена уведомлений
- [`fcm_service.dart`](_may_messenger_mobile_app/lib/core/services/fcm_service.dart) - подтверждение доставки PUSH
- [`audio_storage_service.dart`](_may_messenger_mobile_app/lib/data/services/audio_storage_service.dart) - кэширование отправленных
- [`local_datasource.dart`](_may_messenger_mobile_app/lib/data/datasources/local_datasource.dart) - recovery Hive
- [`notification_service.dart`](_may_messenger_mobile_app/lib/core/services/notification_service.dart) - иконка уведомления
- `android/app/src/main/res/` - notification icon assets

### Backend:

- [`ChatHub.cs`](_may_messenger_backend/src/MayMessenger.API/Hubs/ChatHub.cs) - delivery при PUSH
- Добавить endpoint для PUSH delivery confirmation

---

## Порядок реализации

1. **SignalR reconnect** - критично для работы
2. **HIVE recovery** - критично для offline режима
3. **ACK timeout** - устраняет зависший индикатор
4. **PUSH delivery + отмена** - улучшает UX уведомлений