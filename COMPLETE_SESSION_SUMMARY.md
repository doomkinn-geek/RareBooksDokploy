# üéâ –ü–æ–ª–Ω–∞—è —Å–≤–æ–¥–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π RareBooksService

## üìä –ò—Ç–æ–≥–∏ —Å–µ—Å—Å–∏–∏:
**2 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω—ã:**

### 1. ‚úÖ Setup API - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã
### 2. ‚úÖ Telegram Bot - –ö–æ–º–∞–Ω–¥–∞ /lots

---

## üöÄ –ü—Ä–æ–±–ª–µ–º–∞ 1: Setup API –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

### üö® –ò—Å—Ö–æ–¥–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:
- **–û—à–∏–±–∫–∞ 405 Not Allowed** –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É
- POST –∑–∞–ø—Ä–æ—Å—ã –∫ `/api/setup/initialize` –≤–æ–∑–≤—Ä–∞—â–∞–ª–∏ HTML –≤–º–µ—Å—Ç–æ JSON
- nginx –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–ª —Å—Ç–∞—Ç—É—Å "unhealthy"
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±—ã–ª–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞

### ‚úÖ –†–µ—à–µ–Ω–∏–µ:
–°–æ–∑–¥–∞–Ω–∞ **—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã Setup API.

#### üîß –ö–ª—é—á–µ–≤—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

**nginx_prod.conf:**
```nginx
# HTTP —Å–µ—Ä–≤–µ—Ä - Setup API –¥–æ—Å—Ç—É–ø–µ–Ω –±–µ–∑ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞
location ~ ^/api/(setup|test|setupcheck)/ {
    proxy_method $request_method;  # ‚Üê –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û –¥–ª—è POST
    client_max_body_size 10M;
    # ... –ø–æ–ª–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
}
# –û—Å—Ç–∞–ª—å–Ω–æ–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç—Å—è –Ω–∞ HTTPS
location / {
    return 301 https://$host$request_uri;
}
```

**docker-compose.yml:**
- –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π healthcheck —á–µ—Ä–µ–∑ Setup API
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `docker compose` (–Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç)
- –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

#### üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç:
- ‚úÖ **Setup API –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –¥–æ—Å—Ç—É–ø–µ–Ω** —á–µ—Ä–µ–∑ HTTP –∏ HTTPS
- ‚úÖ **nginx –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä healthy**
- ‚úÖ **POST –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç**
- ‚úÖ **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –±–µ–∑ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π**

#### üìÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- `apply-universal-config.sh` - –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- `UNIVERSAL_SETUP_GUIDE.md` - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `FINAL_SETUP_SOLUTION.md` - –∏—Ç–æ–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
- –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ —Å–∫—Ä–∏–ø—Ç—ã

---

## ü§ñ –ü—Ä–æ–±–ª–µ–º–∞ 2: Telegram Bot /lots –∫–æ–º–∞–Ω–¥–∞

### üö® –ò—Å—Ö–æ–¥–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:
- **LINQ –æ—à–∏–±–∫–∏ Entity Framework** –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ `/lots`
- `tag.Contains(keyword)` –Ω–µ –ø–µ—Ä–µ–≤–æ–¥–∏–ª—Å—è –≤ SQL
- `b.City.ToLower().Contains(city)` –Ω–µ –ø–µ—Ä–µ–≤–æ–¥–∏–ª—Å—è –≤ SQL
- –ö–æ–º–∞–Ω–¥–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∞

### ‚úÖ –†–µ—à–µ–Ω–∏–µ:
–ü—Ä–∏–º–µ–Ω–µ–Ω **–≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥**: —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ SQL —Ñ–∏–ª—å—Ç—Ä—ã + –±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤ –ø–∞–º—è—Ç–∏.

#### üîß –ö–ª—é—á–µ–≤—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

**–ü—Ä–æ–±–ª–µ–º—ã —Å Entity Framework –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä–∞–º–∏:**
```csharp
// –ë—ã–ª–æ (–æ—à–∏–±–∫–∏):
b.Tags.Any(tag => tag.Contains(keyword))                    // LINQ Translation Error
EF.Property<string>(b, "Tags")                             // InvalidCastException
EF.Functions.Like(b.City.ToLower(), $"%{city}%")           // ToLower Error

// –°—Ç–∞–ª–æ (–≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥):
// 1. SQL —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è "—Ç—è–∂–µ–ª—ã—Ö" –æ–ø–µ—Ä–∞—Ü–∏–π
query = query.Where(b => b.EndDate > now);                 // –ê–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ—Ä–≥–∏
query = query.Where(b => categoryIds.Contains(b.CategoryId)); // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
query = query.Where(b => EF.Functions.ILike(b.City, $"%{city}%")); // –ì–æ—Ä–æ–¥–∞

// 2. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
var allBooks = await query.AsNoTracking().ToListAsync();

// 3. –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤ –ø–∞–º—è—Ç–∏
allBooks = allBooks.Where(book =>
{
    var matchesTags = book.Tags?.Any(tag =>
        normalizedKeywords.Any(keyword =>
            tag.ToLower().Contains(keyword))) == true;
    return matchesText || matchesTags;
}).ToList();
```

#### üí° –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è:
- **–ò–∑–±–µ–≥–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤** —Å Entity Framework –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä–∞–º–∏
- **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω** - –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤ SQL
- **–ë–µ–∑–æ–ø–∞—Å–µ–Ω** - –ø–æ–∏—Å–∫ –ø–æ —Ç–µ–≥–∞–º –≤ –ø–∞–º—è—Ç–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
- **–°—Ç–∞–±–∏–ª–µ–Ω** - –Ω–µ—Ç –æ—à–∏–±–æ–∫ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏—è —Ç–∏–ø–æ–≤

#### üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç:
- ‚úÖ **–ö–æ–º–∞–Ω–¥–∞ `/lots` —Ä–∞–±–æ—Ç–∞–µ—Ç**
- ‚úÖ **–§–∏–ª—å—Ç—Ä—ã –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º, –≥–æ—Ä–æ–¥–∞–º, —Ü–µ–Ω–∞–º**
- ‚úÖ **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã**
- ‚úÖ **–ü–∞–≥–∏–Ω–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤**

#### üìÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- `TELEGRAM_BOT_LINQ_FIXES.md` - —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `TEST_TELEGRAM_LOTS_COMMAND.md` - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

---

## üìä –û–±—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è:

### üõ†Ô∏è –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:
- `setup-diagnostics.sh` - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `docker compose`
- `debug-nginx.sh` - –≥–ª—É–±–æ–∫–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ nginx
- `fix-nginx.sh` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
- –í—Å–µ —Å–∫—Ä–∏–ø—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –Ω–æ–≤—ã–π –∏ —Å—Ç–∞—Ä—ã–π Docker Compose

### üìö –°–æ–∑–¥–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
1. **UNIVERSAL_SETUP_GUIDE.md** - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
2. **TELEGRAM_BOT_LINQ_FIXES.md** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è LINQ
3. **FINAL_SETUP_SOLUTION.md** - –∏—Ç–æ–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
4. **TEST_TELEGRAM_LOTS_COMMAND.md** - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–æ—Ç–∞
5. **FILES_TO_UPLOAD.txt** - —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞

---

## üéØ –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å:

### ‚úÖ Setup API:
- –î–æ—Å—Ç—É–ø–µ–Ω: `http://localhost/api/setup`
- –î–æ—Å—Ç—É–ø–µ–Ω: `https://rare-books.ru/api/setup`
- POST –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–∞

### ‚úÖ Telegram Bot:
- –ö–æ–º–∞–Ω–¥–∞ `/lots` —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç
- –í—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç (—Ç–µ–≥–∏, –≥–æ—Ä–æ–¥–∞, —Ü–µ–Ω—ã, –≥–æ–¥–∞)
- –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã

### ‚úÖ –°–∏—Å—Ç–µ–º–∞ –≤ —Ü–µ–ª–æ–º:
- nginx –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä healthy
- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–∞
- –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞

---

## üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–∞ production:

### 1. –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä:
```
nginx/nginx_prod.conf
docker-compose.yml
apply-universal-config.sh
setup-diagnostics.sh
```

### 2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:
```bash
chmod +x apply-universal-config.sh
./apply-universal-config.sh
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
```bash
curl http://localhost/api/test/setup-status
# –û–∂–∏–¥–∞–µ—Ç—Å—è: {"success":true,...}
```

---

## üèÜ –î–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–µ —Ü–µ–ª–∏:

1. **üéØ –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å** - –Ω–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è—Ö
2. **üöÄ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å** - –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
3. **üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - production —Ç—Ä–∞—Ñ–∏–∫ —á–µ—Ä–µ–∑ HTTPS
4. **üõ†Ô∏è –£–¥–æ–±—Å—Ç–≤–æ** - –≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
5. **üìö –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å** - –ø–æ–ª–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

**üéâ –û–±–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω—ã!**
