# Инструкция по тестированию переключения динамиков

## Что было исправлено

1. **Добавлен нативный Android код** для прямого управления AudioManager
2. **Platform Channel** для связи между Dart и Android
3. **Очистка кэшей Kotlin** для устранения ошибок компиляции

## Как протестировать

### Шаг 1: Установка

```bash
# Установить debug APK
flutter install
```

Или:
```bash
# Собрать и установить вручную
flutter build apk --debug
adb install build/app/outputs/flutter-apk/app-debug.apk
```

### Шаг 2: Запуск приложения

1. Откройте мессенджер
2. Перейдите в чат с аудиосообщениями
3. Нажмите Play на любом аудиосообщении

### Шаг 3: Тестирование датчика приближения

**Вариант А: Поднесение к уху**
1. Начните воспроизведение аудиосообщения
2. Поднесите телефон к уху (как при обычном звонке)
3. **Ожидаемый результат:** Звук автоматически переключится на разговорный динамик (earpiece) - будет звучать тише и из маленького динамика
4. Отодвиньте телефон от уха
5. **Ожидаемый результат:** Звук вернется на основной динамик

**Вариант Б: Закрытие датчика рукой**
1. Начните воспроизведение
2. Закройте пальцем верхнюю часть экрана (там где датчик приближения)
3. **Ожидаемый результат:** Переключение на earpiece
4. Уберите палец
5. **Ожидаемый результат:** Возврат на speaker

### Шаг 4: Проверка логов

Подключите логи через ADB:

```bash
adb logcat | grep -E "ProximityAudioService|MainActivity"
```

**Ожидаемые логи:**

```
ProximityAudioService: Switched to earpiece
ProximityAudioService: Switched to speaker
```

## Что должно работать

✅ Автоматическое переключение при поднесении к уху
✅ Возврат на speaker при отдалении
✅ Работа во время воспроизведения
✅ Отключение мониторинга при остановке воспроизведения

## Отладка проблем

### Датчик не срабатывает

1. Проверьте работу датчика в режиме звонка:
   ```bash
   # Позвоните кому-нибудь
   # При поднесении к уху экран должен гаснуть
   ```

2. Проверьте разрешения:
   ```bash
   adb shell dumpsys package com.depesha | grep permission
   ```
   
   Должно быть: `android.permission.MODIFY_AUDIO_SETTINGS: granted=true`

### Аудио не переключается

1. Проверьте логи MainActivity:
   ```bash
   adb logcat | grep MainActivity
   ```

2. Проверьте, что AudioManager доступен:
   ```bash
   adb shell dumpsys audio
   ```

### Звук искажен

Это нормально для earpiece - он предназначен для речи, а не для музыки. Основной динамик имеет лучшее качество.

## Технические детали для отладки

### Проверка Platform Channel

Добавьте debug логи в MainActivity.kt:

```kotlin
MethodChannel(/*...*/).setMethodCallHandler { call, result ->
    Log.d("MainActivity", "Audio channel method: ${call.method}")
    // ...
}
```

### Проверка датчика приближения

```bash
adb shell dumpsys sensorservice | grep -A 10 "Proximity"
```

### Принудительный режим earpiece

Для тестирования можно временно закомментировать проверку датчика в `proximity_audio_service.dart`:

```dart
_proximitySub = ProximitySensor.events.listen((int value) {
  // Принудительно включить earpiece для теста
  _setAudioRouteEarpiece();
});
```

## Версия Android и особенности

- **Android 12+ (API 31+):** Используется `setCommunicationDevice()` - наиболее надежный способ
- **Android 5-11 (API 21-30):** Используется комбинация `MODE_IN_COMMUNICATION` + отключение speakerphone
- **Android <5:** Не поддерживается

## Следующие шаги

После успешного тестирования:
1. Соберите release APK
2. Протестируйте на разных устройствах
3. Проверьте работу с Bluetooth наушниками
4. Проверьте работу при входящих звонках



