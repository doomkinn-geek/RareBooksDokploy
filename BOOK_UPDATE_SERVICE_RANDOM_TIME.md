# Изменения в BookUpdateService - Случайное время запуска

## Описание изменений

Сервис `BookUpdateService` был изменён для запуска только в случайное время в промежутке от **0:00 до 5:00 по московскому времени (GMT+3)**.

## Изменённые файлы

- `RareBooksService.WebApi\Services\BookUpdateService.cs`

## Что было изменено

### 1. Метод `ExecuteAsync`

Изменена логика планирования следующего запуска:
- **Раньше**: Запуск каждые 24 часа от момента последнего запуска
- **Теперь**: Запуск в случайное время между 0:00 и 5:00 по московскому времени

### 2. Новый метод `CalculateNextRandomMoscowTimeRun()`

Добавлен новый приватный метод, который:
- Определяет текущее московское время (используя TimeZoneInfo "Russian Standard Time")
- Если текущее время меньше 5:00 MSK - планирует запуск на сегодня
- Если текущее время больше 5:00 MSK - планирует запуск на следующий день
- Генерирует случайное время в диапазоне от 0 до 300 минут (0:00 - 5:00)
- Конвертирует время обратно в UTC для внутреннего использования
- Имеет fallback-механизм для систем, где не доступна временная зона "Russian Standard Time" (использует ручной offset GMT+3)

### 3. Метод `ForceRunNow()`

Обновлён для использования новой логики планирования:
- После принудительного запуска следующий плановый запуск также планируется на случайное время между 0:00 и 5:00 MSK
- Логирует как UTC, так и московское время для удобства мониторинга

## Логирование

Сервис теперь логирует:
- Рассчитанное время следующего запуска в формате MSK и UTC
- Например: `"Рассчитано время следующего запуска: 24.12.2025 03:45 MSK (UTC: 24.12.2025 00:45)"`

## API

Контроллер `BookUpdateServiceController` не требует изменений:
- Endpoint `/api/BookUpdateService/status` продолжает возвращать `nextRunTimeUtc`
- Endpoint `/api/BookUpdateService/runNow` продолжает работать и теперь также использует новую логику планирования

## Важные замечания

1. **Случайность**: Каждый раз генерируется новое случайное время, что предотвращает предсказуемость запусков
2. **Московское время**: Используется временная зона "Russian Standard Time" (GMT+3)
3. **Диапазон**: Строго с 0:00:00 до 4:59:59 по московскому времени
4. **Совместимость**: Есть fallback для систем без поддержки временных зон Windows
5. **Безопасность**: Все существующие механизмы паузы, принудительного запуска и отмены работают без изменений

## Пример работы

Если сейчас **23.12.2025 20:00 MSK**:
- Следующий запуск будет запланирован на **24.12.2025 между 0:00 и 5:00 MSK**
- Например, случайно может быть выбрано: **24.12.2025 03:27 MSK**

Если сейчас **24.12.2025 02:30 MSK** (уже в окне 0:00-5:00):
- Следующий запуск будет запланирован на **25.12.2025 между 0:00 и 5:00 MSK**

## Проверка работы

Для проверки можно:
1. Запустить приложение
2. Вызвать `/api/BookUpdateService/status`
3. Проверить поле `nextRunTimeUtc` - оно должно указывать на время между 21:00 и 2:00 UTC (что соответствует 0:00-5:00 MSK)
4. Проверить логи сервиса - там будет указано московское и UTC время следующего запуска

