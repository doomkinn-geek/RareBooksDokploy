# Функционал коллекции редких книг пользователя

## Обзор

Реализован полный backend-функционал для управления личной коллекцией редких книг пользователей с автоматическим поиском аналогов, оценкой стоимости и экспортом данных.

## Реализованные компоненты

### Backend

#### 1. Модели данных (RareBooksService.Common/Models/)

- **UserCollectionBook** - книга из коллекции пользователя
  - Основная информация (название, автор, год издания, описание)
  - Личные заметки пользователя
  - Оценочная стоимость (ручная или автоматическая)
  - Ссылка на книгу-референс из основной базы

- **UserCollectionBookImage** - изображения книги
  - Поддержка множественных изображений
  - Выделение главного изображения
  - Автоматическое создание миниатюр

- **UserCollectionBookMatch** - найденные аналоги
  - Степень совпадения (match score)
  - История поиска аналогов
  - Выбор референсной книги

- **SubscriptionPlan** - расширен полем `HasCollectionAccess`
  - Контроль доступа к функционалу коллекции через подписку

#### 2. Сервисы (RareBooksService.WebApi/Services/)

- **UserCollectionService** - управление коллекцией
  - Добавление, редактирование, удаление книг
  - Загрузка и управление изображениями
  - Получение статистики коллекции

- **CollectionMatchingService** - поиск аналогов
  - Автоматический поиск по нормализованному названию
  - Учет автора и года издания
  - Алгоритм оценки релевантности (match score)
  - Автоматическое обновление цены на основе референса

- **CollectionImageService** - работа с изображениями
  - Сохранение в файловой системе (`wwwroot/collection_images/{userId}/{bookId}/`)
  - Автоматическое создание миниатюр (200x200px)
  - Валидация форматов (jpg, png, webp) и размера (до 10MB)

- **CollectionExportService** - экспорт данных
  - **PDF** - красиво оформленный отчет с изображениями и статистикой
  - **JSON+ZIP** - полные данные + архив изображений для резервного копирования

#### 3. API (RareBooksService.WebApi/Controllers/UserCollectionController.cs)

Все эндпоинты защищены атрибутом `[RequiresCollectionAccess]`.

**Основные эндпоинты:**

```
GET    /api/usercollection                           - Список книг коллекции
GET    /api/usercollection/statistics                - Статистика коллекции
GET    /api/usercollection/{id}                      - Детали книги
POST   /api/usercollection                           - Добавить книгу
PUT    /api/usercollection/{id}                      - Обновить книгу
DELETE /api/usercollection/{id}                      - Удалить книгу

POST   /api/usercollection/{id}/images               - Загрузить изображение
DELETE /api/usercollection/{id}/images/{imageId}     - Удалить изображение
PUT    /api/usercollection/{id}/images/{imageId}/setmain - Установить главное изображение
GET    /api/usercollection/{bookId}/images/{fileName} - Получить изображение

GET    /api/usercollection/{id}/matches              - Найти аналоги
POST   /api/usercollection/{id}/reference            - Выбрать референс

GET    /api/usercollection/export/pdf                - Экспорт в PDF
GET    /api/usercollection/export/json               - Экспорт в JSON+ZIP
```

#### 4. Миграция базы данных

Применена миграция `AddUserCollectionFeature`:
- Таблица `UserCollectionBooks`
- Таблица `UserCollectionBookImages`
- Таблица `UserCollectionBookMatches`
- Добавлено поле `HasCollectionAccess` в `SubscriptionPlans`

### Frontend (частично реализовано)

#### Админ-панель

- **SubPlans.jsx** - обновлен для управления опцией `HasCollectionAccess`
  - Чекбокс "Доступ к коллекции" в форме создания/редактирования плана
  - Отображение статуса доступа к коллекции в таблице планов (desktop и mobile view)

## Алгоритм автоматического поиска аналогов

1. **Нормализация текста**
   - Использует существующую логику стемминга (PreprocessText)
   - Поддержка русского, английского, французского, немецкого, итальянского, финского языков
   - Автоматическое определение языка

2. **Поиск книг**
   - Поиск по нормализованному названию (логика AND - все слова должны присутствовать)
   - Дополнительная фильтрация по автору (если указан)
   - Фильтрация по году издания ±5 лет (если указан)

3. **Расчет score**
   - Совпадение по названию: вес 60%
   - Совпадение по автору: вес 20%
   - Совпадение по году: вес 20%
   - Порог минимального совпадения: 0.3

4. **Результаты**
   - Топ-10 наиболее релевантных книг
   - Автоматическое создание записей UserCollectionBookMatch

## Автоматическая оценка стоимости

При выборе референсной книги:
1. Получается самый свежий лот референсной книги (по EndDate)
2. Берется FinalPrice (итоговая цена продажи)
3. Устанавливается как EstimatedPrice для книги из коллекции
4. Флаг IsManuallyPriced = false

Пользователь может:
- Вручную установить/изменить цену (IsManuallyPriced = true)
- Выбрать другую референсную книгу из найденных аналогов

## Экспорт данных

### PDF экспорт
- Титульная страница с названием коллекции
- Сводная статистика (количество книг, общая оценка)
- Таблица книг с изображениями:
  - Миниатюра книги
  - Название, автор, год издания
  - Описание и состояние
  - Оценочная стоимость (с пометкой ручная/автоматическая)
  - ID референсного лота
- Использует шрифт Arial Bold (ARIALBD.TTF) для поддержки кириллицы

### JSON+ZIP экспорт
Структура архива:
```
collection_{date}.zip
├── collection_data.json   # Полные данные в JSON
└── images/                # Папка с изображениями
    ├── {bookId}_{fileName}.jpg
    └── ...
```

Формат JSON:
```json
{
  "exportDate": "2025-11-18 12:00:00",
  "totalBooks": 10,
  "totalValue": 50000.00,
  "books": [
    {
      "id": 1,
      "title": "...",
      "author": "...",
      "yearPublished": 1920,
      "description": "...",
      "notes": "...",
      "estimatedPrice": 5000.00,
      "isManuallyPriced": false,
      "addedDate": "2025-11-01T10:00:00",
      "updatedDate": "2025-11-15T14:30:00",
      "images": [
        {
          "fileName": "abc-123.jpg",
          "isMainImage": true,
          "uploadedDate": "2025-11-01T10:05:00"
        }
      ],
      "referenceBook": {
        "id": 12345,
        "title": "...",
        "price": 5200.00,
        "url": "https://yoursite.com/books/12345"
      }
    }
  ]
}
```

## Требуемые компоненты Frontend (не реализованы)

Для полного функционирования необходимо создать следующие React компоненты:

### 1. UserCollection.jsx
Главная страница коллекции:
- Grid с карточками книг (показывать главное изображение, название, автор, оценку)
- Поиск и фильтрация по названию/автору
- Сортировка (по дате добавления, названию, оценке)
- Кнопка "Добавить книгу"
- Панель статистики (общее количество, суммарная оценка)
- Кнопки экспорта (PDF, JSON)

### 2. AddCollectionBook.jsx
Форма добавления книги:
- Поля: название* (обязательно), автор, год издания, описание, заметки
- Drag-and-drop зона для загрузки изображений
- Preview загруженных изображений
- После сохранения - автоматический переход к деталям книги

### 3. CollectionBookDetail.jsx
Детальная страница книги:
- Карусель изображений с увеличением
- Информация о книге (все поля)
- Кнопка "Редактировать"
- Кнопка "Удалить"
- Блок "Найденные аналоги" (см. CollectionBookMatches)
- Текущая оценка стоимости с индикатором (ручная/автоматическая)
- Кнопка "Установить цену вручную" (модальное окно с полем ввода)
- Кнопка "Найти новые аналоги"

### 4. CollectionBookMatches.jsx
Компонент списка аналогов (встроен в CollectionBookDetail):
- Grid с карточками найденных книг
- Для каждого аналога:
  - Миниатюра
  - Название книги из базы
  - Дата продажи и итоговая цена
  - Match score (процент совпадения) с цветовым индикатором
  - Кнопка "Использовать для оценки" (если не выбран)
  - Значок "Выбран" (если это текущий референс)
  - Ссылка "Посмотреть детали" (переход на страницу книги из основной базы)

### 5. CollectionImageUploader.jsx
Компонент загрузки изображений (используется в Add и Edit):
- Drag-and-drop зона
- Выбор файлов через input
- Preview с возможностью удаления
- Установка главного изображения (radio buttons)
- Прогресс загрузки
- Валидация размера и формата

### 6. EditCollectionBook.jsx
Форма редактирования (похожа на Add, но с предзаполненными данными):
- Все поля из AddCollectionBook
- Текущие изображения с возможностью удаления
- Загрузка новых изображений

### 7. Обновление навигации
В `App.jsx` добавить:
- Маршруты для новых компонентов
- Проверку доступа (HasCollectionAccess в подписке)

В главном меню добавить пункт "Моя коллекция" (показывать только если есть доступ).

### 8. Обновление SubscriptionPage.jsx
Добавить информацию о функционале коллекции:
- Иконка и описание функции
- Пометка о доступности в каждом тарифном плане

## Использованные технологии

### Backend
- ASP.NET Core 8.0
- Entity Framework Core
- iText7 (PDF generation)
- SixLabors.ImageSharp (image processing)
- Iveonik.Stemmers (text normalization)
- LanguageDetection (language detection)

### Frontend (требуется)
- React 18
- Material-UI (MUI)
- Axios (HTTP client)
- React Router (routing)

## Конфигурация

### Настройки изображений
В `CollectionImageService.cs`:
```csharp
private const int MaxFileSizeMB = 10;          // Максимальный размер файла
private const int ThumbnailSize = 200;          // Размер миниатюры
private readonly string[] AllowedExtensions = { ".jpg", ".jpeg", ".png", ".webp" };
```

### Путь хранения изображений
```
{WebRootPath}/collection_images/{UserId}/{BookId}/{FileName}
{WebRootPath}/collection_images/{UserId}/{BookId}/thumb_{FileName}
```

### Алгоритм поиска
В `CollectionMatchingService.cs`:
```csharp
private const int MaxResults = 10;             // Максимум аналогов
private const double MinMatchScore = 0.3;       // Минимальный порог совпадения
```

## Безопасность

1. **Аутентификация** - все эндпоинты требуют авторизации (`[Authorize]`)
2. **Проверка подписки** - атрибут `[RequiresCollectionAccess]` проверяет:
   - Наличие активной подписки
   - Флаг `HasCollectionAccess` в плане подписки
3. **Изоляция данных** - каждый пользователь видит только свою коллекцию
4. **Валидация файлов** - проверка формата, размера и содержимого изображений

## Тестирование

Для тестирования функционала:

1. Создать тарифный план с `HasCollectionAccess = true` через админ-панель
2. Оформить подписку на этот план
3. Использовать Postman/Swagger для тестирования API:
   ```
   POST /api/usercollection
   Body: {
     "title": "Редкая книга",
     "author": "Автор",
     "yearPublished": 1920,
     "description": "Отличное состояние"
   }
   ```
4. Загрузить изображение:
   ```
   POST /api/usercollection/{id}/images
   Body: multipart/form-data с file
   ```
5. Найти аналоги:
   ```
   GET /api/usercollection/{id}/matches
   ```
6. Экспортировать:
   ```
   GET /api/usercollection/export/pdf
   GET /api/usercollection/export/json
   ```

## Возможные улучшения

1. **ML для поиска аналогов** - использование векторных представлений для более точного поиска
2. **OCR для изображений** - автоматическое распознавание текста с обложки
3. **Интеграция с внешними каталогами** - поиск в библиотечных базах данных
4. **Социальные функции** - возможность делиться коллекцией, комментировать
5. **Мобильное приложение** - для удобной фотосъемки и добавления книг на ходу
6. **Blockchain** - для подтверждения подлинности и истории владения
7. **Страхование** - интеграция с услугами страхования коллекций

## Лицензии и соответствие

- iText7 используется с лицензией AGPL v3 (для коммерческого использования требуется лицензия)
- Все изображения пользователей хранятся локально и не передаются третьим лицам
- GDPR-compliant: данные можно экспортировать и удалить по запросу

## Поддержка

Для вопросов и сообщений об ошибках:
- GitHub Issues
- Email: support@rarebooks.com (примерный адрес)

